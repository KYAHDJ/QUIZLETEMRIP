<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>PDF Quiz Maker - Local Storage</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
    :root{
        --primary-color:#4361ee;
        --secondary-color:#3a0ca3;
        --success-color:#4cc9f0;
        --danger-color:#f72585;
        --warning-color:#fca311;
        --dark-text:#2b2d42;
        --light-text:#6c757d;
        --light-bg:#f6f7fb;
        --card:#ffffff;
    }
    *{box-sizing:border-box}
    body{
        margin:0;
        font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
        background:linear-gradient(180deg,#f2f4ff 0%,#f6f7fb 100%);
        color:var(--dark-text);
        min-height:100vh;
    }

    /* Top App Bar */
    .appbar{
        position:sticky;top:0;z-index:1000;
        background:#fff;
        display:flex;gap:16px;align-items:center;justify-content:space-between;
        padding:14px 18px;border-bottom:1px solid #eef0f4;
    }
    .brand{display:flex;gap:10px;align-items:center}
    .brand .logo{
        width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));
        display:grid;place-items:center;color:#fff;font-weight:800;
        box-shadow:0 8px 20px rgba(67,97,238,.25);
    }
    .brand .title{font-weight:800;letter-spacing:.2px}
    .tabs{
        display:flex;gap:8px;align-items:center;flex-wrap:wrap
    }
    .tab{
        border:none;background:#f1f3ff;color:var(--primary-color);
        padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer
    }
    .tab.active{background:var(--primary-color);color:#fff}
    .right-actions{display:flex;gap:10px;align-items:center}
    .pill{
        background:#fff;border:1px solid #e9ecf3;border-radius:999px;padding:8px 12px;
        display:flex;gap:8px;align-items:center;font-weight:700
    }
    .pill .dot{width:10px;height:10px;border-radius:50%;background:var(--success-color)}
    .pill .coins{color:#f39c12}
    .pill .score{color:var(--primary-color)}

    /* Layout */
    .wrapper{display:flex;gap:20px;max-width:1200px;margin:20px auto;padding:0 16px}
    .sidebar{
        width:280px;flex-shrink:0;background:#fff;border-radius:18px;padding:18px;
        box-shadow:0 10px 30px rgba(0,0,0,.06);height:fit-content;position:sticky;top:80px
    }
    .sidebar h3{margin:0 0 10px 0}
    .question-grid{
        display:grid;grid-template-columns:repeat(5,1fr);gap:8px
    }
    .qbtn{
        border:none;border-radius:10px;background:#f3f5ff;color:var(--secondary-color);
        padding:10px;font-weight:800;cursor:pointer
    }
    .qbtn.active{outline:2px solid var(--primary-color)}
    .qbtn.correct{background:#e7fbff}
    .qbtn.wrong{background:#ffe7f1}

    .shop-section{
        margin-top:14px;border-top:1px dashed #e9ecf3;padding-top:14px
    }
    .nav-btn{
        width:100%;border:none;border-radius:12px;padding:12px 14px;font-weight:800;
        background:var(--primary-color);color:#fff;cursor:pointer
    }

    /* Main */
    .main{flex:1;display:flex;flex-direction:column;gap:16px}
    .stats-bar{
        display:flex;gap:14px;flex-wrap:wrap
    }
    .stat{
        flex:1;min-width:120px;background:#fff;border-radius:16px;padding:14px;text-align:center;
        box-shadow:0 10px 20px rgba(0,0,0,.05)
    }
    .stat .val{font-size:1.6rem;font-weight:800;color:var(--primary-color);line-height:1}
    .stat .lab{font-size:.8rem;color:var(--light-text)}

    .card{
        background:#fff;border-radius:20px;padding:22px;box-shadow:0 12px 28px rgba(0,0,0,.07);
        margin-bottom:20px;
    }

    /* Upload Section */
    .upload-area{
        border:3px dashed #dbeafe;
        border-radius:20px;
        padding:40px 20px;
        text-align:center;
        background:#f8faff;
        cursor:pointer;
        transition:all 0.3s;
        margin-bottom:20px;
    }
    .upload-area:hover{
        border-color:var(--primary-color);
        background:#eef2ff;
    }
    .upload-area.drag-over{
        border-color:var(--success-color);
        background:#e6f7ff;
    }
    .upload-icon{
        font-size:48px;
        color:var(--primary-color);
        margin-bottom:15px;
    }
    .upload-btn{
        background:var(--primary-color);
        color:white;
        border:none;
        padding:12px 24px;
        border-radius:12px;
        font-weight:700;
        cursor:pointer;
        display:inline-flex;
        align-items:center;
        gap:8px;
        margin-top:10px;
    }
    .upload-btn:hover{
        background:var(--secondary-color);
    }
    .file-info{
        margin-top:15px;
        padding:12px;
        background:#f0f4ff;
        border-radius:10px;
        display:none;
    }
    
    /* Saved Quizzes */
    .saved-quizzes{
        display:none;
    }
    .quiz-list{
        display:grid;
        grid-template-columns:repeat(auto-fill, minmax(300px, 1fr));
        gap:15px;
        margin-top:20px;
    }
    .quiz-card{
        background:white;
        border-radius:12px;
        padding:20px;
        border:2px solid #e2e8f0;
        transition:all 0.3s;
        cursor:pointer;
        position:relative;
    }
    .quiz-card:hover{
        transform:translateY(-5px);
        border-color:var(--primary-color);
        box-shadow:0 10px 25px rgba(67,97,238,.15);
    }
    .quiz-card h4{
        margin:0 0 10px 0;
        color:var(--dark-text);
    }
    .quiz-meta{
        display:flex;
        justify-content:space-between;
        color:var(--light-text);
        font-size:0.9em;
        margin-bottom:15px;
    }
    .quiz-actions{
        display:flex;
        gap:10px;
        margin-top:15px;
    }
    .quiz-actions button{
        flex:1;
        padding:8px;
        border-radius:8px;
        border:none;
        cursor:pointer;
        font-weight:600;
    }
    .delete-btn{
        background:#fee;
        color:#e53e3e;
    }
    .delete-btn:hover{
        background:#fed7d7;
    }
    .load-btn{
        background:#e6fffa;
        color:#38a169;
    }
    .load-btn:hover{
        background:#c6f6d5;
    }
    
    /* Progress Bar */
    .progress-container{
        width:100%;
        background:#e2e8f0;
        border-radius:10px;
        margin:20px 0;
        display:none;
    }
    .progress-bar{
        height:10px;
        background:var(--primary-color);
        border-radius:10px;
        width:0%;
        transition:width 0.3s;
    }
    
    /* Toast Notifications */
    .toast{
        position:fixed;
        top:20px;
        right:20px;
        background:white;
        border-radius:12px;
        padding:16px 20px;
        box-shadow:0 10px 30px rgba(0,0,0,.15);
        border-left:4px solid var(--primary-color);
        z-index:4000;
        max-width:400px;
        display:none;
        animation:slideIn 0.3s ease-out;
    }
    @keyframes slideIn{
        from{transform:translateX(100%);opacity:0;}
        to{transform:translateX(0);opacity:1;}
    }
    .toast.success{border-left-color:var(--success-color);}
    .toast.error{border-left-color:var(--danger-color);}
    .toast.warning{border-left-color:var(--warning-color);}
    
    /* Loading */
    .loader{
        display:none;
        text-align:center;
        padding:30px;
    }
    .spinner{
        width:40px;
        height:40px;
        border:4px solid #e2e8f0;
        border-top:4px solid var(--primary-color);
        border-radius:50%;
        animation:spin 1s linear infinite;
        margin:0 auto 15px;
    }
    @keyframes spin{
        0%{transform:rotate(0deg);}
        100%{transform:rotate(360deg);}
    }
    
    /* Study Mode */
    .toc{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .toc button{border:none;background:#f7f8fe;color:#4a4e69;border-radius:12px;padding:8px 12px;cursor:pointer;font-weight:700}
    .chapter{display:none}
    .chapter.active{display:block}
    .chapter h2{margin-top:0}
    .note{background:#f8f9fd;border-left:4px solid var(--primary-color);padding:10px;border-radius:8px}

    /* Quiz */
    .question-card{position:relative}
    .question-header{
        display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;padding-bottom:8px;border-bottom:2px solid #f0f1f7
    }
    .question-title{font-weight:800;color:var(--secondary-color)}
    .question-text{font-size:1.25rem;font-weight:700;margin:16px 0 12px}
    .options{display:grid;grid-template-columns:1fr;gap:10px}
    .option{
        display:flex;gap:12px;align-items:center;border:2px solid #edf0f7;background:#f7f8fe;border-radius:14px;padding:14px;
        cursor:pointer;transition:.2s
    }
    .option:hover{transform:translateY(-2px);border-color:var(--primary-color)}
    .option.correct{border-color:#34c6eb;background:#eafeff}
    .option.incorrect{border-color:#ff5ca8;background:#fff1f7}
    .option.faded{opacity:.35;pointer-events:none}
    .letter{
        width:34px;height:34px;border-radius:10px;background:#fff;display:grid;place-items:center;font-weight:800;border:1px solid #e9ecf3
    }
    .hint{margin-top:8px;font-size:.95rem;color:#555}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .btn{
        border:none;border-radius:12px;padding:12px 14px;font-weight:800;cursor:pointer
    }
    .btn-primary{background:var(--primary-color);color:#fff}
    .btn-secondary{background:#eef1ff;color:var(--primary-color)}
    .btn-ghost{background:#fff;border:2px solid #edf0f7;color:#495057}
    .submit-btn{margin-left:auto}

    /* Power-ups */
    .powerups{
        display:flex;gap:10px;flex-wrap:wrap;align-items:center
    }
    .powerup{
        display:flex;flex-direction:column;align-items:center;gap:6px;background:#fff;border:1px solid #eef0f7;border-radius:14px;padding:10px 12px;width:96px;
        box-shadow:0 6px 14px rgba(0,0,0,.04);cursor:pointer
    }
    .powerup .icon{font-weight:900}
    .powerup .count{font-size:.9rem;color:#666}

    /* Shop modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:2000}
    .modal.show{display:flex}
    .modal-card{background:#fff;border-radius:22px;width:min(680px,92vw);max-height:90vh;overflow:auto;padding:20px}
    .shop-items{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
    .shop-item{border:1px solid #eef0f7;border-radius:16px;padding:14px;background:#fcfcff}
    .shop-item h4{margin:6px 0}
    .shop-item button{width:100%}

    /* Results */
    .results{display:none}
    .result-item{padding:12px;border-radius:12px;background:#f8f9fb;margin:10px 0}
    .result-item.correct{border-left:4px solid #34c6eb}
    .result-item.incorrect{border-left:4px solid #ff5ca8}

    /* Timer */
    .timerbar{display:flex;gap:10px;flex-wrap:wrap}
    .timeropt{border:2px solid #edf0f7;padding:10px;border-radius:12px;background:#fff;cursor:pointer}
    .timeropt.active{border-color:var(--primary-color)}

    /* Confetti */
    .confetti-container{position:fixed;inset:0;pointer-events:none;z-index:3000}
    .confetti{position:absolute;width:10px;height:10px;opacity:.8;animation:fall 3s ease-out forwards}
    @keyframes fall{
        to{transform:translateY(110vh) rotate(720deg);opacity:0}
    }

    /* Storage Info */
    .storage-info{
        background:#f8f9fa;
        border-radius:10px;
        padding:15px;
        margin-top:15px;
        border-left:4px solid var(--success-color);
    }
    .storage-info h4{
        margin-top:0;
        color:var(--secondary-color);
    }

    /* Responsive */
    @media (max-width:992px){
        .wrapper{flex-direction:column}
        .sidebar{position:relative;top:auto;width:100%}
        .question-grid{grid-template-columns:repeat(6,1fr)}
        .shop-items{grid-template-columns:1fr}
        .quiz-list{grid-template-columns:1fr;}
        .toast{
            left:20px;
            right:20px;
            max-width:none;
        }
    }
</style>
</head>
<body>

<header class="appbar">
    <div class="brand">
        <div class="logo">PQ</div>
        <div>
            <div class="title">PDF QUIZ MAKER</div>
            <small style="color:#6b7280">Upload → Auto-Generate → Save Locally</small>
        </div>
    </div>
    <div class="tabs">
        <button class="tab active" id="tabUpload"><i class="fa-solid fa-upload"></i> Upload PDF</button>
        <button class="tab" id="tabSaved"><i class="fa-solid fa-bookmark"></i> My Quizzes</button>
        <button class="tab" id="tabStudy"><i class="fa-solid fa-book-open"></i> Study</button>
        <button class="tab" id="tabQuiz"><i class="fa-solid fa-gamepad"></i> Quiz</button>
        <button class="tab" id="tabResults"><i class="fa-solid fa-chart-line"></i> Results</button>
    </div>
    <div class="right-actions">
        <div class="pill"><span class="dot"></span> <span id="statusText">Ready</span></div>
        <div class="pill"><i class="fa-solid fa-coins coins"></i> <span id="coinsTop">100</span></div>
        <div class="pill"><i class="fa-solid fa-star score"></i> <span id="scoreTop">0</span></div>
        <button class="tab" id="openShop"><i class="fa-solid fa-store"></i> Shop</button>
    </div>
</header>

<!-- Toast Notification -->
<div class="toast" id="toast">
    <div style="display:flex;justify-content:space-between;align-items:start;">
        <div>
            <strong id="toastTitle"></strong>
            <p id="toastMessage" style="margin:5px 0 0;color:var(--light-text);"></p>
        </div>
        <button style="background:none;border:none;cursor:pointer;color:#999;" onclick="hideToast()">
            <i class="fa-solid fa-xmark"></i>
        </button>
    </div>
</div>

<main class="wrapper">
    <!-- Sidebar -->
    <aside class="sidebar">
        <h3>Question Navigator</h3>
        <div class="question-grid" id="questionGrid"></div>
        
        <div class="shop-section">
            <button class="nav-btn" id="sidebarShop"><i class="fa-solid fa-cart-shopping"></i> Shop Power-ups</button>
            <button class="nav-btn" style="margin-top:10px;background:var(--success-color);" id="saveQuizBtn">
                <i class="fa-solid fa-save"></i> Save This Quiz
            </button>
            <button class="nav-btn" style="margin-top:10px;background:var(--warning-color);" id="exportAllBtn">
                <i class="fa-solid fa-download"></i> Export All Data
            </button>
        </div>
        
        <!-- Storage Info -->
        <div class="storage-info">
            <h4><i class="fa-solid fa-hard-drive"></i> Local Storage</h4>
            <p>All quizzes are saved in your browser. They'll stay here unless you clear browser data.</p>
            <button class="btn btn-ghost" style="width:100%;margin-top:10px;" id="clearStorageBtn">
                <i class="fa-solid fa-trash"></i> Clear All Quizzes
            </button>
        </div>
    </aside>

    <!-- Main content -->
    <section class="main">
        <!-- Stats -->
        <div class="stats-bar">
            <div class="stat"><div class="val" id="currentQ">—</div><div class="lab">Current</div></div>
            <div class="stat"><div class="val" id="score">0</div><div class="lab">Score</div></div>
            <div class="stat"><div class="val" id="correctCount">0</div><div class="lab">Correct</div></div>
            <div class="stat"><div class="val" id="streak">0</div><div class="lab">Streak</div></div>
            <div class="stat"><div class="val" id="coins">100</div><div class="lab">Coins</div></div>
            <div class="stat"><div class="val" id="timerVal">—</div><div class="lab">Timer</div></div>
        </div>

        <!-- Progress Bar -->
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar" id="progressBar"></div>
            <div style="text-align:center;margin-top:5px;font-size:0.9em;" id="progressText"></div>
        </div>

        <!-- Upload Mode -->
        <div class="card" id="uploadMode">
            <h2><i class="fa-solid fa-file-pdf"></i> Auto PDF Processing</h2>
            <p>Upload any PDF. We'll automatically extract ALL text and generate comprehensive quiz questions covering everything important.</p>
            
            <div class="upload-area" id="dropArea">
                <div class="upload-icon">
                    <i class="fa-solid fa-file-import"></i>
                </div>
                <h3>Drop PDF File Here</h3>
                <p>We'll automatically process and create quiz questions</p>
                <input type="file" id="pdfUpload" accept=".pdf" style="display:none">
                <button class="upload-btn" id="browseBtn">
                    <i class="fa-solid fa-folder-open"></i> Browse PDF Files
                </button>
                <div class="file-info" id="fileInfo">
                    <p><i class="fa-solid fa-file"></i> <strong>Selected:</strong> <span id="fileName"></span> (<span id="fileSize"></span>)</p>
                </div>
            </div>
            
            <div class="loader" id="pdfLoader">
                <div class="spinner"></div>
                <p id="loaderText">Initializing PDF processing...</p>
            </div>
        </div>

        <!-- Saved Quizzes -->
        <div class="card saved-quizzes" id="savedQuizzes">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <h2><i class="fa-solid fa-bookmark"></i> My Saved Quizzes</h2>
                <div style="display:flex;gap:10px;">
                    <button class="btn btn-secondary" id="refreshBtn">
                        <i class="fa-solid fa-sync"></i> Refresh
                    </button>
                    <button class="btn btn-primary" onclick="setActiveTab('upload')">
                        <i class="fa-solid fa-plus"></i> New Quiz
                    </button>
                </div>
            </div>
            <p>Quizzes saved in your browser's local storage. Click to load and continue studying.</p>
            
            <div class="quiz-list" id="quizList">
                <!-- Quizzes will appear here -->
                <div style="text-align:center;padding:40px;color:var(--light-text);">
                    <i class="fa-solid fa-inbox" style="font-size:48px;margin-bottom:15px;opacity:0.5;"></i>
                    <h3 style="margin:10px 0;color:var(--dark-text);">No Quizzes Yet</h3>
                    <p>Upload a PDF to create your first quiz!</p>
                    <button class="btn btn-primary" style="margin-top:15px;" onclick="setActiveTab('upload')">
                        <i class="fa-solid fa-upload"></i> Upload PDF
                    </button>
                </div>
            </div>
        </div>

        <!-- Study Mode -->
        <div class="card" id="studyMode" style="display:none;">
            <div class="toc" id="toc"></div>
            <div id="chapters"></div>
            <div class="note">
                <strong><i class="fa-solid fa-lightbulb"></i> Study Tip:</strong> 
                All questions are automatically generated from your PDF content. Review this material before taking the quiz.
            </div>
        </div>

        <!-- Quiz Mode -->
        <div class="card" id="quizMode" style="display:none;">
            <div class="question-card">
                <div class="question-header">
                    <div class="question-title" id="qTitle">Question</div>
                    <div class="timerbar">
                        <button class="timeropt" data-timer="none">No Timer</button>
                        <button class="timeropt" data-timer="quiz">Quiz: <span id="quizTimerLabel">300s</span></button>
                        <button class="timeropt" data-timer="question">Per Q: <span id="questionTimerLabel">30s</span></button>
                        <input type="number" id="quizTimerInput" value="300" min="30" max="3600" style="width:80px">
                        <input type="number" id="questionTimerInput" value="30" min="5" max="300" style="width:80px">
                        <button class="btn btn-secondary" id="applyTimers">Apply</button>
                    </div>
                </div>

                <div class="powerups">
                    <div class="powerup" id="pu5050"><div class="icon">50:50</div><div class="count" id="count5050">3</div></div>
                    <div class="powerup" id="puHint"><div class="icon"><i class="fa-solid fa-lightbulb"></i></div><div class="count" id="countHint">3</div></div>
                    <div class="powerup" id="puSkip"><div class="icon"><i class="fa-solid fa-forward"></i></div><div class="count" id="countSkip">2</div></div>
                </div>

                <div class="question-text" id="qText"></div>
                <div class="options" id="options"></div>
                <div class="hint" id="hint" style="display:none;"></div>

                <div class="controls">
                    <button class="btn btn-ghost" id="prevBtn"><i class="fa-solid fa-arrow-left"></i> Previous</button>
                    <button class="btn btn-ghost" id="nextBtn">Next <i class="fa-solid fa-arrow-right"></i></button>
                    <button class="btn btn-primary submit-btn" id="submitBtn"><i class="fa-solid fa-paper-plane"></i> Submit Quiz</button>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div class="card results" id="resultsView" style="display:none;">
            <h2><i class="fa-solid fa-chart-bar"></i> Quiz Results</h2>
            <div id="resultsSummary"></div>
            <div id="resultsList"></div>
            <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap;">
                <button class="btn btn-secondary" id="retryWrong">
                    <i class="fa-solid fa-redo"></i> Retry Wrong Answers
                </button>
                <button class="btn btn-primary" id="retryAll">
                    <i class="fa-solid fa-sync"></i> Retry All Questions
                </button>
                <button class="btn btn-success" id="saveResultsBtn">
                    <i class="fa-solid fa-save"></i> Save Results
                </button>
                <button class="btn btn-warning" id="exportResultsBtn">
                    <i class="fa-solid fa-download"></i> Export Results
                </button>
            </div>
        </div>
    </section>
</main>

<!-- Shop Modal -->
<div class="modal" id="shopModal">
    <div class="modal-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <h2 style="margin:0;">Power-up Store</h2>
            <button class="btn btn-ghost" id="closeShop"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <p style="margin:6px 0 0">Coins: <strong id="shopCoins">0</strong></p>
        <div class="shop-items">
            <div class="shop-item">
                <h4>50:50</h4>
                <p>Remove two wrong options.</p>
                <button class="btn btn-primary shop-item-btn" data-powerup="5050" data-price="80">Buy (80)</button>
            </div>
            <div class="shop-item">
                <h4>Hint</h4>
                <p>Show a helpful hint.</p>
                <button class="btn btn-primary shop-item-btn" data-powerup="hint" data-price="60">Buy (60)</button>
            </div>
            <div class="shop-item">
                <h4>Skip</h4>
                <p>Skip a tough question.</p>
                <button class="btn btn-primary shop-item-btn" data-powerup="skip" data-price="50">Buy (50)</button>
            </div>
        </div>
    </div>
</div>

<!-- Save Quiz Modal -->
<div class="modal" id="saveModal">
    <div class="modal-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <h2 style="margin:0;">Save Quiz</h2>
            <button class="btn btn-ghost" id="closeSave"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div style="margin:20px 0;">
            <div style="margin-bottom:20px;">
                <label style="display:block;margin-bottom:8px;font-weight:600;">
                    <i class="fa-solid fa-heading"></i> Quiz Title:
                </label>
                <input type="text" id="quizTitle" placeholder="Enter quiz title" 
                       style="width:100%;padding:12px;border-radius:8px;border:2px solid #e2e8f0;font-size:16px;">
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block;margin-bottom:8px;font-weight:600;">
                    <i class="fa-solid fa-tags"></i> Category:
                </label>
                <select id="quizCategory" style="width:100%;padding:12px;border-radius:8px;border:2px solid #e2e8f0;font-size:16px;">
                    <option value="General">General</option>
                    <option value="Education">Education</option>
                    <option value="Science">Science</option>
                    <option value="History">History</option>
                    <option value="Literature">Literature</option>
                    <option value="Technology">Technology</option>
                    <option value="Business">Business</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:25px;">
                <button class="btn btn-primary" id="saveToLocalBtn" style="flex:1;">
                    <i class="fa-solid fa-save"></i> Save to Browser
                </button>
            </div>
            
            <div class="note" style="margin-top:15px;">
                <strong><i class="fa-solid fa-info-circle"></i> Note:</strong> 
                Your quiz will be saved in your browser's local storage. You can access it later from this browser.
            </div>
        </div>
    </div>
</div>

<!-- Sounds -->
<audio id="correctSound" src="https://www.soundjay.com/buttons/sounds/button-1.mp3" preload="auto"></audio>
<audio id="incorrectSound" src="https://www.soundjay.com/buttons/sounds/button-10.mp3" preload="auto"></audio>
<audio id="clickSound" src="https://www.soundjay.com/buttons/sounds/button-3.mp3" preload="auto"></audio>
<audio id="powerupSound" src="https://www.soundjay.com/buttons/sounds/button-4.mp3" preload="auto"></audio>
<audio id="coinSound" src="https://www.soundjay.com/buttons/sounds/button-7.mp3" preload="auto"></audio>
<audio id="winSound" src="https://www.soundjay.com/misc/sounds/success-sound-2.mp3" preload="auto"></audio>

<div class="confetti-container" id="confetti"></div>

<script>
/* ===========================
   SIMPLIFIED STATE
   =========================== */
const Game = {
  // PDF State
  pdfDoc: null,
  pdfText: "",
  pdfFileName: "",
  
  // Quiz Data
  chapters: [],
  questions: [],
  currentQuestions: [],
  userAnswers: {},
  skipped: new Set(),
  currentIndex: 0,
  score: 0,
  correctCount: 0,
  streak: 0,
  coins: 100,
  awardedMilestones: new Set(),
  awardedStreaks: new Set(),
  timers: {mode:'none', quiz:300, question:30, handle:null, remaining:null},
  powerups: { '5050':3, hint:3, skip:2 },
  
  // Saved quizzes
  savedQuizzes: []
};

/* ===========================
   UTILITY FUNCTIONS
   =========================== */
function $(q){return document.querySelector(q)}
function create(el,cls,text){
    const e = document.createElement(el); 
    if(cls) e.className = cls; 
    if(text) e.textContent = text; 
    return e;
}

// Toast Notification System
function showToast(title, message, type = 'success', duration = 4000){
    const toast = $('#toast');
    $('#toastTitle').textContent = title;
    $('#toastMessage').textContent = message;
    
    toast.className = 'toast ' + type;
    toast.style.display = 'block';
    toast.style.opacity = '1';
    
    setTimeout(() => {
        if(toast.style.display === 'block'){
            toast.style.opacity = '0';
            setTimeout(() => toast.style.display = 'none', 300);
        }
    }, duration);
}

function hideToast(){
    const toast = $('#toast');
    toast.style.opacity = '0';
    setTimeout(() => toast.style.display = 'none', 300);
}

function updateProgress(percent, text){
    $('#progressContainer').style.display = 'block';
    $('#progressBar').style.width = percent + '%';
    $('#progressText').textContent = text;
}

function showLoader(show, text = 'Processing...'){
    const loader = $('#pdfLoader');
    if(loader){
        loader.style.display = show ? 'block' : 'none';
        if(text) $('#loaderText').textContent = text;
    }
}

// Sound and Confetti
function playSound(id){ 
    const a = $(id); 
    if(a){ 
        a.currentTime = 0; 
        a.play().catch(()=>{}); 
    } 
}

function confettiBurst(){
    const cont = $('#confetti');
    const colors = ['#4361ee','#3a0ca3','#4cc9f0','#f72585','#fca311','#2ec4b6'];
    for(let i=0;i<80;i++){
        const d = create('div','confetti');
        d.style.left = Math.random()*100 + '%';
        d.style.top = (Math.random()*-40) + 'px';
        d.style.background = colors[Math.floor(Math.random()*colors.length)];
        d.style.animationDelay = (Math.random()*1.2)+'s';
        d.style.transform = `rotate(${Math.random()*360}deg)`;
        cont.appendChild(d);
    }
    setTimeout(()=>cont.innerHTML='', 3500);
}

/* ===========================
   LOCAL STORAGE FUNCTIONS
   =========================== */
function loadSavedQuizzes(){
    const saved = localStorage.getItem('pdfQuizMaker_savedQuizzes');
    if(saved){
        try {
            Game.savedQuizzes = JSON.parse(saved);
            displayQuizzes();
        } catch(e){
            console.error('Error loading saved quizzes:', e);
            Game.savedQuizzes = [];
        }
    }
}

function displayQuizzes(){
    const container = $('#quizList');
    container.innerHTML = '';
    
    if(Game.savedQuizzes.length === 0){
        container.innerHTML = `
            <div style="text-align:center;padding:40px;color:var(--light-text);">
                <i class="fa-solid fa-inbox" style="font-size:48px;margin-bottom:15px;opacity:0.5;"></i>
                <h3 style="margin:10px 0;color:var(--dark-text);">No Quizzes Yet</h3>
                <p>Upload a PDF to create your first quiz!</p>
                <button class="btn btn-primary" style="margin-top:15px;" onclick="setActiveTab('upload')">
                    <i class="fa-solid fa-upload"></i> Upload PDF
                </button>
            </div>
        `;
        return;
    }
    
    Game.savedQuizzes.forEach((quiz, index) => {
        const date = new Date(quiz.timestamp || Date.now());
        const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        const card = create('div', 'quiz-card');
        card.innerHTML = `
            <h4 style="margin:0 0 10px 0;">${quiz.title || 'Untitled Quiz'}</h4>
            <div class="quiz-meta">
                <span><i class="fa-solid fa-file-pdf"></i> ${quiz.filename || 'Unknown'}</span>
                <span><i class="fa-solid fa-calendar"></i> ${dateStr}</span>
            </div>
            <div style="color:var(--light-text);font-size:0.9em;margin-bottom:10px;">
                <i class="fa-solid fa-question-circle"></i> ${quiz.question_count || quiz.questions?.length || 0} questions
                ${quiz.category ? `<span style="margin-left:10px;"><i class="fa-solid fa-tag"></i> ${quiz.category}</span>` : ''}
            </div>
            <div class="quiz-actions">
                <button class="load-btn" data-index="${index}">
                    <i class="fa-solid fa-play"></i> Load
                </button>
                <button class="delete-btn" data-index="${index}">
                    <i class="fa-solid fa-trash"></i> Delete
                </button>
            </div>
        `;
        
        container.appendChild(card);
    });
    
    // Add event listeners
    container.querySelectorAll('.load-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.closest('button').dataset.index);
            loadQuiz(index);
        });
    });
    
    container.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.closest('button').dataset.index);
            deleteQuiz(index);
        });
    });
}

function saveQuizLocally(title, category = 'General'){
    if(!title || title.trim() === ''){
        showToast('Error', 'Please enter a quiz title', 'error');
        return false;
    }
    
    const quizData = {
        id: 'quiz_' + Date.now(),
        title: title.trim(),
        category: category,
        filename: Game.pdfFileName || 'Unknown PDF',
        timestamp: Date.now(),
        questions: Game.questions,
        chapters: Game.chapters,
        pdf_text: Game.pdfText.substring(0, 5000),
        question_count: Game.questions.length
    };
    
    // Add to saved quizzes
    Game.savedQuizzes.unshift(quizData);
    
    // Keep only last 50 quizzes
    if(Game.savedQuizzes.length > 50){
        Game.savedQuizzes = Game.savedQuizzes.slice(0, 50);
    }
    
    // Save to localStorage
    localStorage.setItem('pdfQuizMaker_savedQuizzes', JSON.stringify(Game.savedQuizzes));
    
    // Update display
    displayQuizzes();
    
    // Show confirmation
    showToast('Success', `Quiz "${quizData.title}" saved locally!`, 'success');
    $('#saveModal').classList.remove('show');
    
    return quizData.id;
}

function loadQuiz(index){
    const quiz = Game.savedQuizzes[index];
    if(!quiz) return;
    
    try {
        // Load quiz data
        Game.questions = quiz.questions || [];
        Game.chapters = quiz.chapters || [];
        Game.pdfFileName = quiz.filename || '';
        
        // Start quiz
        startQuizWithQuestions();
        buildStudy();
        
        // Switch to quiz tab
        setActiveTab('quiz');
        
        // Show notification
        showToast('Loaded', `${quiz.title} loaded with ${quiz.questions.length} questions`, 'success');
        
    } catch(error){
        console.error('Error loading quiz:', error);
        showToast('Error', 'Failed to load quiz data', 'error');
    }
}

function deleteQuiz(index){
    // Show confirmation in toast
    showToast('Confirm Delete', 'Click delete again within 5 seconds to confirm', 'warning', 5000);
    
    // Change button to confirm
    const button = document.querySelector(`.delete-btn[data-index="${index}"]`);
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="fa-solid fa-check"></i> Confirm';
    button.style.background = '#e53e3e';
    button.style.color = 'white';
    
    // Store the confirmation function
    const confirmDelete = () => {
        Game.savedQuizzes.splice(index, 1);
        localStorage.setItem('pdfQuizMaker_savedQuizzes', JSON.stringify(Game.savedQuizzes));
        displayQuizzes();
        showToast('Deleted', 'Quiz removed', 'success');
    };
    
    // Replace the button with a new one that has the confirm function
    const newButton = button.cloneNode(true);
    button.parentNode.replaceChild(newButton, button);
    
    // Add confirm function to new button
    newButton.addEventListener('click', confirmDelete);
    
    // Reset after 5 seconds
    setTimeout(() => {
        if(newButton.parentNode){
            newButton.innerHTML = originalHTML;
            newButton.style.background = '';
            newButton.style.color = '';
            newButton.removeEventListener('click', confirmDelete);
        }
    }, 5000);
}

function clearAllQuizzes(){
    // Show confirmation
    showToast('Confirm Delete All', 'Click Clear All again to confirm deletion of ALL quizzes', 'error', 5000);
    
    // Change button text
    const button = $('#clearStorageBtn');
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="fa-solid fa-exclamation-triangle"></i> CONFIRM DELETE ALL';
    button.style.background = '#e53e3e';
    button.style.color = 'white';
    
    // Store the confirmation function
    const confirmClearAll = () => {
        Game.savedQuizzes = [];
        localStorage.removeItem('pdfQuizMaker_savedQuizzes');
        displayQuizzes();
        showToast('Cleared', 'All quizzes deleted', 'success');
        
        // Reset button
        button.innerHTML = originalHTML;
        button.style.background = '';
        button.style.color = '';
        button.removeEventListener('click', confirmClearAll);
    };
    
    // Replace event listener
    button.replaceWith(button.cloneNode(true));
    const newButton = $('#clearStorageBtn');
    newButton.addEventListener('click', confirmClearAll);
    
    // Reset after 5 seconds
    setTimeout(() => {
        if(newButton && newButton.parentNode){
            newButton.innerHTML = originalHTML;
            newButton.style.background = '';
            newButton.style.color = '';
            newButton.removeEventListener('click', confirmClearAll);
        }
    }, 5000);
}

function exportAllData(){
    const exportData = {
        version: '1.0',
        exportDate: new Date().toISOString(),
        quizzes: Game.savedQuizzes,
        stats: {
            totalQuizzes: Game.savedQuizzes.length,
            totalQuestions: Game.savedQuizzes.reduce((sum, q) => sum + (q.questions?.length || 0), 0)
        }
    };
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    const exportFileDefaultName = `pdf-quizzes-backup-${new Date().toISOString().split('T')[0]}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    showToast('Exported', `${Game.savedQuizzes.length} quizzes exported to JSON file`, 'success');
}

/* ===========================
   PDF PROCESSING - SIMPLIFIED
   =========================== */
async function loadPDF(file){
    if(!file || file.type !== 'application/pdf'){
        showToast('Error', 'Please select a PDF file', 'error');
        return;
    }
    
    Game.pdfFileName = file.name;
    showLoader(true, 'Processing PDF...');
    
    // Update file info
    $('#fileName').textContent = file.name;
    $('#fileSize').textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB`;
    $('#fileInfo').style.display = 'block';
    
    updateProgress(0, 'Loading PDF file...');
    
    try {
        // Load PDF
        const arrayBuffer = await file.arrayBuffer();
        const loadingTask = pdfjsLib.getDocument({data: arrayBuffer});
        Game.pdfDoc = await loadingTask.promise;
        
        updateProgress(20, 'Extracting text from PDF...');
        
        // Extract ALL text automatically
        const extractedText = await extractAllText();
        Game.pdfText = extractedText;
        
        updateProgress(50, 'Analyzing content...');
        
        // Automatically generate comprehensive questions
        await autoGenerateQuestions(extractedText);
        
        updateProgress(80, 'Creating study material...');
        
        // Create study chapters
        createStudyChaptersFromText(extractedText);
        
        updateProgress(100, 'Quiz ready!');
        
        // Auto-start the quiz after a short delay
        setTimeout(() => {
            startQuizWithQuestions();
            setActiveTab('quiz');
            showLoader(false);
            $('#progressContainer').style.display = 'none';
            
            showToast('Success', `Created ${Game.questions.length} questions from your PDF!`, 'success', 4000);
            
        }, 500);
        
    } catch(error){
        console.error('Error processing PDF:', error);
        showToast('Error', 'Failed to process PDF. Please try a different file.', 'error');
        showLoader(false);
        $('#progressContainer').style.display = 'none';
    }
}

async function extractAllText(){
    let allText = '';
    const totalPages = Math.min(Game.pdfDoc.numPages, 30); // Limit to 30 pages for speed
    
    for(let i=1; i<=totalPages; i++){
        try {
            const page = await Game.pdfDoc.getPage(i);
            const textContent = await page.getTextContent();
            const pageText = textContent.items.map(item => item.str).join(' ');
            allText += pageText + '\n\n';
            
            // Update progress
            updateProgress(20 + (i/totalPages * 30), `Extracting page ${i} of ${totalPages}...`);
            
        } catch(error){
            console.error('Error extracting page', i, error);
        }
    }
    
    return allText;
}

async function autoGenerateQuestions(text){
    // Split text into sentences and important phrases
    const sentences = splitIntoSentences(text);
    const importantTerms = extractImportantTerms(text);
    
    // Generate questions
    Game.questions = [];
    
    // 1. Definition questions for important terms
    importantTerms.forEach((term, index) => {
        if(index < 20){
            Game.questions.push(createDefinitionQuestion(term, text, index));
        }
    });
    
    updateProgress(60, 'Creating comprehension questions...');
    
    // 2. Comprehension questions from sentences
    sentences.forEach((sentence, index) => {
        if(index < 15 && sentence.length > 30 && sentence.length < 200){
            Game.questions.push(createComprehensionQuestion(sentence, text, index));
        }
    });
    
    updateProgress(70, 'Creating application questions...');
    
    // 3. Application questions
    const keyConcepts = extractKeyConcepts(text);
    keyConcepts.forEach((concept, index) => {
        if(index < 10){
            Game.questions.push(createApplicationQuestion(concept, text, index));
        }
    });
    
    // Shuffle questions
    Game.questions = Game.questions.sort(() => Math.random() - 0.5);
    
    // Ensure we have questions
    if(Game.questions.length === 0){
        // Create fallback questions from the text
        const paragraphs = text.split('\n\n').filter(p => p.length > 50);
        paragraphs.slice(0, 10).forEach((para, index) => {
            Game.questions.push(createFallbackQuestion(para, index));
        });
    }
}

// Helper functions for text processing
function splitIntoSentences(text){
    return text
        .replace(/\n/g, ' ')
        .split(/[.!?]+/)
        .map(s => s.trim())
        .filter(s => s.length > 20);
}

function extractImportantTerms(text){
    const words = text.toLowerCase().split(/\W+/);
    const wordFreq = {};
    words.forEach(word => {
        if(word.length > 4){
            wordFreq[word] = (wordFreq[word] || 0) + 1;
        }
    });
    
    return Object.entries(wordFreq)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 20)
        .map(([term]) => term.charAt(0).toUpperCase() + term.slice(1));
}

function extractKeyConcepts(text){
    const lines = text.split('\n');
    const concepts = new Set();
    
    lines.forEach(line => {
        const definitionMatch = line.match(/([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\s+(?:is|are|refers to|means|defined as)/i);
        if(definitionMatch){
            concepts.add(definitionMatch[1]);
        }
    });
    
    return Array.from(concepts).slice(0, 15);
}

function createDefinitionQuestion(term, text, index){
    const lines = text.split('\n');
    let context = '';
    for(let line of lines){
        if(line.includes(term)){
            context = line.substring(0, 150);
            break;
        }
    }
    
    return {
        q: `What is the definition of "${term}" based on the text?`,
        options: [
            `It refers to ${term.toLowerCase()} as described in the context`,
            `A similar but incorrect concept`,
            `The opposite meaning`,
            `An unrelated technical term`
        ],
        ans: 0,
        hint: `Look for sentences containing "${term}" in the study material.`,
        exp: `The term "${term}" appears in context: "${context.substring(0, 100)}..."`
    };
}

function createComprehensionQuestion(sentence, text, index){
    const keywords = sentence.split(' ').filter(w => w.length > 4).slice(0, 3);
    
    return {
        q: `Based on this: "${sentence.substring(0, 100)}..." What is the main point?`,
        options: [
            `It explains ${keywords.join(' ')}`,
            `It describes a process`,
            `It introduces a contradiction`,
            `It provides an example`
        ],
        ans: 0,
        hint: "Focus on the key terms in the sentence.",
        exp: `Complete: "${sentence.substring(0, 150)}${sentence.length > 150 ? '...' : ''}"`
    };
}

function createApplicationQuestion(concept, text, index){
    return {
        q: `How would you apply the concept of ${concept}?`,
        options: [
            `Following the described methods`,
            `Using practical examples provided`,
            `Applying the theoretical framework`,
            `All of the above`
        ],
        ans: 3,
        hint: "Look for practical applications in the text.",
        exp: `Apply "${concept}" using methods and examples from the material.`
    };
}

function createFallbackQuestion(paragraph, index){
    const sentences = paragraph.split('.');
    const mainSentence = sentences[0] || paragraph.substring(0, 100);
    
    return {
        q: `What is the main idea: "${mainSentence.substring(0, 80)}..."?`,
        options: [
            `It discusses the topic as described`,
            `It presents an alternative view`,
            `It contradicts established knowledge`,
            `It provides statistical data`
        ],
        ans: 0,
        hint: "Read the paragraph carefully.",
        exp: `The text discusses: "${mainSentence.substring(0, 120)}..."`
    };
}

function createStudyChaptersFromText(text){
    const paragraphs = text.split(/\n\s*\n/).filter(p => p.length > 80);
    
    Game.chapters = [];
    const chunkSize = Math.ceil(paragraphs.length / 3);
    
    for(let i=0; i<3 && i*chunkSize < paragraphs.length; i++){
        const start = i * chunkSize;
        const end = Math.min(start + chunkSize, paragraphs.length);
        const chapterText = paragraphs.slice(start, end).join('\n\n');
        
        Game.chapters.push({
            id: `chapter${i+1}`,
            title: `Section ${i+1}: Key Concepts`,
            content: `<h2>Section ${i+1}</h2><p>${chapterText.substring(0, 600)}${chapterText.length > 600 ? '...' : ''}</p>`
        });
    }
    
    // Rebuild study mode
    buildStudy();
}

/* ===========================
   QUIZ ENGINE FUNCTIONS
   =========================== */
function buildStudy(){
    const toc = $('#toc');
    const container = $('#chapters');
    toc.innerHTML = '';
    container.innerHTML = '';
    
    if(Game.chapters.length === 0){
        Game.chapters = [{
            id: 'intro',
            title: 'Study Material',
            content: '<h2>Study Material</h2><p>Content from your PDF will appear here after processing.</p>'
        }];
    }
    
    Game.chapters.forEach((ch,idx)=>{
        const b = create('button', '', ch.title);
        b.addEventListener('click', ()=>{
            document.querySelectorAll('.chapter').forEach(c=>c.classList.remove('active'));
            document.getElementById(`chapter-${ch.id}`).classList.add('active');
        });
        toc.appendChild(b);

        const div = create('div','chapter'+(idx===0?' active':'')); 
        div.id=`chapter-${ch.id}`;
        div.innerHTML = ch.content;
        container.appendChild(div);
    });
}

function buildNavigator(){
    const grid = $('#questionGrid'); 
    grid.innerHTML='';
    
    Game.currentQuestions.forEach((_,i)=>{
        const btn = create('button','qbtn', String(i+1));
        btn.addEventListener('click',()=>loadQuestion(i));
        grid.appendChild(btn);
    });
}

function refreshNavigatorStates(){
    const grid = $('#questionGrid');
    [...grid.children].forEach((btn,i)=>{
        btn.classList.toggle('active', i===Game.currentIndex);
        if(Game.userAnswers[i] !== undefined){
            const correct = Game.currentQuestions[i].ans === Game.userAnswers[i];
            btn.classList.toggle('correct', correct);
            btn.classList.toggle('wrong', !correct);
        }
    });
}

function setPowerupCounts(){
    $('#count5050').textContent = Game.powerups['5050'];
    $('#countHint').textContent  = Game.powerups.hint;
    $('#countSkip').textContent  = Game.powerups.skip;
}

function updateStats(){
    $('#currentQ').textContent = Game.currentIndex+1;
    $('#score').textContent = Game.score;
    $('#scoreTop').textContent = Game.score;
    $('#correctCount').textContent = Game.correctCount;
    $('#streak').textContent = Game.streak;
    $('#coins').textContent = Game.coins;
    $('#coinsTop').textContent = Game.coins;

    // Milestone rewards
    const milestone = Math.floor(Game.score / 500);
    for(let m=1;m<=milestone;m++){
        if(!Game.awardedMilestones.has(m)){
            Game.awardedMilestones.add(m);
            Game.coins += 100;
            playSound('#coinSound');
            showToast('Milestone!', `+100 coins for reaching ${m*500} points!`, 'success');
        }
    }
}

function loadQuestion(i){
    if(i < 0 || i >= Game.currentQuestions.length) return;
    
    Game.currentIndex = i;
    const q = Game.currentQuestions[i];
    
    $('#qTitle').textContent = `Question ${i+1} of ${Game.currentQuestions.length}`;
    $('#qText').textContent = q.q;
    
    const opts = $('#options'); 
    opts.innerHTML='';

    q.options.forEach((text,idx)=>{
        const opt = create('div','option');
        const letter = create('div','letter', String.fromCharCode(65+idx));
        const span = create('div','', text);
        opt.appendChild(letter); 
        opt.appendChild(span);
        opt.addEventListener('click',()=>selectAnswer(idx));
        opts.appendChild(opt);
    });

    $('#hint').style.display='none';
    if(Game.userAnswers[i] !== undefined){
        showAnswerState(Game.userAnswers[i], false);
    }
    refreshNavigatorStates();
    updateStats();
}

function selectAnswer(choice){
    const i = Game.currentIndex;
    if(Game.userAnswers[i] !== undefined) return;
    
    Game.userAnswers[i] = choice;
    const correct = Game.currentQuestions[i].ans === choice;
    
    if(correct){
        Game.correctCount++;
        Game.streak++;
        const base = 100;
        const bonus = Math.max(0, Game.streak-1) * 10;
        Game.score += base + bonus;

        if(Game.streak % 5 === 0 && !Game.awardedStreaks.has(Game.streak)){
            Game.awardedStreaks.add(Game.streak);
            Game.coins += 50;
            playSound('#coinSound');
            showToast('Streak Bonus!', `+50 coins for ${Game.streak} correct in a row!`, 'success');
        }

        Game.coins += 10;
        playSound('#correctSound');
        confettiBurst();
        showToast('Correct!', '+10 coins earned', 'success', 2000);
        
    } else {
        Game.streak = 0;
        Game.awardedStreaks.clear();
        playSound('#incorrectSound');
        showToast('Incorrect', 'Try again next time!', 'error', 2000);
    }
    
    showAnswerState(choice, true);
    updateStats();
}

function showAnswerState(chosen, animate=true){
    const q = Game.currentQuestions[Game.currentIndex];
    const opts = [...document.querySelectorAll('#options .option')];
    
    opts.forEach((o,idx)=>{
        if(idx===q.ans){ 
            o.classList.add('correct'); 
        }
        if(idx===chosen && chosen!==q.ans){ 
            o.classList.add('incorrect'); 
        }
        if(idx!==q.ans && idx!==chosen){ 
            o.classList.add('faded'); 
        }
    });
}

function nextUnansweredOrNext(){
    const total = Game.currentQuestions.length;
    for(let k=0;k<total;k++){
        if(Game.userAnswers[k]===undefined && !Game.skipped.has(k)) return k;
    }
    return Math.min(Game.currentIndex+1, total-1);
}

function finishable(){
    return Object.keys(Game.userAnswers).length + Game.skipped.size === Game.currentQuestions.length;
}

function startQuizWithQuestions(){
    Game.currentQuestions = Game.questions.map(q=>({...q}));
    Game.userAnswers = {};
    Game.skipped = new Set();
    Game.currentIndex = 0;
    Game.score = 0;
    Game.correctCount = 0;
    Game.streak = 0;
    Game.awardedMilestones.clear();
    Game.awardedStreaks.clear();
    
    buildNavigator();
    loadQuestion(0);
    setPowerupCounts();
    updateStats();
}

/* ===========================
   TIMER & POWER-UPS
   =========================== */
let intervalId = null;

function applyTimers(){
    const mode = document.querySelector('.timeropt.active')?.dataset.timer || 'none';
    Game.timers.mode = mode;
    Game.timers.quiz = Math.max(30, parseInt($('#quizTimerInput').value||300,10));
    Game.timers.question = Math.max(5, parseInt($('#questionTimerInput').value||30,10));
    
    $('#quizTimerLabel').textContent = Game.timers.quiz+'s';
    $('#questionTimerLabel').textContent = Game.timers.question+'s';

    clearInterval(intervalId);
    
    if(mode==='quiz'){ 
        startCountdown(Game.timers.quiz, 'quiz'); 
    }
    if(mode==='question'){ 
        startCountdown(Game.timers.question, 'question'); 
    }
    
    updateStats();
}

function startCountdown(sec, type){
    Game.timers.remaining = sec;
    $('#timerVal').textContent = Game.timers.remaining+'s';
    
    clearInterval(intervalId);
    intervalId = setInterval(()=>{
        Game.timers.remaining--;
        $('#timerVal').textContent = Game.timers.remaining+'s';
        
        if(Game.timers.remaining<=0){
            clearInterval(intervalId);
            
            if(type==='quiz'){ 
                submitQuiz(); 
            }
            if(type==='question'){
                if(Game.userAnswers[Game.currentIndex]===undefined){
                    Game.skipped.add(Game.currentIndex);
                    showToast('Time Up', 'Question skipped due to timeout', 'warning');
                }
                const nxt = nextUnansweredOrNext();
                if(nxt===Game.currentIndex){ 
                    submitQuiz(); 
                } else {
                    loadQuestion(nxt);
                    startCountdown(Game.timers.question,'question');
                }
            }
        }
    },1000);
}

function use5050(){
    if(Game.powerups['5050']<=0){
        showToast('Power-up', 'No 50:50 power-ups remaining', 'warning');
        return;
    }
    
    const q = Game.currentQuestions[Game.currentIndex];
    const wrongs = [0,1,2,3].filter(x=>x!==q.ans);
    const toRemove = wrongs.sort(()=>Math.random()-0.5).slice(0,2);
    const opts = [...document.querySelectorAll('#options .option')];
    
    toRemove.forEach(idx=>{ 
        opts[idx].classList.add('faded'); 
        opts[idx].style.pointerEvents='none'; 
    });
    
    Game.powerups['5050']--; 
    setPowerupCounts();
    playSound('#powerupSound');
    showToast('50:50 Used', 'Two wrong options removed', 'success', 2000);
}

function useHint(){
    if(Game.powerups.hint<=0){
        showToast('Power-up', 'No hint power-ups remaining', 'warning');
        return;
    }
    
    const q = Game.currentQuestions[Game.currentIndex];
    $('#hint').textContent = "💡 Hint: " + (q.hint || "Review the related study material.");
    $('#hint').style.display='block';
    
    Game.powerups.hint--; 
    setPowerupCounts();
    playSound('#powerupSound');
}

function useSkip(){
    if(Game.powerups.skip<=0){
        showToast('Power-up', 'No skip power-ups remaining', 'warning');
        return;
    }
    
    Game.skipped.add(Game.currentIndex);
    Game.powerups.skip--; 
    setPowerupCounts();
    playSound('#powerupSound');
    
    const nxt = nextUnansweredOrNext();
    showToast('Skipped', 'Question skipped', 'warning', 2000);
    loadQuestion(nxt);
}

/* ===========================
   SHOP SYSTEM
   =========================== */
function openShop(){
    $('#shopCoins').textContent = Game.coins;
    $('#shopModal').classList.add('show');
    updateShopButtons();
}

function closeShop(){ 
    $('#shopModal').classList.remove('show'); 
}

function updateShopButtons(){
    document.querySelectorAll('.shop-item-btn').forEach(btn=>{
        const price = parseInt(btn.dataset.price,10);
        if(Game.coins < price){ 
            btn.disabled=true; 
            btn.textContent='Need More Coins'; 
            btn.style.background = '#e2e8f0';
        } else { 
            btn.disabled=false; 
            btn.textContent = 'Buy ('+price+')'; 
            btn.style.background = '';
        }
    });
}

function buy(powerup, price){
    if(Game.coins < price){
        showToast('Shop', 'Not enough coins', 'error');
        return;
    }
    
    Game.coins -= price;
    
    if(powerup==='5050') Game.powerups['5050']++;
    if(powerup==='hint') Game.powerups.hint++;
    if(powerup==='skip') Game.powerups.skip++;
    
    setPowerupCounts();
    updateStats();
    updateShopButtons();
    $('#shopCoins').textContent = Game.coins;
    
    playSound('#coinSound');
    showToast('Purchase', `${powerup} power-up purchased`, 'success');
}

/* ===========================
   RESULTS SYSTEM
   =========================== */
function submitQuiz(){
    clearInterval(intervalId);
    
    const list = $('#resultsList'); 
    list.innerHTML='';
    
    let correct = 0;
    
    Game.currentQuestions.forEach((q,i)=>{
        const item = create('div','result-item');
        const chosen = Game.userAnswers[i];
        const isCorrect = chosen===q.ans;
        
        if(isCorrect) correct++;
        
        item.classList.add(isCorrect?'correct':'incorrect');
        item.innerHTML = `
            <div><strong>Q${i+1}:</strong> ${q.q}</div>
            <div style="margin-top:5px;"><em>Your answer:</em> ${chosen!==undefined ? q.options[chosen] : '<span style="color:#999">No answer</span>'}</div>
            <div><em>Correct answer:</em> ${q.options[q.ans]}</div>
            <div class="hint" style="margin-top:5px;">${q.exp || ''}</div>
        `;
        list.appendChild(item);
    });
    
    const percentage = ((correct/Game.currentQuestions.length)*100).toFixed(1);
    
    $('#resultsSummary').innerHTML = `
        <div style="background:#f8f9fa;padding:15px;border-radius:10px;margin-bottom:20px;">
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;">
                <div style="text-align:center;">
                    <div style="font-size:2em;font-weight:800;color:var(--primary-color);">${correct}/${Game.currentQuestions.length}</div>
                    <div style="color:var(--light-text);">Correct Answers</div>
                </div>
                <div style="text-align:center;">
                    <div style="font-size:2em;font-weight:800;color:var(--success-color);">${percentage}%</div>
                    <div style="color:var(--light-text);">Success Rate</div>
                </div>
                <div style="text-align:center;">
                    <div style="font-size:2em;font-weight:800;color:#f39c12;">${Game.score}</div>
                    <div style="color:var(--light-text);">Total Score</div>
                </div>
                <div style="text-align:center;">
                    <div style="font-size:2em;font-weight:800;color:var(--warning-color);">${Game.coins}</div>
                    <div style="color:var(--light-text);">Coins Earned</div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('resultsView').style.display='block';
    
    if(percentage >= 80){ 
        playSound('#winSound'); 
        confettiBurst();
        showToast('Excellent!', `You scored ${percentage}%!`, 'success', 5000);
    } else if(percentage >= 60){
        showToast('Good Job!', `You scored ${percentage}%`, 'success', 4000);
    }
    
    setActiveTab('results');
}

/* ===========================
   INITIALIZATION
   =========================== */
function init(){
    // Load saved quizzes
    loadSavedQuizzes();
    
    // Build initial study content
    buildStudy();
    
    // File upload setup
    const pdfUpload = $('#pdfUpload');
    const browseBtn = $('#browseBtn');
    const dropArea = $('#dropArea');
    
    browseBtn.addEventListener('click', () => pdfUpload.click());
    pdfUpload.addEventListener('change', (e) => {
        if(e.target.files[0]) loadPDF(e.target.files[0]);
    });
    
    // Drag and drop
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e){
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => dropArea.classList.add('drag-over'), false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => dropArea.classList.remove('drag-over'), false);
    });
    
    dropArea.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        const file = dt.files[0];
        if(file && file.type === 'application/pdf'){
            loadPDF(file);
        } else {
            showToast('Error', 'Please drop a PDF file', 'error');
        }
    });
    
    // Save button
    $('#saveQuizBtn').addEventListener('click', () => {
        if(Game.questions.length === 0){
            showToast('Error', 'No quiz to save. Upload a PDF first.', 'error');
            return;
        }
        $('#saveModal').classList.add('show');
        $('#quizTitle').value = Game.pdfFileName.replace('.pdf', '') || 'My Quiz';
        $('#quizTitle').focus();
    });
    
    // Save modal buttons
    $('#closeSave').addEventListener('click', () => $('#saveModal').classList.remove('show'));
    
    $('#saveToLocalBtn').addEventListener('click', () => {
        const title = $('#quizTitle').value.trim();
        const category = $('#quizCategory').value;
        
        if(!title){
            showToast('Error', 'Please enter a quiz title', 'error');
            return;
        }
        
        saveQuizLocally(title, category);
    });
    
    // Other buttons
    $('#refreshBtn').addEventListener('click', () => {
        loadSavedQuizzes();
        showToast('Refreshed', 'Quiz list updated', 'success');
    });
    
    $('#clearStorageBtn').addEventListener('click', clearAllQuizzes);
    
    $('#exportAllBtn').addEventListener('click', exportAllData);
    
    $('#saveResultsBtn').addEventListener('click', () => {
        const results = {
            score: Game.score,
            correct: Game.correctCount,
            total: Game.currentQuestions.length,
            percentage: ((Game.correctCount/Game.currentQuestions.length)*100).toFixed(1),
            date: new Date().toISOString(),
            quiz: Game.pdfFileName || 'Untitled Quiz'
        };
        
        // Save to localStorage
        const savedResults = JSON.parse(localStorage.getItem('pdfQuizMaker_results') || '[]');
        savedResults.unshift(results);
        localStorage.setItem('pdfQuizMaker_results', JSON.stringify(savedResults.slice(0, 50)));
        
        showToast('Results Saved', 'Quiz results saved to browser', 'success');
    });
    
    $('#exportResultsBtn').addEventListener('click', () => {
        const resultsData = {
            quiz: Game.pdfFileName || 'Untitled Quiz',
            score: Game.score,
            correct: Game.correctCount,
            total: Game.currentQuestions.length,
            percentage: ((Game.correctCount/Game.currentQuestions.length)*100).toFixed(1),
            date: new Date().toISOString(),
            questions: Game.currentQuestions.map((q, i) => ({
                question: q.q,
                userAnswer: Game.userAnswers[i] !== undefined ? q.options[Game.userAnswers[i]] : 'No answer',
                correctAnswer: q.options[q.ans],
                correct: Game.userAnswers[i] === q.ans
            }))
        };
        
        const dataStr = JSON.stringify(resultsData, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        const exportFileDefaultName = `quiz-results-${new Date().toISOString().split('T')[0]}.json`;
        
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
        
        showToast('Exported', 'Results exported as JSON file', 'success');
    });
    
    // Tabs
    $('#tabUpload').addEventListener('click',()=>setActiveTab('upload'));
    $('#tabSaved').addEventListener('click',()=>{
        setActiveTab('saved');
        displayQuizzes();
    });
    $('#tabStudy').addEventListener('click',()=>setActiveTab('study'));
    $('#tabQuiz').addEventListener('click',()=>{
        if(Game.questions.length === 0){
            showToast('Error', 'Upload a PDF first to generate questions', 'error');
            setActiveTab('upload');
            return;
        }
        setActiveTab('quiz');
    });
    $('#tabResults').addEventListener('click',()=>setActiveTab('results'));

    // Timer options
    document.querySelectorAll('.timeropt').forEach(b=>{
        b.addEventListener('click',()=>{
            document.querySelectorAll('.timeropt').forEach(x=>x.classList.remove('active'));
            b.classList.add('active');
        });
    });
    
    $('#applyTimers').addEventListener('click', applyTimers);

    // Navigation buttons
    $('#prevBtn').addEventListener('click', ()=>{ 
        playSound('#clickSound'); 
        if(Game.currentIndex>0) loadQuestion(Game.currentIndex-1); 
    });
    
    $('#nextBtn').addEventListener('click', ()=>{
        playSound('#clickSound');
        if(Game.currentIndex < Game.currentQuestions.length-1){
            loadQuestion(Game.currentIndex+1);
        } else if(finishable()){
            submitQuiz();
        } else {
            showToast('Quiz', 'Please answer all questions first', 'warning');
        }
    });
    
    $('#submitBtn').addEventListener('click', ()=>{ 
        if(finishable()){ 
            submitQuiz(); 
        } else {
            showToast('Quiz', 'Please answer all questions before submitting', 'warning');
        }
    });

    // Powerups
    $('#pu5050').addEventListener('click', use5050);
    $('#puHint').addEventListener('click', useHint);
    $('#puSkip').addEventListener('click', useSkip);

    // Shop
    $('#openShop').addEventListener('click', openShop);
    $('#sidebarShop').addEventListener('click', openShop);
    $('#closeShop').addEventListener('click', closeShop);
    
    document.querySelectorAll('.shop-item-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
            const type = btn.dataset.powerup;
            const price = parseInt(btn.dataset.price,10);
            buy(type, price);
        });
    });

    // Results actions
    $('#retryWrong').addEventListener('click', ()=>{
        const wrong = Game.currentQuestions.filter((q,i)=>Game.userAnswers[i]!==q.ans);
        if(wrong.length === 0){
            showToast('Retry', 'All answers are correct!', 'success');
            return;
        }
        restartQuiz(wrong);
        showToast('Retry', `Retrying ${wrong.length} incorrect questions`, 'warning');
    });
    
    $('#retryAll').addEventListener('click', ()=>{
        restartQuiz(Game.questions);
        showToast('Restart', 'Quiz restarted', 'warning');
    });

    // Set default tab
    setActiveTab('upload');
}

function restartQuiz(arr){
    Game.currentQuestions = arr.map(q=>({...q}));
    Game.userAnswers = {};
    Game.skipped = new Set();
    Game.currentIndex = 0;
    Game.score = 0; 
    Game.correctCount=0; 
    Game.streak=0;
    Game.awardedMilestones.clear();
    Game.awardedStreaks.clear();
    
    buildNavigator();
    loadQuestion(0);
    setActiveTab('quiz');
    
    $('#timerVal').textContent = '—';
    clearInterval(intervalId);
}

function setActiveTab(tab){
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    
    // Hide all content sections
    $('#uploadMode').style.display = 'none';
    $('#savedQuizzes').style.display = 'none';
    $('#studyMode').style.display = 'none';
    $('#quizMode').style.display = 'none';
    $('#resultsView').style.display = 'none';
    $('#progressContainer').style.display = 'none';
    
    if(tab==='upload'){
        $('#tabUpload').classList.add('active');
        $('#uploadMode').style.display = 'block';
    } else if(tab==='saved'){
        $('#tabSaved').classList.add('active');
        $('#savedQuizzes').style.display = 'block';
    } else if(tab==='study'){
        $('#tabStudy').classList.add('active');
        $('#studyMode').style.display = 'block';
    } else if(tab==='quiz'){
        $('#tabQuiz').classList.add('active');
        $('#quizMode').style.display = 'block';
    } else if(tab==='results'){
        $('#tabResults').classList.add('active');
        $('#resultsView').style.display = 'block';
    }
}

// Start the application
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
