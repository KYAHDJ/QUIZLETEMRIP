<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Complete Study & Quiz App</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<style>
    :root{
        --primary-color:#4361ee;
        --secondary-color:#3a0ca3;
        --success-color:#4cc9f0;
        --danger-color:#f72585;
        --warning-color:#fca311;
        --dark-text:#2b2d42;
        --light-text:#6c757d;
        --light-bg:#f6f7fb;
        --card:#ffffff;
        --part1-color:#4361ee;
        --part2-color:#8b5cf6;
    }
    *{box-sizing:border-box}
    body{
        margin:0;
        font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
        background:linear-gradient(180deg,#f2f4ff 0%,#f6f7fb 100%);
        color:var(--dark-text);
    }

    /* Top App Bar */
    .appbar{
        position:sticky;top:0;z-index:1000;
        background:#fff;
        display:flex;gap:16px;align-items:center;justify-content:space-between;
        padding:14px 18px;border-bottom:1px solid #eef0f4;
    }
    .brand{display:flex;gap:10px;align-items:center}
    .brand .logo{
        width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));
        display:grid;place-items:center;color:#fff;font-weight:800;
        box-shadow:0 8px 20px rgba(67,97,238,.25);
    }
    .brand .title{font-weight:800;letter-spacing:.2px}
    .tabs{
        display:flex;gap:8px;align-items:center;flex-wrap:wrap
    }
    .tab{
        border:none;background:#f1f3ff;color:var(--primary-color);
        padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer
    }
    .tab.active{background:var(--primary-color);color:#fff}
    .right-actions{display:flex;gap:10px;align-items:center}
    .pill{
        background:#fff;border:1px solid #e9ecf3;border-radius:999px;padding:8px 12px;
        display:flex;gap:8px;align-items:center;font-weight:700
    }
    .pill .dot{width:10px;height:10px;border-radius:50%;background:var(--success-color)}
    .pill .coins{color:#f39c12}
    .pill .score{color:var(--primary-color)}

    /* Layout */
    .wrapper{display:flex;gap:20px;max-width:1200px;margin:20px auto;padding:0 16px}
    .sidebar{
        width:300px;flex-shrink:0;background:#fff;border-radius:18px;padding:18px;
        box-shadow:0 10px 30px rgba(0,0,0,.06);height:fit-content;position:sticky;top:80px
    }
    .sidebar h3{margin:0 0 10px 0}
    .topic-filter{
        margin-bottom:16px;
    }
    .topic-btns{
        display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;
    }
    .topic-btn{
        border:none;background:#f1f3ff;color:var(--primary-color);
        padding:6px 10px;border-radius:8px;font-size:0.85rem;font-weight:600;cursor:pointer
    }
    .topic-btn.active{background:var(--primary-color);color:#fff}
    .question-grid{
        display:grid;grid-template-columns:repeat(5,1fr);gap:8px;max-height:200px;overflow-y:auto
    }
    .qbtn{
        border:none;border-radius:10px;background:#f3f5ff;color:var(--secondary-color);
        padding:10px;font-weight:800;cursor:pointer;font-size:0.9rem
    }
    .qbtn.active{outline:2px solid var(--primary-color)}
    .qbtn.correct{background:#e7fbff}
    .qbtn.wrong{background:#ffe7f1}
    .qbtn.part1{border-left:3px solid var(--part1-color)}
    .qbtn.part2{border-left:3px solid var(--part2-color)}

    .shop-section{
        margin-top:14px;border-top:1px dashed #e9ecf3;padding-top:14px
    }
    .nav-btn{
        width:100%;border:none;border-radius:12px;padding:12px 14px;font-weight:800;
        background:var(--primary-color);color:#fff;cursor:pointer
    }

    /* Main */
    .main{flex:1;display:flex;flex-direction:column;gap:16px}
    .stats-bar{
        display:flex;gap:14px;flex-wrap:wrap
    }
    .stat{
        flex:1;min-width:120px;background:#fff;border-radius:16px;padding:14px;text-align:center;
        box-shadow:0 10px 20px rgba(0,0,0,.05)
    }
    .stat .val{font-size:1.6rem;font-weight:800;color:var(--primary-color);line-height:1}
    .stat .lab{font-size:.8rem;color:var(--light-text)}

    .card{
        background:#fff;border-radius:20px;padding:22px;box-shadow:0 12px 28px rgba(0,0,0,.07)
    }

    /* Study Mode */
    .toc{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .toc button{border:none;background:#f7f8fe;color:#4a4e69;border-radius:12px;padding:8px 12px;cursor:pointer;font-weight:700}
    .toc button.part1{border-left:3px solid var(--part1-color)}
    .toc button.part2{border-left:3px solid var(--part2-color)}
    .chapter{display:none}
    .chapter.active{display:block}
    .chapter h2{margin-top:0}
    .topic-badge{
        display:inline-block;padding:4px 10px;border-radius:20px;font-size:0.75rem;font-weight:700;margin-right:8px;
    }
    .badge-part1{background:#e7f0ff;color:var(--part1-color)}
    .badge-part2{background:#f3f0ff;color:var(--part2-color)}
    .note{background:#f8f9fd;border-left:4px solid var(--primary-color);padding:10px;border-radius:8px}

    /* Quiz */
    .question-card{position:relative}
    .question-header{
        display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;padding-bottom:8px;border-bottom:2px solid #f0f1f7
    }
    .question-title{font-weight:800;color:var(--secondary-color)}
    .question-text{font-size:1.25rem;font-weight:700;margin:16px 0 12px}
    .options{display:grid;grid-template-columns:1fr;gap:10px}
    .option{
        display:flex;gap:12px;align-items:center;border:2px solid #edf0f7;background:#f7f8fe;border-radius:14px;padding:14px;
        cursor:pointer;transition:.2s
    }
    .option:hover{transform:translateY(-2px);border-color:var(--primary-color)}
    .option.correct{border-color:#34c6eb;background:#eafeff}
    .option.incorrect{border-color:#ff5ca8;background:#fff1f7}
    .option.faded{opacity:.35;pointer-events:none}
    .letter{
        width:34px;height:34px;border-radius:10px;background:#fff;display:grid;place-items:center;font-weight:800;border:1px solid #e9ecf3
    }
    .hint{margin-top:8px;font-size:.95rem;color:#555}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .btn{
        border:none;border-radius:12px;padding:12px 14px;font-weight:800;cursor:pointer
    }
    .btn-primary{background:var(--primary-color);color:#fff}
    .btn-secondary{background:#eef1ff;color:var(--primary-color)}
    .btn-ghost{background:#fff;border:2px solid #edf0f7;color:#495057}
    .submit-btn{margin-left:auto}

    /* Power-ups (always visible) */
    .powerups{
        display:flex;gap:10px;flex-wrap:wrap;align-items:center
    }
    .powerup{
        display:flex;flex-direction:column;align-items:center;gap:6px;background:#fff;border:1px solid #eef0f7;border-radius:14px;padding:10px 12px;width:96px;
        box-shadow:0 6px 14px rgba(0,0,0,.04);cursor:pointer
    }
    .powerup .icon{font-weight:900}
    .powerup .count{font-size:.9rem;color:#666}

    /* Shop modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:2000}
    .modal.show{display:flex}
    .modal-card{background:#fff;border-radius:22px;width:min(680px,92vw);max-height:90vh;overflow:auto;padding:20px}
    .shop-items{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
    .shop-item{border:1px solid #eef0f7;border-radius:16px;padding:14px;background:#fcfcff}
    .shop-item h4{margin:6px 0}
    .shop-item button{width:100%}

    /* Results */
    .results{display:none}
    .result-item{padding:12px;border-radius:12px;background:#f8f9fb;margin:10px 0}
    .result-item.correct{border-left:4px solid #34c6eb}
    .result-item.incorrect{border-left:4px solid #ff5ca8}

    /* Timer Setup */
    .timerbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .timeropt{border:2px solid #edf0f7;padding:10px;border-radius:12px;background:#fff;cursor:pointer}
    .timeropt.active{border-color:var(--primary-color)}

    /* Confetti */
    .confetti-container{position:fixed;inset:0;pointer-events:none;z-index:3000}
    .confetti{position:absolute;width:10px;height:10px;opacity:.8;animation:fall 3s ease-out forwards}
    @keyframes fall{
        to{transform:translateY(110vh) rotate(720deg);opacity:0}
    }

    /* Quiz settings */
    .quiz-settings{
        background:#f8f9fd;border-radius:12px;padding:12px;margin-bottom:16px
    }
    .quiz-settings h4{margin-top:0}
    .settings-grid{
        display:grid;grid-template-columns:repeat(auto-fill, minmax(200px, 1fr));gap:10px
    }
    .setting-item{display:flex;flex-direction:column;gap:4px}
    .setting-item select, .setting-item input{
        padding:8px;border-radius:8px;border:1px solid #e9ecf3
    }

    /* Responsive */
    @media (max-width:992px){
        .wrapper{flex-direction:column}
        .sidebar{position:relative;top:auto;width:100%}
        .question-grid{grid-template-columns:repeat(6,1fr)}
        .shop-items{grid-template-columns:1fr}
    }
</style>
</head>
<body>

<header class="appbar">
    <div class="brand">
        <div class="logo">QZ</div>
        <div>
            <div class="title">COMPLETE STUDY & QUIZ APP</div>
            <small style="color:#6b7280">Interactive Learning Platform</small>
        </div>
    </div>
    <div class="tabs">
        <button class="tab active" id="tabStudy"><i class="fa-solid fa-book-open"></i> Study</button>
        <button class="tab" id="tabQuiz"><i class="fa-solid fa-gamepad"></i> Quiz</button>
        <button class="tab" id="tabResults"><i class="fa-solid fa-chart-line"></i> Results</button>
    </div>
    <div class="right-actions">
        <div class="pill"><span class="dot"></span> <span>Ready</span></div>
        <div class="pill"><i class="fa-solid fa-coins coins"></i> <span id="coinsTop">150</span></div>
        <div class="pill"><i class="fa-solid fa-star score"></i> <span id="scoreTop">0</span></div>
        <button class="tab" id="openShop"><i class="fa-solid fa-store"></i> Store</button>
    </div>
</header>

<main class="wrapper">
    <!-- Sidebar -->
    <aside class="sidebar">
        <h3>Question Navigator</h3>
        <div class="topic-filter">
            <div style="margin-bottom:8px;font-weight:600">Filter by Topic:</div>
            <div class="topic-btns" id="topicFilter">
                <!-- Topic buttons will be inserted here -->
            </div>
            <div style="display:flex;justify-content:space-between;margin-top:8px">
                <span style="font-size:0.85rem;color:#666"><span style="color:var(--part1-color)">■</span> Part 1</span>
                <span style="font-size:0.85rem;color:#666"><span style="color:var(--part2-color)">■</span> Part 2</span>
            </div>
        </div>
        <div class="question-grid" id="questionGrid"></div>
        <div class="shop-section">
            <button class="nav-btn" id="sidebarShop"><i class="fa-solid fa-cart-shopping"></i> Shop Power-ups</button>
        </div>
    </aside>

    <!-- Main content -->
    <section class="main">

        <!-- Stats -->
        <div class="stats-bar">
            <div class="stat"><div class="val" id="currentQ">—</div><div class="lab">Current</div></div>
            <div class="stat"><div class="val" id="score">0</div><div class="lab">Score</div></div>
            <div class="stat"><div class="val" id="correctCount">0</div><div class="lab">Correct</div></div>
            <div class="stat"><div class="val" id="streak">0</div><div class="lab">Streak</div></div>
            <div class="stat"><div class="val" id="coins">150</div><div class="lab">Coins</div></div>
            <div class="stat"><div class="val" id="timerVal">—</div><div class="lab">Timer</div></div>
        </div>

        <!-- Study Mode -->
        <div class="card" id="studyMode">
            <div class="toc" id="toc"></div>
            <!-- Chapters auto-inserted below -->
            <div id="chapters"></div>
            <div class="note"><strong>Note:</strong> This comprehensive app contains study materials organized for easy learning and review. Use the topic buttons above to navigate.</div>
        </div>

        <!-- Quiz Mode -->
        <div class="card" id="quizMode" style="display:none;">
            <div class="quiz-settings">
                <h4>Quiz Settings</h4>
                <div class="settings-grid">
                    <div class="setting-item">
                        <label for="questionCount">Questions:</label>
                        <select id="questionCount">
                            <option value="10">10 Questions</option>
                            <option value="20">20 Questions</option>
                            <option value="30">30 Questions</option>
                            <option value="50">50 Questions</option>
                            <option value="100" selected>100 Questions</option>
                            <option value="all">All Questions</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label for="topicSelect">Topics:</label>
                        <select id="topicSelect">
                            <option value="all" selected>All Topics</option>
                            <option value="part1">Part 1 Only</option>
                            <option value="part2">Part 2 Only</option>
                            <option value="custom">Custom Selection</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label for="difficulty">Difficulty:</label>
                        <select id="difficulty">
                            <option value="all" selected>All Difficulties</option>
                            <option value="easy">Easy</option>
                            <option value="medium">Medium</option>
                            <option value="hard">Hard</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <button class="btn btn-primary" id="startQuiz">Start New Quiz</button>
                    </div>
                </div>
            </div>
            <div class="question-card">
                <div class="question-header">
                    <div class="question-title" id="qTitle">Question</div>
                    <div class="timerbar">
                        <button class="timeropt" data-timer="none">No Timer</button>
                        <button class="timeropt" data-timer="quiz">Quiz: <span id="quizTimerLabel">300s</span></button>
                        <button class="timeropt" data-timer="question">Per Q: <span id="questionTimerLabel">30s</span></button>
                        <input type="number" id="quizTimerInput" value="300" min="30" max="3600" style="width:80px">
                        <input type="number" id="questionTimerInput" value="30" min="5" max="300" style="width:80px">
                        <button class="btn btn-secondary" id="applyTimers">Apply</button>
                    </div>
                </div>

                <div class="powerups">
                    <div class="powerup" id="pu5050"><div class="icon">50:50</div><div class="count" id="count5050">3</div></div>
                    <div class="powerup" id="puHint"><div class="icon"><i class="fa-solid fa-lightbulb"></i></div><div class="count" id="countHint">3</div></div>
                    <div class="powerup" id="puSkip"><div class="icon"><i class="fa-solid fa-forward"></i></div><div class="count" id="countSkip">2</div></div>
                </div>

                <div class="question-text" id="qText"></div>
                <div class="options" id="options"></div>
                <div class="hint" id="hint" style="display:none;"></div>

                <div class="controls">
                    <button class="btn btn-ghost" id="prevBtn"><i class="fa-solid fa-arrow-left"></i> Previous</button>
                    <button class="btn btn-ghost" id="nextBtn">Next <i class="fa-solid fa-arrow-right"></i></button>
                    <button class="btn btn-primary submit-btn" id="submitBtn"><i class="fa-solid fa-paper-plane"></i> Submit Quiz</button>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div class="card results" id="resultsView">
            <h2>Results</h2>
            <div id="resultsSummary"></div>
            <div id="resultsList"></div>
            <div style="display:flex;gap:10px;margin-top:12px;">
                <button class="btn btn-secondary" id="retryWrong">Retry Wrong Only</button>
                <button class="btn btn-primary" id="retryAll">Retry All</button>
                <button class="btn btn-ghost" id="newQuiz">New Quiz</button>
            </div>
        </div>

    </section>
</main>

<!-- Shop Modal -->
<div class="modal" id="shopModal">
    <div class="modal-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <h2 style="margin:0;">Power-up Store</h2>
            <button class="btn btn-ghost" id="closeShop"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <p style="margin:6px 0 0">Coins: <strong id="shopCoins">0</strong></p>
        <div class="shop-items">
            <div class="shop-item">
                <h4>50:50</h4>
                <p>Remove two wrong options.</p>
                <button class="btn btn-primary shop-item-btn" data-powerup="5050" data-price="80">Buy (80)</button>
            </div>
            <div class="shop-item">
                <h4>Hint</h4>
                <p>Show a helpful hint.</p>
                <button class="btn btn-primary shop-item-btn" data-powerup="hint" data-price="60">Buy (60)</button>
            </div>
            <div class="shop-item">
                <h4>Skip</h4>
                <p>Skip a tough question.</p>
                <button class="btn btn-primary shop-item-btn" data-powerup="skip" data-price="50">Buy (50)</button>
            </div>
        </div>
    </div>
</div>

<!-- Sounds -->
<audio id="correctSound" src="https://www.soundjay.com/buttons/sounds/button-1.mp3" preload="auto"></audio>
<audio id="incorrectSound" src="https://www.soundjay.com/buttons/sounds/button-10.mp3" preload="auto"></audio>
<audio id="clickSound" src="https://www.soundjay.com/buttons/sounds/button-3.mp3" preload="auto"></audio>
<audio id="powerupSound" src="https://www.soundjay.com/buttons/sounds/button-4.mp3" preload="auto"></audio>
<audio id="coinSound" src="https://www.soundjay.com/buttons/sounds/button-7.mp3" preload="auto"></audio>
<audio id="winSound" src="https://www.soundjay.com/misc/sounds/success-sound-2.mp3" preload="auto"></audio>

<div class="confetti-container" id="confetti"></div>

<script>
// ===========================
// CONTENT LOADER
// ===========================
let studyChapters = [];
let completeQuizBank = [];

// Load content from external file
function loadContent() {
    // For GitHub Pages or local testing, you can:
    // 1. Use fetch to load a JSON file
    // 2. Include the content directly in a JavaScript file
    // 3. Use a separate .js file with the content
    
    // For now, we'll create an empty structure
    studyChapters = [];
    completeQuizBank = [];
    
    // After loading content, initialize the app
    init();
}

// Fallback content if external file fails to load
function loadFallbackContent() {
    // Minimal content to prevent errors
    studyChapters = [{
        id: 'intro',
        title: 'Introduction',
        content: '<h2>WELCOME TO THE STUDY & QUIZ APP</h2><p>Content loading from external file...</p>'
    }];
    
    completeQuizBank = [{
        topic: 1,
        part: 1,
        q: "Sample question?",
        options: ["Option A", "Option B", "Option C", "Option D"],
        ans: 0,
        hint: "Sample hint",
        exp: "Sample explanation"
    }];
}

// ===========================
// STATE
// ===========================
const Game = {
  // Elements
  els:{},
  // Data (will be populated from content)
  chapters: studyChapters,
  questions: completeQuizBank,
  currentQuestions: [],
  userAnswers: {},
  skipped: new Set(),
  currentIndex: 0,
  score: 0,
  correctCount: 0,
  streak: 0,
  coins: 150,
  awardedMilestones: new Set(),
  awardedStreaks: new Set(),
  timers: {mode:'none', quiz:300, question:30, handle:null, remaining:null},
  powerups: { '5050':3, hint:3, skip:2 },
  currentFilter: 'all',
  quizSettings: {
    questionCount: 100,
    topicSelection: 'all',
    difficulty: 'all'
  }
};

// ===========================
// UTIL & UI
// ===========================
function $(q){return document.querySelector(q)}
function create(el,cls,text){const e=document.createElement(el); if(cls) e.className=cls; if(text) e.textContent=text; return e;}
function playSound(id){ const a=$(id); if(a){ a.currentTime=0; a.play().catch(()=>{}); } }
function confettiBurst(){
  const cont = $('#confetti');
  const colors = ['#4361ee','#3a0ca3','#4cc9f0','#f72585','#fca311','#2ec4b6','#8b5cf6','#7c3aed','#10b981','#ef4444'];
  for(let i=0;i<100;i++){
    const d = create('div','confetti');
    d.style.left = Math.random()*100 + '%';
    d.style.top = (Math.random()*-40) + 'px';
    d.style.background = colors[Math.floor(Math.random()*colors.length)];
    d.style.animationDelay = (Math.random()*1.5)+'s';
    d.style.transform = `rotate(${Math.random()*360}deg)`;
    cont.appendChild(d);
  }
  setTimeout(()=>cont.innerHTML='', 3500);
}

// ===========================
// STUDY MODE BUILD
// ===========================
function buildStudy(){
  const toc = $('#toc');
  const container = $('#chapters');
  toc.innerHTML = '';
  container.innerHTML = '';
  Game.chapters.forEach((ch,idx)=>{
    const b = create('button', '', ch.title);
    b.classList.add(ch.part === 1 ? 'part1' : 'part2');
    b.addEventListener('click', ()=>{
      document.querySelectorAll('.chapter').forEach(c=>c.classList.remove('active'));
      document.getElementById(`chapter-${ch.id}`).classList.add('active');
    });
    toc.appendChild(b);

    const div = create('div','chapter'+(idx===0?' active':'')); div.id=`chapter-${ch.id}`;
    div.innerHTML = ch.content;
    container.appendChild(div);
  });
}

// ===========================
// TOPIC FILTER
// ===========================
function buildTopicFilter(){
  const filterDiv = $('#topicFilter');
  filterDiv.innerHTML = '';
  
  // Add "All Topics" button
  const allBtn = create('button', 'topic-btn active', 'All Topics');
  allBtn.dataset.topic = 'all';
  allBtn.addEventListener('click', () => {
    document.querySelectorAll('.topic-btn').forEach(b => b.classList.remove('active'));
    allBtn.classList.add('active');
    Game.currentFilter = 'all';
    refreshNavigatorStates();
  });
  filterDiv.appendChild(allBtn);
  
  // Add topic buttons for each chapter (excluding intro)
  Game.chapters.filter(ch => ch.id !== 'intro').forEach(ch => {
    const btn = create('button', 'topic-btn', `Topic ${ch.id.replace('topic', '')}: ${ch.title}`);
    btn.dataset.topic = ch.id;
    if(ch.part === 1) {
      btn.style.borderLeft = '3px solid var(--part1-color)';
    } else {
      btn.style.borderLeft = '3px solid var(--part2-color)';
    }
    btn.addEventListener('click', () => {
      document.querySelectorAll('.topic-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      Game.currentFilter = ch.id;
      refreshNavigatorStates();
      // If in study mode, navigate to that chapter
      if($('#studyMode').style.display !== 'none') {
        document.querySelectorAll('.chapter').forEach(c=>c.classList.remove('active'));
        document.getElementById(`chapter-${ch.id}`).classList.add('active');
      }
    });
    filterDiv.appendChild(btn);
  });
}

// ===========================
// QUIZ BUILD
// ===========================
function buildNavigator(){
  const grid = $('#questionGrid'); grid.innerHTML='';
  Game.currentQuestions.forEach((q,i)=>{
    const btn = create('button','qbtn', String(i+1));
    btn.classList.add(q.part === 1 ? 'part1' : 'part2');
    btn.addEventListener('click',()=>loadQuestion(i));
    grid.appendChild(btn);
  });
  refreshNavigatorStates();
}

function refreshNavigatorStates(){
  const grid = $('#questionGrid');
  [...grid.children].forEach((btn,i)=>{
    // Highlight based on filter
    const q = Game.currentQuestions[i];
    const show = Game.currentFilter === 'all' || 
                (Game.currentFilter === 'part1' && q.part === 1) ||
                (Game.currentFilter === 'part2' && q.part === 2) ||
                (Game.currentFilter === `topic${q.topic}`) ||
                (Game.currentFilter === `topic${q.topic}`);
    
    btn.style.display = show ? 'block' : 'none';
    btn.classList.toggle('active', i===Game.currentIndex && show);
    
    if(Game.userAnswers[i] !== undefined){
      const correct = Game.currentQuestions[i].ans === Game.userAnswers[i];
      btn.classList.toggle('correct', correct);
      btn.classList.toggle('wrong', !correct);
    }
  });
}

function setPowerupCounts(){
  $('#count5050').textContent = Game.powerups['5050'];
  $('#countHint').textContent  = Game.powerups.hint;
  $('#countSkip').textContent  = Game.powerups.skip;
}

function updateStats(){
  $('#currentQ').textContent = Game.currentIndex+1;
  $('#score').textContent = Game.score;
  $('#scoreTop').textContent = Game.score;
  $('#correctCount').textContent = Game.correctCount;
  $('#streak').textContent = Game.streak;
  $('#coins').textContent = Game.coins;
  $('#coinsTop').textContent = Game.coins;

  // milestone coins: +100 coins every time score crosses a 500 multiple
  const milestone = Math.floor(Game.score / 500);
  for(let m=1;m<=milestone;m++){
    if(!Game.awardedMilestones.has(m)){
      Game.awardedMilestones.add(m);
      Game.coins += 100;
      $('#coins').textContent = Game.coins;
      $('#coinsTop').textContent = Game.coins;
      playSound('#coinSound');
      confettiBurst();
    }
  }
}

function loadQuestion(i){
  Game.currentIndex = i;
  const q = Game.currentQuestions[i];
  $('#qTitle').textContent = `Question ${i+1} of ${Game.currentQuestions.length} (Topic ${q.topic})`;
  $('#qText').textContent = q.q;
  const opts = $('#options'); opts.innerHTML='';

  q._indices = [0,1,2,3];
  q.options.forEach((text,idx)=>{
    const opt = create('div','option');
    const letter = create('div','letter', String.fromCharCode(65+idx));
    const span = create('div','', text);
    opt.appendChild(letter); opt.appendChild(span);
    opt.addEventListener('click',()=>selectAnswer(idx));
    opts.appendChild(opt);
  });

  $('#hint').style.display='none';
  if(Game.userAnswers[i] !== undefined){
    showAnswerState(Game.userAnswers[i], false);
  }
  refreshNavigatorStates();
  updateStats();
}

function selectAnswer(choice){
  const i = Game.currentIndex;
  if(Game.userAnswers[i] !== undefined) return;
  Game.userAnswers[i] = choice;
  const correct = Game.currentQuestions[i].ans === choice;
  if(correct){
    Game.correctCount++;
    Game.streak++;
    const base = 100;
    const bonus = Math.max(0, Game.streak-1) * 10;
    Game.score += base + bonus;

    // Check for streak bonus
    if (Game.streak % 5 === 0 && !Game.awardedStreaks.has(Game.streak)) {
      Game.awardedStreaks.add(Game.streak);
      Game.coins += 50;
      playSound('#coinSound');
      const notification = create('div', 'streak-bonus');
      notification.textContent = `+50 coins for ${Game.streak} streak!`;
      notification.style.cssText = 'position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:var(--success-color); color:white; padding:20px; border-radius:10px; font-weight:bold; z-index:4000;';
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 2000);
    }

    Game.coins += 10;
    playSound('#correctSound');
    confettiBurst();
  } else {
    Game.streak = 0;
    Game.awardedStreaks.clear();
    playSound('#incorrectSound');
  }
  showAnswerState(choice, true);
  updateStats();
}

function showAnswerState(chosen, animate=true){
  const q = Game.currentQuestions[Game.currentIndex];
  const opts = [...document.querySelectorAll('#options .option')];
  opts.forEach((o,idx)=>{
    if(idx===q.ans){ o.classList.add('correct'); }
    if(idx===chosen && chosen!==q.ans){ o.classList.add('incorrect'); }
    if(idx!==q.ans && idx!==chosen){ o.classList.add('faded'); }
  });
}

function nextUnansweredOrNext(){
  const total = Game.currentQuestions.length;
  for(let k=0;k<total;k++){
    if(Game.userAnswers[k]===undefined && !Game.skipped.has(k)) return k;
  }
  return Math.min(Game.currentIndex+1, total-1);
}

function finishable(){
  return Object.keys(Game.userAnswers).length + Game.skipped.size === Game.currentQuestions.length;
}

// ===========================
// QUIZ SETTINGS & CREATION
// ===========================
function createNewQuiz(){
  const count = parseInt($('#questionCount').value, 10) || 100;
  const topicSel = $('#topicSelect').value;
  const difficulty = $('#difficulty').value;
  
  Game.quizSettings.questionCount = count;
  Game.quizSettings.topicSelection = topicSel;
  Game.quizSettings.difficulty = difficulty;
  
  // Filter questions based on topic selection
  let filteredQuestions = [...Game.questions];
  
  if (topicSel === 'part1') {
    filteredQuestions = filteredQuestions.filter(q => q.part === 1);
  } else if (topicSel === 'part2') {
    filteredQuestions = filteredQuestions.filter(q => q.part === 2);
  } else if (topicSel === 'custom') {
    // For custom, we could implement topic selection UI
    // For now, use all questions
  }
  
  // Shuffle questions
  filteredQuestions = filteredQuestions.sort(() => Math.random() - 0.5);
  
  // Take the requested number of questions
  const actualCount = Math.min(count, filteredQuestions.length);
  Game.currentQuestions = filteredQuestions.slice(0, actualCount);
  
  // Reset game state
  Game.userAnswers = {};
  Game.skipped = new Set();
  Game.currentIndex = 0;
  Game.score = 0;
  Game.correctCount = 0;
  Game.streak = 0;
  Game.awardedMilestones.clear();
  Game.awardedStreaks.clear();
  
  // Reset timers
  clearInterval(intervalId);
  Game.timers = {mode:'none', quiz:300, question:30, handle:null, remaining:null};
  $('#timerVal').textContent = '—';
  
  // Build UI
  buildNavigator();
  loadQuestion(0);
  setPowerupCounts();
  updateStats();
  
  // Switch to quiz tab
  setActiveTab('quiz');
  playSound('#clickSound');
}

// ===========================
// TIMERS
// ===========================
let intervalId = null;
function applyTimers(){
  const mode = document.querySelector('.timeropt.active')?.dataset.timer || 'none';
  Game.timers.mode = mode;
  Game.timers.quiz = Math.max(30, parseInt($('#quizTimerInput').value||300,10));
  Game.timers.question = Math.max(5, parseInt($('#questionTimerInput').value||30,10));
  $('#quizTimerLabel').textContent = Game.timers.quiz+'s';
  $('#questionTimerLabel').textContent = Game.timers.question+'s';

  clearInterval(intervalId);
  if(mode==='quiz'){ startCountdown(Game.timers.quiz, 'quiz'); }
  if(mode==='question'){ startCountdown(Game.timers.question, 'question'); }
  updateStats();
}

function startCountdown(sec, type){
  Game.timers.remaining = sec;
  $('#timerVal').textContent = Game.timers.remaining+'s';
  clearInterval(intervalId);
  intervalId = setInterval(()=>{
    Game.timers.remaining--;
    $('#timerVal').textContent = Game.timers.remaining+'s';
    if(Game.timers.remaining<=0){
      clearInterval(intervalId);
      if(type==='quiz'){ submitQuiz(); }
      if(type==='question'){
        if(Game.userAnswers[Game.currentIndex]===undefined){
          Game.skipped.add(Game.currentIndex);
        }
        const nxt = nextUnansweredOrNext();
        if(nxt===Game.currentIndex){ submitQuiz(); }
        else{
          loadQuestion(nxt);
          startCountdown(Game.timers.question,'question');
        }
      }
    }
  },1000);
}

// ===========================
// POWER-UPS
// ===========================
function use5050(){
  if(Game.powerups['5050']<=0) return;
  const q = Game.currentQuestions[Game.currentIndex];
  const wrongs = [0,1,2,3].filter(x=>x!==q.ans);
  const toRemove = wrongs.sort(()=>Math.random()-0.5).slice(0,2);
  const opts = [...document.querySelectorAll('#options .option')];
  toRemove.forEach(idx=>{ opts[idx].classList.add('faded'); opts[idx].style.pointerEvents='none'; });
  Game.powerups['5050']--; setPowerupCounts();
  playSound('#powerupSound');
}

function useHint(){
  if(Game.powerups.hint<=0) return;
  const q = Game.currentQuestions[Game.currentIndex];
  $('#hint').textContent = "Hint: " + (q.hint || "Think carefully about the material.");
  $('#hint').style.display='block';
  Game.powerups.hint--; setPowerupCounts();
  playSound('#powerupSound');
}

function useSkip(){
  if(Game.powerups.skip<=0) return;
  Game.skipped.add(Game.currentIndex);
  Game.powerups.skip--; setPowerupCounts();
  playSound('#powerupSound');
  const nxt = nextUnansweredOrNext();
  loadQuestion(nxt);
}

// ===========================
// SHOP
// ===========================
function openShop(){
  $('#shopCoins').textContent = Game.coins;
  $('#shopModal').classList.add('show');
  updateShopButtons();
}
function closeShop(){ $('#shopModal').classList.remove('show'); }

function updateShopButtons(){
  document.querySelectorAll('.shop-item-btn').forEach(btn=>{
    const price = parseInt(btn.dataset.price,10);
    if(Game.coins < price){ btn.disabled=true; btn.textContent='Cannot afford'; }
    else { btn.disabled=false; btn.textContent = 'Buy ('+price+')'; }
  });
}

function buy(powerup, price){
  if(Game.coins < price) return;
  Game.coins -= price;
  if(powerup==='5050') Game.powerups['5050']++;
  if(powerup==='hint') Game.powerups.hint++;
  if(powerup==='skip') Game.powerups.skip++;
  setPowerupCounts();
  updateStats();
  updateShopButtons();
  $('#shopCoins').textContent = Game.coins;
  playSound('#coinSound');
}

// ===========================
// RESULTS
// ===========================
function submitQuiz(){
  clearInterval(intervalId);
  const list = $('#resultsList'); list.innerHTML='';
  let correct = 0;
  let topicStats = {};
  
  Game.currentQuestions.forEach((q,i)=>{
    const chosen = Game.userAnswers[i];
    const isCorrect = chosen===q.ans;
    if(isCorrect) correct++;
    
    // Track topic statistics
    if(!topicStats[q.topic]) {
      topicStats[q.topic] = {total:0, correct:0};
    }
    topicStats[q.topic].total++;
    if(isCorrect) topicStats[q.topic].correct++;
    
    const item = create('div','result-item');
    item.classList.add(isCorrect?'correct':'incorrect');
    item.innerHTML = `<div><strong>Q${i+1} (Topic ${q.topic}):</strong> ${q.q}</div>
    <div><em>Your answer:</em> ${chosen!==undefined ? q.options[chosen] : '<span style="color:#999">No answer</span>'}</div>
    <div><em>Correct:</em> ${q.options[q.ans]}</div>
    <div class="hint">${q.exp || ''}</div>`;
    list.appendChild(item);
  });
  
  // Build topic breakdown
  let topicHTML = '<div style="margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 10px;"><h4>Topic Performance:</h4><div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 8px; margin-top: 8px;">';
  Object.keys(topicStats).sort((a,b) => a-b).forEach(topic => {
    const stats = topicStats[topic];
    const percentage = Math.round((stats.correct/stats.total)*100);
    topicHTML += `<div style="background: white; padding: 8px; border-radius: 6px; border-left: 4px solid ${topic <= 6 ? 'var(--part1-color)' : 'var(--part2-color)'}">
      <div style="font-weight: bold;">Topic ${topic}</div>
      <div>${stats.correct}/${stats.total} (${percentage}%)</div>
    </div>`;
  });
  topicHTML += '</div></div>';
  
  $('#resultsSummary').innerHTML = `
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0;">
      <div style="background: #e7f7ff; padding: 15px; border-radius: 10px; text-align: center;">
        <div style="font-size: 2rem; font-weight: 800; color: var(--primary-color);">${Game.score}</div>
        <div style="color: #666; font-size: 0.9rem;">Total Score</div>
      </div>
      <div style="background: #e7f7ff; padding: 15px; border-radius: 10px; text-align: center;">
        <div style="font-size: 2rem; font-weight: 800; color: var(--success-color);">${correct}/${Game.currentQuestions.length}</div>
        <div style="color: #666; font-size: 0.9rem;">Correct Answers</div>
      </div>
      <div style="background: #e7f7ff; padding: 15px; border-radius: 10px; text-align: center;">
        <div style="font-size: 2rem; font-weight: 800; color: #f39c12;">${Math.round((correct/Game.currentQuestions.length)*100)}%</div>
        <div style="color: #666; font-size: 0.9rem;">Percentage</div>
      </div>
    </div>
    ${topicHTML}
  `;
  
  document.getElementById('resultsView').style.display='block';
  if(correct === Game.currentQuestions.length){ 
    playSound('#winSound'); 
    confettiBurst();
    // Bonus for perfect score
    Game.coins += 200;
    updateStats();
    const perfect = create('div', 'perfect-score');
    perfect.textContent = 'Perfect Score! +200 coins!';
    perfect.style.cssText = 'position:fixed; top:20%; left:50%; transform:translate(-50%,-50%); background:linear-gradient(135deg, #ffd700, #ff9500); color:white; padding:25px 30px; border-radius:15px; font-weight:bold; font-size:1.2rem; z-index:4000; box-shadow:0 10px 30px rgba(255, 215, 0, 0.4);';
    document.body.appendChild(perfect);
    setTimeout(() => perfect.remove(), 3000);
  } else if(Game.score >= 500){ 
    playSound('#winSound'); 
    confettiBurst(); 
  }
  setActiveTab('results');
}

// ===========================
// INIT & EVENTS
// ===========================
function init(){
  // elements
  Game.els = {
    study: $('#studyMode'),
    quiz: $('#quizMode'),
    results: $('#resultsView'),
  };

  // Update Game with loaded content
  Game.chapters = studyChapters;
  Game.questions = completeQuizBank;

  buildStudy();
  buildTopicFilter();

  // Create initial quiz with all questions
  if (Game.questions.length > 0) {
    Game.currentQuestions = Game.questions.map(q=>({...q}));
    buildNavigator();
    loadQuestion(0);
  } else {
    // Show message if no questions loaded
    $('#qText').textContent = "No questions loaded. Please check content file.";
  }
  
  setPowerupCounts();
  updateStats();

  // Tabs
  $('#tabStudy').addEventListener('click',()=>setActiveTab('study'));
  $('#tabQuiz').addEventListener('click',()=>setActiveTab('quiz'));
  $('#tabResults').addEventListener('click',()=>setActiveTab('results'));

  // Timer options
  document.querySelectorAll('.timeropt').forEach(b=>{
    b.addEventListener('click',()=>{
      document.querySelectorAll('.timeropt').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
    });
  });
  $('#applyTimers').addEventListener('click', applyTimers);

  // Quiz creation
  $('#startQuiz').addEventListener('click', createNewQuiz);

  // Nav buttons
  $('#prevBtn').addEventListener('click', ()=>{ playSound('#clickSound'); if(Game.currentIndex>0) loadQuestion(Game.currentIndex-1); });
  $('#nextBtn').addEventListener('click', ()=>{
     playSound('#clickSound');
     if(Game.currentIndex < Game.currentQuestions.length-1) loadQuestion(Game.currentIndex+1);
     else if(finishable()) submitQuiz();
  });
  $('#submitBtn').addEventListener('click', ()=>{ if(finishable()) submitQuiz(); });

  // Powerups
  $('#pu5050').addEventListener('click', use5050);
  $('#puHint').addEventListener('click', useHint);
  $('#puSkip').addEventListener('click', useSkip);

  // Shop
  $('#openShop').addEventListener('click', openShop);
  $('#sidebarShop').addEventListener('click', openShop);
  $('#closeShop').addEventListener('click', closeShop);
  document.querySelectorAll('.shop-item-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const type = btn.dataset.powerup;
      const price = parseInt(btn.dataset.price,10);
      buy(type, price);
    });
  });

  // Results actions
  $('#retryWrong').addEventListener('click', ()=>{
    const wrong = Game.currentQuestions.filter((q,i)=>Game.userAnswers[i]!==q.ans);
    restartQuiz(wrong);
  });
  $('#retryAll').addEventListener('click', ()=>{
    restartQuiz(Game.currentQuestions);
  });
  $('#newQuiz').addEventListener('click', () => {
    createNewQuiz();
  });

  // default tab
  setActiveTab('study');
}

function restartQuiz(arr){
  Game.currentQuestions = arr.map(q=>({...q}));
  Game.userAnswers = {};
  Game.skipped = new Set();
  Game.currentIndex = 0;
  Game.score = 0; Game.correctCount=0; Game.streak=0;
  Game.awardedMilestones.clear();
  Game.awardedStreaks.clear();
  buildNavigator();
  loadQuestion(0);
  setActiveTab('quiz');
  $('#timerVal').textContent = '—';
  clearInterval(intervalId);
}

function setActiveTab(tab){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  if(tab==='study'){
    $('#tabStudy').classList.add('active');
    Game.els.study.style.display='block';
    Game.els.quiz.style.display='none';
    Game.els.results.style.display='none';
  }else if(tab==='quiz'){
    $('#tabQuiz').classList.add('active');
    Game.els.study.style.display='none';
    Game.els.quiz.style.display='block';
    Game.els.results.style.display='none';
  }else{
    $('#tabResults').classList.add('active');
    Game.els.study.style.display='none';
    Game.els.quiz.style.display='none';
    Game.els.results.style.display='block';
  }
}

// ===========================
// START THE APP
// ===========================

// Try to load content from external source
document.addEventListener('DOMContentLoaded', function() {
    // Method 1: Try to load from a separate JavaScript file
    // You can rename this file to whatever you want
    const script = document.createElement('script');
    script.src = 'content.js';
    script.onload = function() {
        console.log('Content loaded successfully');
        init();
    };
    script.onerror = function() {
        console.log('Failed to load content.js, using fallback content');
        loadFallbackContent();
    };
    document.head.appendChild(script);
});
</script>
</body>
</html>