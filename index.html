<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quiz Manager — Study Preview & Quizzes (Complete)</title>

<!-- PDF.js (CDN) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

<style>
  :root{
    --bg:#071020;
    --card:#0b1220;
    --muted:#94a3b8;
    --accent:#0ea5a4;
    --surface:#0b1220;
    --glass: rgba(255,255,255,0.03);
  }
  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;}
  body{background:linear-gradient(180deg,#071020 0%, #071220 100%);color:#e6eef6; -webkit-font-smoothing:antialiased;}
  .container{max-width:1100px;margin:20px auto;padding:18px;}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px;position:relative;z-index:20;}
  .brand{display:flex;gap:12px;align-items:center;}
  .logo{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#06757a);display:flex;align-items:center;justify-content:center;font-weight:700;}
  .title{font-size:18px;font-weight:700;}
  nav{display:flex;gap:8px;align-items:center;}
  .nav-links{display:flex;gap:8px;}
  .btn{background:var(--accent);border:none;padding:8px 12px;border-radius:8px;color:#04181a;font-weight:600;cursor:pointer;}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);font-weight:600;}
  .small{padding:6px 10px;font-size:14px;border-radius:7px;}
  .row{display:flex;gap:12px;align-items:flex-start;}
  .col{flex:1;}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03);}
  h2{margin:0 0 10px 0;font-size:16px;}
  input[type="file"]{display:block;}
  label{color:var(--muted);font-size:13px;}
  .quiz-list{display:flex;flex-direction:column;gap:8px;margin-top:8px;}
  .quiz-item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:10px;background:var(--glass);border:1px solid rgba(255,255,255,0.02);}
  .quiz-meta{display:flex;gap:12px;align-items:center;}
  .badge{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px;font-size:13px;color:var(--muted);}
  .term-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;margin-top:12px;}
  .term-card{background:linear-gradient(180deg,#0b1522,#07111a);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);min-height:96px;display:flex;flex-direction:column;justify-content:space-between;}
  .term-name{font-weight:700;font-size:15px;}
  .term-desc{color:var(--muted);font-size:13px;margin-top:8px;white-space:pre-wrap;}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
  .search{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;}
  .modal{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);z-index:80;}
  .modal.open{display:flex;}
  .modal-card{width:94%;max-width:980px;background:linear-gradient(180deg,#071427,#06131b);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 10px 30px rgba(0,0,0,0.6);}
  .modal-head{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px;}
  .kbd{background:rgba(255,255,255,0.02);border-radius:6px;padding:6px 8px;font-weight:600;font-size:13px;}
  .file-info{font-size:13px;color:var(--muted);}
  footer{color:var(--muted);font-size:13px;margin-top:12px;text-align:center;}
  .hamburger{display:none;background:transparent;border:0;color:var(--muted);font-size:20px}
  @media (max-width:900px){
    .nav-links{display:none;}
    .hamburger{display:block;}
    .row{flex-direction:column;}
  }
  .danger{background:#ff6961;color:#1b0410;}
  .muted{color:var(--muted);}
  .hidden{display:none;}
  .menu-panel{position:fixed;right:12px;top:70px;background:var(--surface);padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);display:none;z-index:90;}
  .menu-panel.open{display:block;}
  .app-overlay{position:fixed;inset:0;background:linear-gradient(180deg,rgba(2,6,23,0.95),rgba(2,6,23,0.98));display:none;align-items:center;justify-content:center;z-index:999;color:#fff;padding:24px;}
  .app-overlay.open{display:flex;}
  .app-card{max-width:720px;background:linear-gradient(180deg,#08202a,#06161b);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);text-align:center;}
  .linkish{color:var(--accent);text-decoration:underline;cursor:pointer;}
  .toolbar{display:flex;gap:8px;align-items:center;}
  .hint{font-size:13px;color:var(--muted);margin-top:8px;}
  .file-progress{font-size:13px;color:var(--muted);margin-top:6px;}
  .full-browser-warning{background:#101827;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);margin-bottom:12px;}
  .sr-only{position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden;}
</style>
</head>
<body>
<div class="app-overlay" id="appOverlay" aria-hidden="true">
  <div class="app-card">
    <h3>Open in your device browser</h3>
    <p class="muted">This web app needs a full browser to work properly. In-app browsers (Messenger, Instagram, Facebook) may block file downloads, the Fullscreen API, or opening new windows. Please open this link in your device’s browser for the best experience.</p>
    <p style="margin-top:12px;">
      <a id="openInBrowserBtn" class="btn small" target="_blank" rel="noopener">Open in Browser</a>
      <button id="dismissOverlay" class="btn small ghost">Continue anyway</button>
    </p>
  </div>
</div>

<div class="container" id="mainContainer">
  <header>
    <div class="brand">
      <div class="logo">QZ</div>
      <div>
        <div class="title">Quiz Manager</div>
        <div style="font-size:12px;color:var(--muted)">Study preview • Save/View/Delete • PDF import & extraction</div>
      </div>
    </div>

    <nav>
      <div class="nav-links">
        <button id="fullscreenBtn" class="btn small">Full screen</button>
        <button id="newQuizBtn" class="btn small ghost">New Quiz</button>
        <button id="importBtn" class="btn small">Import PDF</button>
        <button id="downloadAllBtn" class="btn small ghost">Download All (JSON)</button>
      </div>
      <button class="hamburger" id="hamburgerBtn" aria-label="menu">☰</button>
    </nav>
  </header>

  <div class="menu-panel" id="menuPanel" role="menu" aria-hidden="true">
    <button id="mFull" class="btn small">Full screen</button>
    <button id="mNew" class="btn small ghost">New Quiz</button>
    <button id="mImport" class="btn small">Import PDF</button>
    <button id="mDownload" class="btn small ghost">Download All</button>
  </div>

  <main class="panel" id="contentPanel">
    <div class="full-browser-warning hidden" id="browserWarning">
      <strong>Note:</strong> Files and Fullscreen work best in a real browser tab. If you opened this inside a chat app, use the "Open in Browser" button above.
    </div>

    <div class="row">
      <div class="col" style="min-width:300px;">
        <h2>Saved quizzes</h2>
        <div class="controls">
          <input id="searchQuizzes" class="search" placeholder="Search quizzes by title..." aria-label="Search quizzes">
        </div>

        <div id="quizzes" class="quiz-list" aria-live="polite"></div>

        <div style="margin-top:12px;">
          <button id="clearAll" class="btn ghost small">Clear all saved quizzes</button>
        </div>
      </div>

      <div class="col" style="max-width:640px;">
        <h2>Study preview</h2>
        <div class="controls" style="align-items:center;">
          <input id="searchTerms" class="search" placeholder="Search term or description..." aria-label="Search terms">
          <div style="display:flex;gap:8px;">
            <select id="quizzesDropdown" class="small" aria-label="Select quiz">
              <option value="">— Choose quiz —</option>
            </select>
            <div class="file-info" id="attachedPdfInfo"></div>
          </div>
        </div>

        <div id="termGrid" class="term-grid" aria-live="polite">
          <!-- term cards here -->
        </div>
      </div>
    </div>
  </main>

  <footer>
    <div>Made with care — localStorage used for saved quizzes • Works offline in browser</div>
  </footer>
</div>

<!-- Hidden controls / file inputs -->
<input id="fileInput" type="file" accept="application/pdf" multiple class="hidden" />

<!-- Modal for viewing / editing a quiz -->
<div class="modal" id="modal">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-head">
      <div>
        <h3 id="modalTitle">Quiz</h3>
        <div class="muted" id="modalMeta"></div>
      </div>
      <div class="toolbar">
        <button id="modalClose" class="btn ghost small">Close</button>
        <button id="modalDelete" class="btn small danger">Delete</button>
      </div>
    </div>

    <div id="modalBody">
      <div style="margin-bottom:8px;"><label class="muted">Terms</label></div>
      <div id="modalTerms" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;"></div>
    </div>
  </div>
</div>

<script>
/* ===========================
   COMPLETE Quiz Manager
   - localStorage persistence
   - PDF.js extraction (heuristic)
   - View / Delete / Export / Duplicate / Import
   - Fixed dropdown count & file-handling
   - In-app browser overlay
   =========================== */

const STORAGE_KEY = 'quiz_manager_v2_complete';

/* ----------------------
   Utilities
------------------------*/
function uid(prefix='id'){ return prefix + '_' + Math.random().toString(36).slice(2,9); }
function now(){ return Date.now(); }
function escapeHtml(s){ if(!s && s!=='') return ''; return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function sanitizeFilename(name){ return String(name || '').replace(/[^a-z0-9_\-\.]/gi,'_').slice(0,120); }

/* ----------------------
   Storage helpers
------------------------*/
function loadAllQuizzes(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? JSON.parse(raw) : [];
  }catch(e){ console.error(e); return []; }
}
function saveAllQuizzes(list){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
}

/* ----------------------
   Element refs
------------------------*/
const quizzesNode = document.getElementById('quizzes');
const termGrid = document.getElementById('termGrid');
const quizzesDropdown = document.getElementById('quizzesDropdown');
const searchQuizzes = document.getElementById('searchQuizzes');
const searchTerms = document.getElementById('searchTerms');
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modalTitle');
const modalMeta = document.getElementById('modalMeta');
const modalTerms = document.getElementById('modalTerms');
const modalClose = document.getElementById('modalClose');
const modalDelete = document.getElementById('modalDelete');
const clearAll = document.getElementById('clearAll');
const fileInput = document.getElementById('fileInput');
const attachedPdfInfo = document.getElementById('attachedPdfInfo');
const appOverlay = document.getElementById('appOverlay');
const openInBrowserBtn = document.getElementById('openInBrowserBtn');
const dismissOverlay = document.getElementById('dismissOverlay');
const browserWarning = document.getElementById('browserWarning');
const downloadAllBtn = document.getElementById('downloadAllBtn');

/* ----------------------
   Init sample data if none
------------------------*/
if(!localStorage.getItem(STORAGE_KEY)){
  const example = [
    { id: uid('quiz'), title: 'Sample: Civil Terms', created: now(),
      attached: null, attachedNames: null,
      items: [
        {term:'Civil Procedure', desc:'Legal rules that govern the process of litigation.'},
        {term:'Tort', desc:'A civil wrong causing loss or harm.'},
        {term:'Plaintiff', desc:'Person who brings a case against another in a court.'}
      ]
    }
  ];
  saveAllQuizzes(example);
}

/* ----------------------
   Render quizzes list & dropdown
------------------------*/
function renderQuizzes(filter=''){
  const list = loadAllQuizzes();
  quizzesNode.innerHTML = '';
  quizzesDropdown.innerHTML = '<option value="">— Choose quiz —</option>';
  const normalized = (filter||'').trim().toLowerCase();

  const display = list.filter(q => !normalized || q.title.toLowerCase().includes(normalized));
  if(display.length===0){
    quizzesNode.innerHTML = '<div class="muted" style="padding:12px;border-radius:8px;">No quizzes — create one or import a PDF.</div>';
  } else {
    display.forEach(q=>{
      const node = document.createElement('div'); node.className='quiz-item';
      node.innerHTML = `
        <div class="quiz-meta" style="align-items:center;">
          <div>
            <div style="font-weight:700">${escapeHtml(q.title)}</div>
            <div class="muted" style="font-size:12px">${new Date(q.created).toLocaleString()}</div>
          </div>
          <div style="margin-left:8px">
            <div class="badge">${q.items.length} items</div>
            ${ q.attachedNames ? `<div style="margin-top:6px;font-size:12px;color:var(--muted)">PDF: ${escapeHtml(q.attachedNames)}</div>` : '' }
          </div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn small" data-action="view" data-id="${q.id}">View</button>
          <button class="btn small ghost" data-action="export" data-id="${q.id}">Export</button>
          <button class="btn small ghost" data-action="duplicate" data-id="${q.id}">Duplicate</button>
        </div>
      `;
      quizzesNode.appendChild(node);
    });
  }

  // dropdown: always full list regardless of search filter for clarity
  const listForDropdown = loadAllQuizzes();
  listForDropdown.forEach(q=>{
    const opt = document.createElement('option');
    opt.value = q.id; opt.textContent = `${q.title} (${q.items.length})`;
    quizzesDropdown.appendChild(opt);
  });
}

/* ----------------------
   Term rendering
------------------------*/
function renderTerms(items){
  termGrid.innerHTML = '';
  if(!items || items.length===0){
    termGrid.innerHTML = '<div class="muted">No terms to preview.</div>';
    return;
  }
  items.forEach(it=>{
    const el = document.createElement('div'); el.className='term-card';
    el.innerHTML = `<div><div class="term-name">${escapeHtml(it.term)}</div><div class="term-desc">${escapeHtml(it.desc)}</div></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button class="btn small" data-term="${escapeHtml(it.term)}" onclick="copyTerm(this)">Copy</button>
        <button class="btn small ghost" onclick="editTerm(this)">Edit</button>
      </div>`;
    termGrid.appendChild(el);
  });
}

/* ----------------------
   Event wiring
------------------------*/
document.addEventListener('click', (ev)=>{
  const t = ev.target;
  const action = t.dataset.action;
  if(action){
    const id = t.dataset.id;
    if(action==='view'){ openQuizModal(id); }
    if(action==='export'){ exportQuiz(id); }
    if(action==='duplicate'){ duplicateQuiz(id); }
  }
});

quizzesDropdown.addEventListener('change', ()=> {
  const id = quizzesDropdown.value;
  if(!id){ termGrid.innerHTML = '<div class="muted">Choose a quiz to preview its terms.</div>'; attachedPdfInfo.textContent=''; return; }
  const q = loadAllQuizzes().find(x=>x.id===id);
  if(!q){ termGrid.innerHTML = '<div class="muted">Quiz not found.</div>'; attachedPdfInfo.textContent=''; return; }
  attachedPdfInfo.textContent = q.attachedNames ? q.attachedNames : '';
  renderTerms(q.items);
});

searchQuizzes.addEventListener('input', ()=> renderQuizzes(searchQuizzes.value));

searchTerms.addEventListener('input', ()=>{
  const qid = quizzesDropdown.value;
  const q = loadAllQuizzes().find(x=>x.id===qid);
  if(!q) {
    // if no quiz selected, try searching across all quizzes and show aggregated results
    const query = searchTerms.value.trim().toLowerCase();
    if(!query){ termGrid.innerHTML = '<div class="muted">No quiz selected. Choose one from the dropdown to preview terms.</div>'; return; }
    const all = loadAllQuizzes().flatMap(q => q.items.map(it => ({...it, _quizTitle: q.title})));
    const filtered = all.filter(it => it.term.toLowerCase().includes(query) || it.desc.toLowerCase().includes(query));
    if(filtered.length===0){ termGrid.innerHTML = '<div class="muted">No results.</div>'; return; }
    termGrid.innerHTML = '';
    filtered.forEach(it=>{
      const el = document.createElement('div'); el.className='term-card';
      el.innerHTML = `<div><div class="term-name">${escapeHtml(it.term)}</div><div class="term-desc">${escapeHtml(it.desc)}</div></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
          <div class="muted" style="font-size:12px">${escapeHtml(it._quizTitle)}</div>
          <div style="display:flex;gap:8px">
            <button class="btn small" data-term="${escapeHtml(it.term)}" onclick="copyTerm(this)">Copy</button>
          </div>
        </div>`;
      termGrid.appendChild(el);
    });
    return;
  }
  const query = searchTerms.value.trim().toLowerCase();
  const filtered = q.items.filter(it => it.term.toLowerCase().includes(query) || it.desc.toLowerCase().includes(query));
  renderTerms(filtered);
});

/* ----------------------
   Modal
------------------------*/
let currentModalId = null;
function openQuizModal(id){
  const q = loadAllQuizzes().find(x=>x.id===id);
  if(!q) return;
  currentModalId = id;
  modalTitle.textContent = q.title;
  modalMeta.textContent = `${q.items.length} terms • Created ${new Date(q.created).toLocaleString()}`;
  modalTerms.innerHTML = '';
  q.items.forEach(it=>{
    const d = document.createElement('div');
    d.style.padding='8px'; d.style.borderRadius='8px'; d.style.background='rgba(255,255,255,0.02)';
    d.innerHTML = `<strong>${escapeHtml(it.term)}</strong><div class="muted" style="margin-top:6px">${escapeHtml(it.desc)}</div>`;
    modalTerms.appendChild(d);
  });
  modal.classList.add('open');
}
modalClose.addEventListener('click', ()=>modal.classList.remove('open'));
modalDelete.addEventListener('click', ()=>{
  if(!currentModalId) return;
  if(!confirm('Delete this quiz? This cannot be undone.')) return;
  const list = loadAllQuizzes().filter(q=>q.id!==currentModalId);
  saveAllQuizzes(list);
  modal.classList.remove('open');
  renderQuizzes(searchQuizzes.value);
  quizzesDropdown.dispatchEvent(new Event('change'));
});

/* ----------------------
   Export & Duplicate
------------------------*/
function exportQuiz(id){
  const q = loadAllQuizzes().find(x=>x.id===id);
  if(!q) return alert('Quiz missing');
  const dataStr = JSON.stringify(q, null, 2);
  const blob = new Blob([dataStr], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `${sanitizeFilename(q.title)}.quiz.json`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

function duplicateQuiz(id){
  const list = loadAllQuizzes();
  const q = list.find(x=>x.id===id);
  if(!q) return;
  const copy = JSON.parse(JSON.stringify(q));
  copy.id = uid('quiz');
  copy.title = q.title + ' (copy)';
  copy.created = now();
  list.push(copy);
  saveAllQuizzes(list);
  renderQuizzes(searchQuizzes.value);
}

/* ----------------------
   New quiz flow
------------------------*/
document.getElementById('newQuizBtn').addEventListener('click', createNewQuizFlow);
document.getElementById('mNew').addEventListener('click', createNewQuizFlow);

function createNewQuizFlow(){
  const title = prompt('Enter quiz title:');
  if(!title) return alert('Canceled');
  const items = [];
  while(true){
    const term = prompt('Enter a term (leave blank to finish):'); if(!term) break;
    const desc = prompt('Enter description for "' + term + '":') || '';
    items.push({term:term.trim(), desc:desc.trim()});
  }
  if(items.length===0) return alert('Quiz must have at least one item.');
  const list = loadAllQuizzes();
  const q = { id: uid('quiz'), title: title.trim(), created: now(), items, attached:null, attachedNames:null };
  list.push(q); saveAllQuizzes(list); renderQuizzes(searchQuizzes.value);
  alert('Quiz saved. You can preview it via the dropdown or the list.');
}

/* ----------------------
   Clear all saved
------------------------*/
clearAll.addEventListener('click', ()=>{
  if(!confirm('Clear all saved quizzes? This removes them from localStorage.')) return;
  localStorage.removeItem(STORAGE_KEY);
  renderQuizzes('');
  quizzesDropdown.innerHTML = '<option value="">— Choose quiz —</option>';
  termGrid.innerHTML = '<div class="muted">No quiz selected.</div>';
});

/* ----------------------
   File (PDF) upload handling & parsing (PDF.js)
   - Heuristic extraction:
     * If line contains ":" or " - " or " — " split into term:desc
     * Else pair lines (term line then desc line)
   - This is heuristic — fine for many flashcard-style PDFs but not guaranteed
------------------------*/
document.getElementById('importBtn').addEventListener('click', ()=>fileInput.click());
document.getElementById('mImport').addEventListener('click', ()=>fileInput.click());
document.getElementById('importBtn').addEventListener('keydown', (e)=>{ if(e.key==='Enter') fileInput.click(); });

fileInput.addEventListener('change', async (ev)=>{
  const files = Array.from(ev.target.files || []);
  if(files.length===0) return;
  // choose quiz: attach to existing or create new
  let quizId = quizzesDropdown.value;
  let createdNew = false;
  if(!quizId){
    const create = confirm('No quiz selected — create a new quiz and import selected file(s)?');
    if(!create) { fileInput.value=''; return; }
    const title = prompt('Title for new imported quiz:') || `Imported PDF ${new Date().toLocaleString()}`;
    const q = { id: uid('quiz'), title: title.trim(), created: now(), items: [], attached: true, attachedNames: files.map(f=>f.name).join(', ')};
    const list = loadAllQuizzes(); list.push(q); saveAllQuizzes(list);
    quizId = q.id; createdNew = true;
  } else {
    // attach to existing
    const list = loadAllQuizzes();
    const q = list.find(x=>x.id===quizId);
    q.attached = true;
    q.attachedNames = files.map(f=>f.name).join(', ');
    saveAllQuizzes(list);
  }

  // parse each PDF and add items heuristically
  const parsedItems = [];
  const progressEl = document.createElement('div'); progressEl.className='file-progress'; progressEl.textContent = `Parsing ${files.length} file(s)...`; document.body.appendChild(progressEl);
  for(let i=0;i<files.length;i++){
    const f = files[i];
    try{
      const arr = await f.arrayBuffer();
      const itemsFromPdf = await extractTermsFromPdf(arr, f.name);
      // annotate source
      itemsFromPdf.forEach(it => it._source = f.name);
      parsedItems.push(...itemsFromPdf);
    }catch(err){
      console.error('PDF parse error', err);
      alert(`Failed to parse ${f.name}: ${err.message || err}`);
    }
  }
  progressEl.remove();

  // save results into quiz
  const list = loadAllQuizzes();
  const q = list.find(x=>x.id===quizId);
  // append parsed items but avoid empty/duplicate terms
  const existingTerms = new Set(q.items.map(i => (i.term||'').toLowerCase()));
  const newItems = parsedItems.filter(it => it.term && !existingTerms.has(it.term.toLowerCase()));
  if(newItems.length>0) q.items.push(...newItems);
  q.attached = true;
  q.attachedNames = files.map(f=>f.name).join(', ');
  saveAllQuizzes(list);
  renderQuizzes(searchQuizzes.value);
  quizzesDropdown.value = quizId;
  quizzesDropdown.dispatchEvent(new Event('change'));
  fileInput.value = '';
  alert(`Imported ${files.length} file(s). ${newItems.length} new term(s) added to quiz${createdNew?(' "'+q.title+'"'):''}.`);
});

/* PDF extraction using PDF.js */
async function extractTermsFromPdf(arrayBuffer, filename='pdf'){
  try{
    // pdfjsLib is loaded from CDN
    const loadingTask = pdfjsLib.getDocument({data: arrayBuffer});
    const pdf = await loadingTask.promise;
    let fullText = '';
    for(let p=1;p<=pdf.numPages;p++){
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      const strings = content.items.map(i => i.str).filter(Boolean);
      // join with newlines to preserve line boundaries heuristically
      fullText += strings.join(' ') + '\n';
    }
    // Use heuristic parser
    return heuristicParseTextToTerms(fullText, filename);
  }catch(err){
    console.error('extractTermsFromPdf error', err);
    return [];
  }
}

/* Heuristic text -> terms parser
   Strategies:
   - Split by line breaks; for each line:
     * if contains ":" or " - " or " — " -> split into term:desc
     * else collect lines and pair them: odd line -> term, next line -> desc
   - Also split long paragraphs by sentence separators when possible.
*/
function heuristicParseTextToTerms(text, filename='pdf'){
  if(!text) return [];
  // normalize whitespace
  const cleaned = text.replace(/\t/g,' ').replace(/\r/g,'\n').replace(/\n{2,}/g,'\n').trim();
  const lines = cleaned.split('\n').map(l => l.trim()).filter(l => l.length>0);
  const results = [];
  const buffer = [];
  function flushBufferAsPairs(){
    for(let i=0;i<buffer.length;i+=2){
      const term = buffer[i] || '';
      const desc = buffer[i+1] || '';
      if(term.trim()){
        results.push({term: term.trim(), desc: desc.trim()});
      }
    }
    buffer.length = 0;
  }

  for(const raw of lines){
    const line = raw.trim();
    // prefer explicit separators
    const sepMatch = line.match(/(.+?)\s*[:\-—–]\s*(.+)/);
    if(sepMatch){
      const t = sepMatch[1].trim();
      const d = sepMatch[2].trim();
      if(t) results.push({term:t, desc:d});
      continue;
    }

    // if the line has lots of words and a dash or parentheses, try splitting on first dash or parentheses
    const dashIndex = line.indexOf(' - ');
    if(dashIndex > 3 && dashIndex < 60){ // plausible
      const t = line.slice(0,dashIndex).trim();
      const d = line.slice(dashIndex+3).trim();
      if(t) { results.push({term:t, desc:d}); continue; }
    }

    // If line appears like "Term — short explanation", split on em-dash
    const emDash = line.indexOf('—');
    if(emDash > 1){
      const t = line.slice(0, emDash).trim();
      const d = line.slice(emDash+1).trim();
      if(t) { results.push({term:t, desc:d}); continue; }
    }

    // If none matched, store in buffer for pairing
    buffer.push(line);
    if(buffer.length >= 2){
      // pair them
      flushBufferAsPairs();
    }
  }
  // flush any leftover
  if(buffer.length>0) flushBufferAsPairs();

  // postprocess: merge or trim overly long terms/descs, remove duplicates
  const seen = new Set();
  const cleanedResults = [];
  for(const it of results){
    const t = it.term.replace(/\s\s+/g,' ').trim();
    const d = (it.desc||'').replace(/\s\s+/g,' ').trim();
    if(!t) continue;
    const key = (t + '||' + d).toLowerCase();
    if(seen.has(key)) continue;
    seen.add(key);
    // limit desc length for practicality (but keep content)
    cleanedResults.push({term: t, desc: d});
  }
  // As a last resort, if nothing parsed, try splitting by sentences into term/desc pairs
  if(cleanedResults.length===0){
    const sentences = cleaned.split(/[.?!]\s+/).map(s=>s.trim()).filter(Boolean);
    for(let i=0;i<sentences.length;i+=2){
      cleanedResults.push({term: sentences[i], desc: sentences[i+1] || ''});
    }
  }
  // annotate with source if needed (done earlier)
  return cleanedResults;
}

/* ----------------------
   Copy / edit term (exposed globally)
------------------------*/
function copyTerm(btn){ navigator.clipboard?.writeText(btn.dataset.term).then(()=>{ alert('Term copied') }).catch(()=>alert('Copy failed')); }
function editTerm(btn){
  // find term text in DOM and show simple edit prompt
  const card = btn.closest('.term-card');
  if(!card) return;
  const termEl = card.querySelector('.term-name');
  const descEl = card.querySelector('.term-desc');
  const oldTerm = termEl ? termEl.textContent.trim() : '';
  const oldDesc = descEl ? descEl.textContent.trim() : '';
  const newTerm = prompt('Edit term:', oldTerm);
  if(newTerm === null) return;
  const newDesc = prompt('Edit description:', oldDesc);
  if(newDesc === null) return;
  // update in storage: we need to know which quiz is selected
  const qid = quizzesDropdown.value;
  if(!qid) return alert('Select the quiz that contains this term in the dropdown to edit it.');
  const list = loadAllQuizzes();
  const q = list.find(x=>x.id===qid);
  if(!q) return;
  const item = q.items.find(i => i.term === oldTerm && i.desc === oldDesc);
  if(!item) return alert('Could not find the original term in storage.');
  item.term = newTerm.trim();
  item.desc = newDesc.trim();
  saveAllQuizzes(list);
  quizzesDropdown.dispatchEvent(new Event('change'));
  alert('Term updated.');
}
window.copyTerm = copyTerm;
window.editTerm = editTerm;

/* ----------------------
   Fullscreen and menu
------------------------*/
const fsBtn = document.getElementById('fullscreenBtn');
const mFsBtn = document.getElementById('mFull');
fsBtn.addEventListener('click', ()=>requestFullScreen(document.documentElement));
mFsBtn.addEventListener('click', ()=>requestFullScreen(document.documentElement));
function requestFullScreen(el){
  if(!el) return;
  if(el.requestFullscreen) el.requestFullscreen();
  else if(el.webkitRequestFullscreen) el.webkitRequestFullscreen();
  else if(el.msRequestFullscreen) el.msRequestFullscreen();
}

/* ----------------------
   Hamburger menu
------------------------*/
const hamburger = document.getElementById('hamburgerBtn');
const menuPanel = document.getElementById('menuPanel');
hamburger.addEventListener('click', ()=>{
  menuPanel.classList.toggle('open');
});
document.addEventListener('click', (e)=>{ if(!hamburger.contains(e.target) && !menuPanel.contains(e.target)) menuPanel.classList.remove('open'); });

/* ----------------------
   In-app browser detection and overlay behavior
------------------------*/
function isInAppBrowser(){
  const ua = navigator.userAgent || '';
  const patterns = ['FBAN','FBAV','Messenger','Instagram','Line','Twitter','LinkedInApp','WhatsApp','Instagram'];
  // plus some heuristics
  return patterns.some(p => ua.indexOf(p) !== -1) || (/FBAN|FBAV/i.test(ua) && /Mobile/i.test(ua));
}
if(isInAppBrowser()){
  appOverlay.classList.add('open');
  openInBrowserBtn.href = window.location.href;
  openInBrowserBtn.target = '_blank';
  dismissOverlay.addEventListener('click', ()=>appOverlay.classList.remove('open'));
  browserWarning.classList.remove('hidden');
}

/* ----------------------
   Download all quizzes (export)
------------------------*/
downloadAllBtn.addEventListener('click', ()=>{
  const data = loadAllQuizzes();
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const a = document.createElement('a'); const url = URL.createObjectURL(blob);
  a.href = url; a.download = 'quizzes-all.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
document.getElementById('mDownload').addEventListener('click', ()=>downloadAllBtn.click());

/* ----------------------
   Utility: On load render
------------------------*/
renderQuizzes('');
termGrid.innerHTML = '<div class="muted">No quiz selected. Choose one from the dropdown to preview terms.</div>';

/* Accessibility: Escape closes modal */
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') modal.classList.remove('open'); });

/* ----------------------
   Expose some API for debug (console)
------------------------*/
window._quizmgr = {
  loadAll: loadAllQuizzes,
  saveAll: saveAllQuizzes,
  addQuiz: (q)=>{ const list = loadAllQuizzes(); list.push(q); saveAllQuizzes(list); renderQuizzes(''); },
  extractText: async (file) => { if(!file) return []; const arr = await file.arrayBuffer(); return await extractTermsFromPdf(arr, file.name); }
};
</script>
</body>
</html>