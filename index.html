<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PDF Quiz â€” Combined</title>

<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
  :root{
    --bg: #f6f7fb;
    --card: #fff;
    --primary: #4361ee;
    --accent: #3a0ca3;
    --muted: #6c757d;
    --success: #34c6eb;
    --danger: #ff5ca8;
    --radius: 12px;
    --shadow: 0 12px 28px rgba(0,0,0,.06);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#f2f4ff 0%,var(--bg) 100%);color:#222;min-height:100vh}
  header.appbar{position:sticky;top:0;z-index:999;background:var(--card);display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid #eef0f4}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--accent));display:grid;place-items:center;color:#fff;font-weight:800}
  .title{font-weight:800}
  .tabs{display:flex;gap:8px;align-items:center}
  .tab{border:none;background:#f1f3ff;color:var(--primary);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
  .tab.active{background:var(--primary);color:#fff}
  .right-actions{display:flex;gap:10px;align-items:center}
  .pill{background:#fff;border-radius:999px;padding:8px 12px;border:1px solid #e9ecf3;display:flex;gap:8px;align-items:center;font-weight:700}

  /* Layout */
  .wrapper{max-width:1200px;margin:20px auto;padding:0 16px;display:flex;gap:20px;align-items:flex-start}
  .sidebar{width:300px;background:var(--card);padding:18px;border-radius:18px;box-shadow:var(--shadow);position:sticky;top:84px;height:fit-content}
  .main{flex:1;display:flex;flex-direction:column;gap:16px}

  /* Cards */
  .card{background:var(--card);border-radius:18px;padding:18px;box-shadow:var(--shadow)}
  h2{margin:0 0 8px 0}
  p.small{color:var(--muted);margin:0}

  /* Upload area */
  .upload-area{border:3px dashed #dbeafe;border-radius:16px;padding:34px;text-align:center;background:#f8faff;cursor:pointer}
  .upload-area.drag-over{border-color:var(--success);background:#e6f7ff}
  .upload-btn{background:var(--primary);color:#fff;border:none;padding:10px 16px;border-radius:10px;cursor:pointer;font-weight:700}
  .file-info{display:none;margin-top:12px;padding:10px;background:#f0f4ff;border-radius:10px}

  /* Controls & stats */
  .stats{display:flex;gap:12px;flex-wrap:wrap}
  .stat{background:#fff;padding:12px;border-radius:12px;min-width:110px;text-align:center;box-shadow:0 6px 12px rgba(0,0,0,.03)}
  .stat .val{font-size:1.3rem;font-weight:800;color:var(--primary)}

  /* Quiz area */
  .question-card{padding:18px;border-radius:14px;background:#fff;box-shadow:var(--shadow)}
  .question-text{font-weight:700;font-size:1.1rem;margin:12px 0}
  .options{display:grid;gap:10px}
  .option{display:flex;gap:12px;align-items:center;border:2px solid #edf0f7;padding:12px;border-radius:12px;cursor:pointer;background:#fafcff}
  .option:hover{transform:translateY(-3px)}
  .option.correct{border-color:var(--success);background:#eaffff}
  .option.incorrect{border-color:var(--danger);background:#fff4f7}
  .option.faded{opacity:.35;pointer-events:none}
  .letter{width:36px;height:36px;border-radius:8px;background:#fff;display:grid;place-items:center;border:1px solid #e9ecf3;font-weight:800}

  .controls{display:flex;gap:10px;margin-top:12px;align-items:center}
  .btn{border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:800}
  .btn-primary{background:var(--primary);color:#fff}
  .btn-ghost{background:#fff;border:2px solid #edf0f7}

  /* Powerups */
  .powerups{display:flex;gap:10px;margin:8px 0}
  .powerup{background:#fff;border-radius:12px;padding:10px;border:1px solid #eef0f7;cursor:pointer;display:flex;flex-direction:column;align-items:center;width:84px}
  .powerup .count{font-size:.9rem;color:#666}

  /* Shop modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:2000}
  .modal.show{display:flex}
  .modal-card{background:#fff;border-radius:14px;padding:18px;max-width:720px;width:94%}

  /* Toast */
  .toast{position:fixed;top:18px;right:18px;background:#fff;padding:12px 16px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.12);display:none;z-index:4000;border-left:4px solid var(--primary)}
  .toast.success{border-left-color:var(--success)}
  .toast.error{border-left-color:var(--danger)}
  .toast.warning{border-left-color:#fca311}

  /* Confetti container */
  .confetti-container{position:fixed;inset:0;pointer-events:none;z-index:3000}

  /* Responsive */
  @media (max-width:1000px){
    .wrapper{flex-direction:column}
    .sidebar{width:100%;position:relative;top:auto}
  }
</style>
</head>
<body>

<header class="appbar">
  <div class="brand">
    <div class="logo">PQ</div>
    <div>
      <div class="title">PDF QUIZ â€” Combined</div>
      <small style="color:var(--muted)">Upload â†’ Auto-generate â†’ Quiz</small>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="upload">Upload</button>
    <button class="tab" data-tab="configure">Configure</button>
    <button class="tab" data-tab="study">Study</button>
    <button class="tab" data-tab="quiz">Quiz</button>
    <button class="tab" data-tab="results">Results</button>
    <button class="tab" data-tab="saved">Saved</button>
  </div>

  <div class="right-actions">
    <div class="pill"><i class="fa-solid fa-coins" style="color:#f39c12"></i> <span id="coinsTop">100</span></div>
    <div class="pill"><i class="fa-solid fa-star" style="color:var(--primary)"></i> <span id="scoreTop">0</span></div>
    <button class="tab" id="openShopBtn"><i class="fa-solid fa-store"></i> Shop</button>
  </div>
</header>

<!-- Toast -->
<div id="toast" class="toast"><strong id="toastTitle"></strong><div style="font-size:0.95rem;color:var(--muted)" id="toastMsg"></div></div>

<main class="wrapper">
  <!-- Sidebar -->
  <aside class="sidebar card">
    <h3>Navigator</h3>
    <div style="margin:10px 0" id="questionGrid"></div>

    <div style="margin-top:14px">
      <button class="btn btn-primary" id="saveQuizBtn" style="width:100%;margin-bottom:8px"><i class="fa-solid fa-save"></i> Save Quiz</button>
      <button class="btn btn-ghost" id="exportAllBtn" style="width:100%;margin-bottom:8px"><i class="fa-solid fa-download"></i> Export Data</button>
      <button class="btn btn-ghost" id="clearStorageBtn" style="width:100%"><i class="fa-solid fa-trash"></i> Clear Storage</button>
    </div>

    <div style="margin-top:12px;background:#f8f9fb;padding:12px;border-radius:10px;border-left:4px solid var(--success)"><strong>Local Storage</strong><p class="small">Quizzes are saved locally in this browser.</p></div>
  </aside>

  <!-- Main -->
  <section class="main">

    <!-- Stats -->
    <div class="stats">
      <div class="stat"><div class="val" id="currentQ">â€”</div><div class="lab">Current</div></div>
      <div class="stat"><div class="val" id="score">0</div><div class="lab">Score</div></div>
      <div class="stat"><div class="val" id="correctCount">0</div><div class="lab">Correct</div></div>
      <div class="stat"><div class="val" id="streak">0</div><div class="lab">Streak</div></div>
      <div class="stat"><div class="val" id="coins">100</div><div class="lab">Coins</div></div>
      <div class="stat"><div class="val" id="timerVal">â€”</div><div class="lab">Timer</div></div>
    </div>

    <!-- Upload card -->
    <div class="card" id="uploadCard">
      <h2><i class="fa-solid fa-file-pdf"></i> Upload PDF</h2>
      <p class="small">Drop a PDF or click Browse. Text will be extracted and used to generate quiz questions.</p>

      <div class="upload-area" id="dropArea">
        <div style="font-size:40px;color:var(--primary)"><i class="fa-solid fa-file-import"></i></div>
        <h3>Drop PDF file here</h3>
        <p class="small">We'll extract the text and generate questions automatically.</p>
        <input type="file" id="pdfInput" accept=".pdf" style="display:none">
        <div style="margin-top:12px">
          <button class="upload-btn" id="browseBtn"><i class="fa-solid fa-folder-open"></i> Browse</button>
        </div>
        <div class="file-info" id="fileInfo">
          <p><strong id="fileName">No file</strong> â€” <span id="fileSize">-</span></p>
        </div>
      </div>

      <div style="margin-top:12px" id="progressWrapper" hidden>
        <div style="height:10px;background:#e9eefb;border-radius:8px;overflow:hidden">
          <div id="progressBar" style="height:100%;width:0%;background:var(--primary);transition:width .25s"></div>
        </div>
        <div style="font-size:0.9rem;color:var(--muted);margin-top:6px" id="progressText">Initializingâ€¦</div>
      </div>

    </div>

    <!-- Configure -->
    <div class="card" id="configureCard">
      <h2>Configure Generation</h2>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
        <div>
          <label><strong>Questions</strong></label>
          <select id="numQuestions" style="width:100%;padding:8px;border-radius:8px;margin-top:6px">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="30">30</option>
            <option value="40">40</option>
          </select>
        </div>
        <div>
          <label><strong>Difficulty</strong></label>
          <select id="difficulty" style="width:100%;padding:8px;border-radius:8px;margin-top:6px">
            <option value="basic">Basic</option>
            <option value="intermediate" selected>Intermediate</option>
            <option value="advanced">Advanced</option>
            <option value="mixed">Mixed</option>
          </select>
        </div>
        <div>
          <label><strong>Focus keywords (comma)</strong></label>
          <input id="focusAreas" placeholder="e.g., biology, taxation" style="width:100%;padding:8px;border-radius:8px;margin-top:6px">
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
        <button class="btn btn-primary" id="genBtn"><i class="fa-solid fa-magic"></i> Generate Questions</button>
        <button class="btn btn-ghost" id="buildStudyBtn"><i class="fa-solid fa-book-open"></i> Build Study Material</button>
      </div>
      <p class="small" style="margin-top:8px">Generation is a heuristic in this build â€” replace or augment `generateQuestionsFromText()` with more advanced logic or an LLM call if you have a backend.</p>
    </div>

    <!-- Study area -->
    <div class="card" id="studyCard" style="display:none">
      <h2>Study</h2>
      <div id="chapters"></div>
      <div style="margin-top:10px;background:#f8f9fb;padding:10px;border-radius:8px"><strong>Tip:</strong> Review chapters before attempting the quiz.</div>
    </div>

    <!-- Quiz area -->
    <div class="card question-card" id="quizCard" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><h3 id="qTitle">Question</h3><div style="font-size:0.9rem;color:var(--muted)" id="qIndex">1 / 1</div></div>
        <div style="display:flex;gap:8px;align-items:center">
          <div style="display:flex;gap:6px;align-items:center">
            <button class="btn btn-ghost timeropt" data-mode="none">No timer</button>
            <button class="btn btn-ghost timeropt" data-mode="quiz">Quiz</button>
            <button class="btn btn-ghost timeropt" data-mode="question">Per Q</button>
          </div>
          <div style="display:flex;gap:6px;align-items:center;margin-left:8px">
            <input type="number" id="quizTimerInput" value="300" min="30" style="width:86px;padding:8px;border-radius:8px">
            <input type="number" id="questionTimerInput" value="30" min="5" style="width:80px;padding:8px;border-radius:8px">
            <button class="btn btn-ghost" id="applyTimers">Apply</button>
          </div>
        </div>
      </div>

      <div class="powerups" style="margin-top:12px">
        <div class="powerup" id="pu5050"><div style="font-weight:900">50:50</div><div class="count" id="count5050">3</div></div>
        <div class="powerup" id="puHint"><div style="font-weight:900"><i class="fa-solid fa-lightbulb"></i></div><div class="count" id="countHint">3</div></div>
        <div class="powerup" id="puSkip"><div style="font-weight:900"><i class="fa-solid fa-forward"></i></div><div class="count" id="countSkip">2</div></div>
      </div>

      <div class="question-text" id="qText"></div>
      <div class="options" id="options"></div>
      <div class="hint" id="hint" style="display:none;margin-top:8px;color:var(--muted)"></div>

      <div class="controls">
        <button class="btn btn-ghost" id="prevBtn"><i class="fa-solid fa-arrow-left"></i> Prev</button>
        <button class="btn btn-ghost" id="nextBtn">Next <i class="fa-solid fa-arrow-right"></i></button>
        <button class="btn btn-primary" id="submitBtn" style="margin-left:auto"><i class="fa-solid fa-paper-plane"></i> Submit</button>
      </div>
    </div>

    <!-- Results -->
    <div class="card" id="resultsCard" style="display:none">
      <h2>Results</h2>
      <div id="resultsSummary"></div>
      <div id="resultsList" style="margin-top:10px"></div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn btn-secondary" id="retryWrong"><i class="fa-solid fa-redo"></i> Retry Wrong</button>
        <button class="btn btn-primary" id="retryAll"><i class="fa-solid fa-sync"></i> Retry All</button>
        <button class="btn btn-ghost" id="exportResults"><i class="fa-solid fa-download"></i> Export Results</button>
      </div>
    </div>

    <!-- Saved quizzes list -->
    <div class="card" id="savedCard" style="display:none">
      <h2>Saved Quizzes</h2>
      <div id="quizList"></div>
    </div>

  </section>
</main>

<!-- Shop Modal -->
<div class="modal" id="shopModal">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>Power-up Store</h3>
      <button class="btn btn-ghost" id="closeShop"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <p style="margin:6px 0">Coins: <strong id="shopCoins">0</strong></p>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-top:12px">
      <div style="padding:12px;border-radius:10px;border:1px solid #eef0f7">
        <h4>50:50</h4><p class="small">Remove two wrong answers</p>
        <button class="btn btn-primary shopBuy" data-power="5050" data-price="80">Buy (80)</button>
      </div>
      <div style="padding:12px;border-radius:10px;border:1px solid #eef0f7">
        <h4>Hint</h4><p class="small">Reveal a hint</p>
        <button class="btn btn-primary shopBuy" data-power="hint" data-price="60">Buy (60)</button>
      </div>
      <div style="padding:12px;border-radius:10px;border:1px solid #eef0f7">
        <h4>Skip</h4><p class="small">Skip a question</p>
        <button class="btn btn-primary shopBuy" data-power="skip" data-price="50">Buy (50)</button>
      </div>
    </div>
  </div>
</div>

<!-- Save quiz modal (simple) -->
<div class="modal" id="saveModal">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>Save Quiz</h3>
      <button class="btn btn-ghost" id="closeSave"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div style="margin-top:12px">
      <label><strong>Title</strong></label>
      <input id="quizTitle" style="width:100%;padding:8px;border-radius:8px;margin-top:6px">
      <label style="margin-top:8px"><strong>Category</strong></label>
      <select id="quizCategory" style="width:100%;padding:8px;border-radius:8px;margin-top:6px">
        <option>General</option><option>Education</option><option>Science</option><option>Other</option>
      </select>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn btn-primary" id="saveToLocal">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Confetti -->
<div class="confetti-container" id="confetti"></div>

<!-- Sounds -->
<audio id="correctSound" src="https://www.soundjay.com/buttons/sounds/button-1.mp3" preload="auto"></audio>
<audio id="incorrectSound" src="https://www.soundjay.com/buttons/sounds/button-10.mp3" preload="auto"></audio>
<audio id="coinSound" src="https://www.soundjay.com/buttons/sounds/button-7.mp3" preload="auto"></audio>
<audio id="powerSound" src="https://www.soundjay.com/buttons/sounds/button-4.mp3" preload="auto"></audio>
<audio id="winSound" src="https://www.soundjay.com/misc/sounds/success-sound-2.mp3" preload="auto"></audio>

<script>
/* =============================
   Minimal unified app state
   ============================= */
const App = {
  pdfText: '',
  pdfFileName: '',
  questions: [],
  currentQuestions: [],
  userAnswers: {},
  skipped: new Set(),
  currentIndex: 0,
  score: 0,
  correctCount: 0,
  streak: 0,
  coins: 100,
  powerups: { '5050': 3, hint: 3, skip: 2 },
  timers: { mode: 'none', quiz: 300, question: 30, quizRemaining: null, questionRemaining: null, interval: null },
  saved: []
};

/* =============================
   Helpers & UI utilities
   ============================= */
const $ = sel => document.querySelector(sel);
function create(el, cls, txt){ const e = document.createElement(el); if(cls) e.className = cls; if(txt!==undefined) e.textContent = txt; return e; }

function showToast(title, msg, type='success', ms=3000){
  const t = $('#toast'); $('#toastTitle').textContent = title; $('#toastMsg').textContent = msg;
  t.className = 'toast ' + (type||''); t.style.display = 'block';
  setTimeout(()=>{ t.style.display = 'none'; }, ms);
}
function playSound(id){ try{ const a = document.querySelector(id); if(a){ a.currentTime = 0; a.play().catch(()=>{}); } }catch(e){} }

/* =============================
   File upload & PDF text extraction
   ============================= */
const pdfInput = $('#pdfInput');
const dropArea = $('#dropArea');
const fileInfo = $('#fileInfo');
const progressWrapper = $('#progressWrapper');
const progressBar = $('#progressBar');
const progressText = $('#progressText');

$('#browseBtn').addEventListener('click', () => pdfInput.click());
pdfInput.addEventListener('change', (e)=> { if(e.target.files[0]) loadPDF(e.target.files[0]); });

['dragenter','dragover'].forEach(evt => dropArea.addEventListener(evt, (e)=>{ e.preventDefault(); dropArea.classList.add('drag-over'); }));
['dragleave','drop'].forEach(evt => dropArea.addEventListener(evt, (e)=>{ e.preventDefault(); dropArea.classList.remove('drag-over'); }));
dropArea.addEventListener('drop', (e)=> {
  e.preventDefault();
  const f = e.dataTransfer.files[0];
  if(!f) return;
  if(f.type!=='application/pdf'){ showToast('Error','Please drop a PDF file','error'); return; }
  loadPDF(f);
});

async function loadPDF(file){
  App.pdfFileName = file.name;
  $('#fileName').textContent = file.name;
  $('#fileSize').textContent = Math.round(file.size/1024) + ' KB';
  fileInfo.style.display = 'block';
  progressWrapper.hidden = false;
  progressBar.style.width = '2%';
  progressText.textContent = 'Loading PDFâ€¦';

  try{
    const arrayBuffer = await file.arrayBuffer();
    progressBar.style.width = '10%';
    progressText.textContent = 'Parsing pagesâ€¦';

    const loadingTask = pdfjsLib.getDocument({data: arrayBuffer});
    const pdf = await loadingTask.promise;
    let fullText = '';
    const total = pdf.numPages;
    for(let i=1;i<=total;i++){
      const page = await pdf.getPage(i);
      const txt = await page.getTextContent();
      const pageText = txt.items.map(it=>it.str).join(' ');
      fullText += '\n\n' + pageText;
      const percent = Math.round((i/total)*90);
      progressBar.style.width = (10 + percent*0.9) + '%';
      progressText.textContent = `Extracting page ${i} / ${total}`;
    }
    App.pdfText = fullText.trim();
    progressBar.style.width = '100%';
    progressText.textContent = 'Extraction complete';
    showToast('PDF Loaded','Text extracted from PDF','success');
    // auto-build study
    buildChaptersFromText();
  }catch(err){
    console.error(err);
    showToast('Error','Failed to read PDF','error');
    progressWrapper.hidden = true;
  }
}

/* =============================
   Build study chapters (simple chunker)
   ============================= */
function buildChaptersFromText(){
  const content = App.pdfText || '';
  if(!content){ showToast('No text','Upload a PDF first','warning'); return; }
  // crude split by double newline or sentence length
  const paras = content.split(/\n{1,}/).map(p=>p.trim()).filter(Boolean);
  const chapters = [];
  const maxChapters = 8;
  const chunkSize = Math.max(1, Math.ceil(paras.length / maxChapters));
  for(let i=0;i<paras.length;i+=chunkSize){
    const chunk = paras.slice(i,i+chunkSize);
    const title = chunk[0].split('. ')[0].slice(0,60) || `Chapter ${Math.floor(i/chunkSize)+1}`;
    chapters.push({ title, content: chunk.join('\n\n') });
  }
  const container = $('#chapters'); container.innerHTML = '';
  chapters.forEach((ch,idx)=>{
    const el = create('div',null);
    el.innerHTML = `<h4 style="margin:0">${ch.title}</h4><p style="white-space:pre-wrap;color:var(--muted);">${ch.content}</p>`;
    container.appendChild(el);
  });
  $('#studyCard').style.display = 'block';
  showToast('Study material built','Split the document into chapters','success');
}

/* =============================
   Question generation (placeholder heuristics)
   =============================
   This is a simple rule-based generator: extract sentences with colons,
   definitions formats, or capitalized terms â€” it's a starting point.
   Replace / augment this function with better logic or server LLM calls.
*/
function generateQuestionsFromText(){
  const text = App.pdfText || '';
  if(!text) { showToast('No PDF text','Upload a PDF first','error'); return []; }

  const sentences = text.split(/(?<=[.?!])\s+/).map(s=>s.trim()).filter(Boolean);
  const defs = [], comps = [];
  // Definitions: "Term â€” definition" or "X is Y."
  sentences.forEach(s=>{
    // pattern: "X is Y"
    const m = s.match(/^([A-Z][A-Za-z0-9 \-]+?) is (.+?)\.$/i);
    if(m){
      defs.push({ question: `What is ${m[1]}?`, options: pickDistractors(m[2]), ans: 0, hint: m[2], context: s });
      return;
    }
    // pattern: "Term: definition..."
    const n = s.match(/^([A-Z][A-Za-z0-9 \-]{2,60}):\s*(.+?)$/);
    if(n){
      defs.push({ question: `What does "${n[1]}" refer to?`, options: pickDistractors(n[2]), ans: 0, hint: n[2], context: s });
      return;
    }
  });

  // comprehension: pick some sentences and turn into simple multiple choice by blanking a keyword
  sentences.slice(0, 200).forEach(s=>{
    const words = s.split(/\s+/).filter(w=>w.length>3);
    if(words.length<6) return;
    const candidate = words[Math.floor(Math.random()*Math.min(6,words.length))];
    const qtext = s.replace(new RegExp(`\\b${escapeReg(candidate)}\\b`,'i'), '_____');
    comps.push({ question: qtext, options: pickDistractors(candidate), ans: 0, hint: `Look for the missing word in the sentence.`, context: s });
  });

  // Combine and limit
  const requested = parseInt($('#numQuestions').value) || 20;
  const pool = [...defs, ...comps].slice(0, Math.max(10, requested*2));
  // ensure each question has 4 options; if ans != 0 ensure correct is present
  const questions = pool.map(q=>{
    if(!q.options || !Array.isArray(q.options)) q.options = pickDistractors('answer');
    if(q.options.length<4){
      while(q.options.length<4) q.options.push('â€”');
    }
    // shuffle options but keep correct as index 0 initially
    const opts = q.options.slice();
    // ensure the true answer exists and is at index 0
    // for generated questions we assume q.options[0] is the correct answer
    // shuffle
    const shuffled = opts.map((o,i)=>({o,i})).sort(()=>Math.random()-0.5).map(x=>x.o);
    const ansIndex = shuffled.indexOf(q.options[0]);
    return { question: q.question, options: shuffled, ans: ansIndex, hint: q.hint || '', context: q.context || '' };
  });

  // final trim
  return questions.slice(0, requested);
}

function escapeReg(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }

/* quick distractor generator (very naive) */
function pickDistractors(correct){
  const c = (''+correct).trim();
  const base = [
    c,
    c + ' (definition)',
    'An unrelated concept',
    'A similar term',
    'None of the above',
    'A common misconception'
  ];
  return base.slice(0,4);
}

/* =============================
   Quiz flow functions
   ============================= */
function startQuizWith(questions){
  App.questions = questions.slice();
  App.currentQuestions = questions.map(q => ({...q}));
  App.userAnswers = {};
  App.skipped = new Set();
  App.currentIndex = 0;
  App.score = 0;
  App.correctCount = 0;
  App.streak = 0;
  // UI
  $('#quizCard').style.display = 'block';
  $('#resultsCard').style.display = 'none';
  buildNavigator();
  loadQuestion(0);
  updateStats();
  showToast('Quiz started', `${questions.length} questions ready`, 'success');
}

function buildNavigator(){
  const grid = $('#questionGrid'); grid.innerHTML = '';
  App.currentQuestions.forEach((q,i)=>{
    const btn = create('button','qbtn', String(i+1));
    btn.style.border = 'none'; btn.style.margin = '4px'; btn.style.padding = '8px 10px'; btn.style.borderRadius = '8px';
    btn.addEventListener('click', ()=> loadQuestion(i));
    grid.appendChild(btn);
  });
  refreshNavigatorStates();
}

function refreshNavigatorStates(){
  const grid = $('#questionGrid');
  grid.childNodes.forEach((btn, idx)=>{
    btn.style.background = App.userAnswers[idx] !== undefined ? '#e7fbff' : '#f3f5ff';
    if(idx === App.currentIndex) btn.style.outline = '2px solid var(--primary)'; else btn.style.outline = 'none';
  });
}

function loadQuestion(i){
  if(i < 0 || i >= App.currentQuestions.length) return;
  App.currentIndex = i;
  const q = App.currentQuestions[i];
  $('#qIndex').textContent = `${i+1} / ${App.currentQuestions.length}`;
  $('#qTitle').textContent = `Question ${i+1}`;
  $('#qText').textContent = q.question;
  const opts = $('#options'); opts.innerHTML = '';
  q.options.forEach((o,idx)=>{
    const opt = create('div','option');
    const letter = create('div','letter', String.fromCharCode(65+idx));
    const span = create('div',null, o);
    opt.appendChild(letter); opt.appendChild(span);
    opt.addEventListener('click', ()=> selectAnswer(idx));
    opts.appendChild(opt);
  });
  $('#hint').style.display = 'none';
  if(App.userAnswers[i] !== undefined) showAnswerState(App.userAnswers[i]);
  refreshNavigatorStates();
  updateStats();
  resetQuestionTimer();
}

/* selecting answer */
function selectAnswer(choice){
  const i = App.currentIndex;
  if(App.userAnswers[i] !== undefined) return;
  App.userAnswers[i] = choice;
  const q = App.currentQuestions[i];
  const correct = (choice === q.ans);
  if(correct){
    App.correctCount++;
    App.streak++;
    App.score += 100 + Math.max(0, App.streak-1)*10;
    App.coins += 10;
    // streak milestones
    if(App.streak % 5 === 0){
      App.coins += 50; playSound('#coinSound'); showToast('Streak bonus', `+50 coins for ${App.streak} correct`, 'success');
    }
    playSound('#correctSound'); confettiBurst();
    showToast('Correct','Good job! +10 coins', 'success');
  } else {
    App.streak = 0;
    playSound('#incorrectSound');
    showToast('Incorrect','The correct answer is highlighted', 'error');
  }
  showAnswerState(choice);
  updateStats();
}

/* show answer states */
function showAnswerState(chosen){
  const q = App.currentQuestions[App.currentIndex];
  const opts = Array.from(document.querySelectorAll('#options .option'));
  opts.forEach((o, idx)=>{
    o.classList.remove('correct','incorrect','faded');
    if(idx === q.ans) o.classList.add('correct');
    if(idx === chosen && chosen !== q.ans) o.classList.add('incorrect');
    if(idx !== q.ans && idx !== chosen) o.classList.add('faded');
  });
}

/* navigation helpers */
function nextUnansweredOrNext(){
  const total = App.currentQuestions.length;
  for(let k=0;k<total;k++){
    if(App.userAnswers[k] === undefined && !App.skipped.has(k)) return k;
  }
  return Math.min(App.currentIndex+1, total-1);
}

/* finish check */
function finishable(){
  return Object.keys(App.userAnswers).length + App.skipped.size >= App.currentQuestions.length;
}

/* Submit */
function submitQuiz(){
  stopAllTimers();
  const total = App.currentQuestions.length;
  const correct = App.correctCount;
  const percent = Math.round((correct/total)*100);
  const summary = `<div style="padding:12px;background:#f8fdff;border-radius:10px"><strong>Score:</strong> ${App.score} â€¢ <strong>Correct:</strong> ${correct}/${total} â€¢ <strong>${percent}%</strong></div>`;
  $('#resultsSummary').innerHTML = summary;

  // list
  const list = $('#resultsList'); list.innerHTML = '';
  App.currentQuestions.forEach((q,i)=>{
    const item = create('div','result-item');
    item.style.padding = '10px'; item.style.marginBottom = '8px'; item.style.borderRadius = '8px';
    const chosen = App.userAnswers[i];
    const isCorrect = chosen === q.ans;
    item.style.background = isCorrect ? '#eafffb' : '#fff4f7';
    item.innerHTML = `<div style="font-weight:700">${i+1}. ${q.question}</div>
      <div style="margin-top:6px;color:var(--muted)">${q.options.map((op,idx)=>`<div>${String.fromCharCode(65+idx)}. ${op}${idx===q.ans?' âœ…':''}${idx===chosen && !isCorrect?' âœ–':''}</div>`).join('')}</div>
      ${q.hint?'<div style="margin-top:6px;background:#f8f9fb;padding:8px;border-radius:6px"><strong>Hint:</strong> '+q.hint+'</div>':''}
    `;
    list.appendChild(item);
  });

  $('#resultsCard').style.display = 'block';
  $('#quizCard').style.display = 'none';
  showToast('Quiz submitted', `You scored ${percent}%`, percent>=80 ? 'success' : 'warning', 4000);
  if(percent>=80){ playSound('#winSound'); confettiBurst(); }
}

/* =============================
   Power-ups & shop
   ============================= */
function setPowerupDisplays(){
  $('#count5050').textContent = App.powerups['5050'];
  $('#countHint').textContent = App.powerups['hint'];
  $('#countSkip').textContent = App.powerups['skip'];
  $('#shopCoins').textContent = App.coins;
  $('#coins').textContent = App.coins;
  $('#coinsTop').textContent = App.coins;
  $('#score').textContent = App.score;
  $('#scoreTop').textContent = App.score;
}
function use5050(){
  if(App.powerups['5050']<=0){ showToast('No power-ups','You have none left','warning'); return; }
  const q = App.currentQuestions[App.currentIndex];
  const wrongs = [0,1,2,3].filter(i=>i!==q.ans);
  const toRemove = wrongs.sort(()=>Math.random()-0.5).slice(0,2);
  const opts = Array.from(document.querySelectorAll('#options .option'));
  toRemove.forEach(idx => { opts[idx].classList.add('faded'); opts[idx].style.pointerEvents = 'none'; });
  App.powerups['5050']--; setPowerupDisplays(); playSound('#powerSound'); showToast('50:50 used','Two wrong options removed','success');
}
function useHint(){
  if(App.powerups.hint<=0){ showToast('No hint','You have none left','warning'); return; }
  const q = App.currentQuestions[App.currentIndex];
  $('#hint').textContent = 'ðŸ’¡ Hint: ' + (q.hint || 'Review related study material.');
  $('#hint').style.display = 'block';
  App.powerups.hint--; setPowerupDisplays(); playSound('#powerSound');
}
function useSkip(){
  if(App.powerups.skip<=0){ showToast('No skip','You have none left','warning'); return; }
  App.skipped.add(App.currentIndex);
  App.powerups.skip--; setPowerupDisplays(); playSound('#powerSound');
  const nxt = nextUnansweredOrNext();
  showToast('Skipped','Question skipped','warning',2000);
  loadQuestion(nxt);
}
$('.powerup#pu5050')?.addEventListener?.('click', use5050);
$('#pu5050')?.addEventListener?.('click', use5050);
$('#puHint')?.addEventListener?.('click', useHint);
$('#puSkip')?.addEventListener?.('click', useSkip);

$('#openShopBtn').addEventListener('click', ()=>{ $('#shopModal').classList.add('show'); setPowerupDisplays(); });
$('#closeShop').addEventListener('click', ()=>{ $('#shopModal').classList.remove('show'); });

document.querySelectorAll('.shopBuy').forEach(b=>{
  b.addEventListener('click', ()=> {
    const price = parseInt(b.dataset.price);
    const power = b.dataset.power;
    if(App.coins < price){ showToast('Not enough coins','Earn more by answering correctly','error'); return; }
    App.coins -= price;
    App.powerups[power] = (App.powerups[power]||0) + 1;
    setPowerupDisplays();
    showToast('Purchase successful', `You bought ${power}`, 'success');
    playSound('#coinSound');
    $('#shopModal').classList.remove('show');
  });
});

/* =============================
   Timer handling
   ============================= */
function startTimers(){
  stopAllTimers();
  if(App.timers.mode === 'none') return;
  if(App.timers.mode === 'quiz'){
    App.timers.quizRemaining = App.timers.quiz;
    App.timers.interval = setInterval(()=>{
      App.timers.quizRemaining--;
      $('#timerVal').textContent = formatTime(App.timers.quizRemaining);
      if(App.timers.quizRemaining<=0){ clearInterval(App.timers.interval); submitQuiz(); }
    },1000);
  } else if(App.timers.mode === 'question'){
    resetQuestionTimer();
  }
}
function resetQuestionTimer(){
  if(App.timers.mode !== 'question') return;
  App.timers.questionRemaining = App.timers.question;
  $('#timerVal').textContent = formatTime(App.timers.questionRemaining);
  if(App.timers.interval) clearInterval(App.timers.interval);
  App.timers.interval = setInterval(()=>{
    App.timers.questionRemaining--;
    $('#timerVal').textContent = formatTime(App.timers.questionRemaining);
    if(App.timers.questionRemaining<=0){
      clearInterval(App.timers.interval);
      // mark unanswered as wrong and move next
      App.userAnswers[App.currentIndex] = null;
      loadQuestion(nextUnansweredOrNext());
    }
  },1000);
}
function stopAllTimers(){ if(App.timers.interval) clearInterval(App.timers.interval); App.timers.interval = null; $('#timerVal').textContent = 'â€”'; }
function formatTime(sec){ if(sec==null) return 'â€”'; const m = Math.floor(sec/60); const s = sec%60; return `${m}:${s.toString().padStart(2,'0')}`; }

/* apply timers UI */
document.querySelectorAll('.timeropt').forEach(btn=>btn.addEventListener('click', ()=>{
  document.querySelectorAll('.timeropt').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  App.timers.mode = btn.dataset.mode;
}));
$('#applyTimers').addEventListener('click', ()=>{
  const qn = parseInt($('#quizTimerInput').value) || 300;
  const qq = parseInt($('#questionTimerInput').value) || 30;
  App.timers.quiz = qn; App.timers.question = qq;
  startTimers();
  showToast('Timers applied','Timer settings updated','success');
});

/* =============================
   Navigation buttons
   ============================= */
$('#nextBtn').addEventListener('click', ()=> {
  loadQuestion(Math.min(App.currentIndex+1, App.currentQuestions.length-1));
});
$('#prevBtn').addEventListener('click', ()=> {
  loadQuestion(Math.max(App.currentIndex-1, 0));
});
$('#submitBtn').addEventListener('click', ()=> {
  if(!finishable()){
    if(!confirm('Some questions are unanswered. Submit anyway?')) return;
  }
  submitQuiz();
});

/* =============================
   Save & load quizzes (localStorage)
   ============================= */
function saveQuizLocally(title, category){
  const data = {
    id: 'q_' + Date.now(),
    title,
    category,
    file: App.pdfFileName,
    questions: App.currentQuestions,
    created: new Date().toISOString()
  };
  const list = JSON.parse(localStorage.getItem('pdf_quizzes')||'[]');
  list.push(data);
  localStorage.setItem('pdf_quizzes', JSON.stringify(list));
  $('#saveModal').classList.remove('show');
  showToast('Saved','Quiz saved locally','success');
  loadSavedQuizzes();
}
function loadSavedQuizzes(){
  const list = JSON.parse(localStorage.getItem('pdf_quizzes')||'[]');
  $('#quizList').innerHTML = '';
  if(list.length===0){
    $('#quizList').innerHTML = '<div style="text-align:center;color:var(--muted);padding:24px">No saved quizzes yet</div>';
    return;
  }
  list.forEach(s=>{
    const card = create('div',null);
    card.style.padding = '12px'; card.style.border = '1px solid #eef0f7'; card.style.borderRadius = '8px'; card.style.marginBottom = '8px';
    card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${s.title}</strong><div style="font-size:0.85rem;color:var(--muted)">${s.category} â€¢ ${new Date(s.created).toLocaleString()}</div></div>
      <div style="display:flex;flex-direction:column;gap:6px"><button class="btn btn-ghost loadSavedBtn" data-id="${s.id}">Load</button><button class="btn btn-ghost delSavedBtn" data-id="${s.id}">Delete</button></div></div>`;
    $('#quizList').appendChild(card);
  });
  document.querySelectorAll('.loadSavedBtn').forEach(b=>b.addEventListener('click', ()=>{
    const id = b.dataset.id;
    const list = JSON.parse(localStorage.getItem('pdf_quizzes')||'[]');
    const found = list.find(x=>x.id===id);
    if(found){ App.currentQuestions = found.questions.map(q=>({...q})); startQuizWith(App.currentQuestions); }
  }));
  document.querySelectorAll('.delSavedBtn').forEach(b=>b.addEventListener('click', ()=>{
    const id = b.dataset.id;
    let list = JSON.parse(localStorage.getItem('pdf_quizzes')||'[]');
    list = list.filter(x=>x.id!==id);
    localStorage.setItem('pdf_quizzes', JSON.stringify(list));
    loadSavedQuizzes();
    showToast('Deleted','Saved quiz removed','success');
  }));
}
$('#saveQuizBtn').addEventListener('click', ()=> {
  if(!App.currentQuestions || App.currentQuestions.length===0){ showToast('No quiz','Generate or load a quiz first','error'); return; }
  $('#quizTitle').value = App.pdfFileName ? App.pdfFileName.replace('.pdf','') : 'My Quiz';
  $('#saveModal').classList.add('show');
});
$('#closeSave').addEventListener('click', ()=> $('#saveModal').classList.remove('show'));
$('#saveToLocal').addEventListener('click', ()=> {
  const title = $('#quizTitle').value.trim() || 'Untitled';
  const category = $('#quizCategory').value || 'General';
  saveQuizLocally(title, category);
});
$('#clearStorageBtn').addEventListener('click', ()=> {
  if(confirm('Clear all saved quizzes?')){ localStorage.removeItem('pdf_quizzes'); loadSavedQuizzes(); showToast('Cleared','Saved quizzes cleared','success'); }
});
$('#exportAllBtn').addEventListener('click', ()=> {
  const data = { questions: App.currentQuestions, exportedAt: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'quiz-export.json'; a.click(); URL.revokeObjectURL(url);
  showToast('Exported','Quiz data downloaded','success');
});

/* =============================
   UI binding for generate / build study
   ============================= */
$('#genBtn').addEventListener('click', ()=>{
  const questions = generateQuestionsFromText();
  if(!questions || questions.length===0){ showToast('No questions','Could not generate questions', 'error'); return; }
  startQuizWith(questions);
  startTimers();
});
$('#buildStudyBtn').addEventListener('click', buildChaptersFromText);

/* =============================
   Retry functions
   ============================= */
$('#retryAll').addEventListener('click', ()=> {
  App.currentQuestions = App.currentQuestions.map(q => ({...q}));
  startQuizWith(App.currentQuestions);
});
$('#retryWrong').addEventListener('click', ()=> {
  const wrongs = App.currentQuestions.filter((q,i)=> App.userAnswers[i] !== q.ans);
  if(wrongs.length===0){ showToast('No wrongs','All correct â€” great job!', 'success'); return; }
  startQuizWith(wrongs);
});
$('#exportResults').addEventListener('click', ()=> {
  const data = { score: App.score, correct: App.correctCount, total: App.currentQuestions.length, answers: App.userAnswers };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download = 'quiz-results.json'; a.click();
  showToast('Exported','Results downloaded','success');
});

/* =============================
   Confetti (lightweight)
   ============================= */
function confettiBurst(){
  const container = $('#confetti');
  const colors = ['#4361ee','#3a0ca3','#4cc9f0','#f72585','#fca311'];
  for(let i=0;i<40;i++){
    const el = document.createElement('div');
    el.className = 'confetti';
    el.style.position = 'absolute';
    el.style.top = '-10%';
    el.style.left = Math.random()*100 + '%';
    el.style.width = '8px'; el.style.height = '12px';
    el.style.background = colors[Math.floor(Math.random()*colors.length)];
    el.style.opacity = '0.95';
    el.style.transform = `rotate(${Math.random()*360}deg)`;
    el.style.borderRadius = '2px';
    el.style.transition = 'transform 2.5s linear, top 2.5s linear, opacity 2.5s linear';
    container.appendChild(el);
    setTimeout(()=> {
      el.style.top = (100 + Math.random()*60) + 'vh';
      el.style.transform = `translateY(0) rotate(${Math.random()*1080}deg)`;
      el.style.opacity = '0';
    }, 20 + i*10);
    setTimeout(()=> el.remove(), 2800 + Math.random()*600);
  }
}

/* =============================
   Initialization
   ============================= */
function init(){
  // load saved quizzes summary
  loadSavedQuizzes();
  setPowerupDisplays();

  // tab navigation
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.dataset.tab;
      // show/hide main sections
      $('#uploadCard').style.display = tab==='upload' ? 'block' : 'none';
      $('#configureCard').style.display = tab==='configure' ? 'block' : 'none';
      $('#studyCard').style.display = tab==='study' ? 'block' : 'none';
      $('#quizCard').style.display = tab==='quiz' ? 'block' : 'none';
      $('#resultsCard').style.display = tab==='results' ? 'block' : 'none';
      $('#savedCard').style.display = tab==='saved' ? 'block' : 'none';
    });
  });

  // bind powerup UI elements
  $('#pu5050').addEventListener('click', use5050);
  $('#puHint').addEventListener('click', useHint);
  $('#puSkip').addEventListener('click', useSkip);

  // shop modal close already bound
}
init();

</script>
</body>
</html>