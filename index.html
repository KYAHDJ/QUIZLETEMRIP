
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QuizPro ‚Äî PDF to Quiz</title>

<!-- TailwindCSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Icons -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
/* Sidebar slide-out */
#sidebarNav {
  transform: translateX(-100%);
  transition: transform .35s ease;
}
#sidebarNav.active {
  transform: translateX(0);
}
.option-correct { background:#dcfce7 !important; border-color:#16a34a !important; }
.option-wrong { background:#fee2e2 !important; border-color:#ef4444 !important; }
.fade { opacity:.35; pointer-events:none; }
</style>

<!-- Force Browser (Block Messenger / FB / IG in-app) -->
<script>
(function(){
  const ua = navigator.userAgent || "";
  const inApp = /FBAN|FBAV|Instagram|Messenger/i.test(ua);
  const params = new URLSearchParams(location.search);
  if(inApp && !params.get("external")){
    const newUrl = location.origin + location.pathname + "?external=1";
    try { window.location.href = newUrl; return; } catch(e){}
  }
})();
</script>

</head>

<body class="bg-gray-50 text-gray-800">

<!-- In-App Browser Block Overlay -->
<div id="inAppBlock" class="fixed inset-0 bg-white z-50 hidden p-8 flex items-center justify-center text-center">
  <div>
    <h1 class="text-2xl font-bold mb-4">‚ö†Ô∏è Unsupported Viewer</h1>
    <p class="text-gray-600 mb-4">
      This page cannot run inside Messenger or Facebook's internal browser.<br>
      Please open it in:
    </p>
    <div class="font-semibold text-lg">Chrome ‚Ä¢ Safari ‚Ä¢ Default Browser</div>
    <button id="openExternalBtn"
      class="mt-6 px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold">
      Open in Browser
    </button>
  </div>
</div>

<script>
(function(){
  const ua = navigator.userAgent || "";
  const inApp = /FBAN|FBAV|Instagram|Messenger/i.test(ua);
  const params = new URLSearchParams(location.search);
  if(inApp && params.get("external")){
    // Still in in-app browser ‚Üí block
    document.getElementById("inAppBlock").classList.remove("hidden");
    document.getElementById("openExternalBtn").onclick = ()=>{
  try {
    // Android Chrome
    window.location.href = "intent://" + window.location.host + window.location.pathname + "#Intent;scheme=https;package=com.android.chrome;end";
  } catch(err){
    alert("Please open this page in Chrome using ‚Ä¢‚Ä¢‚Ä¢ menu ‚Üí Open in browser.");
  }
};
  }
})();
</script>

<!-- HEADER -->
<header class="bg-white shadow sticky top-0 z-40">
  <div class="max-w-6xl mx-auto flex items-center justify-between p-3">
    <div class="flex items-center gap-3">
      <button id="openNav" class="text-2xl text-gray-700 md:hidden">
        <i class="fa-solid fa-bars"></i>
      </button>
      <div class="bg-gradient-to-tr from-blue-600 to-purple-600 p-3 text-white rounded-lg">
        <i class="fa-solid fa-bolt"></i>
      </div>
      <div>
        <div class="font-bold text-lg">QuizPro ‚Äî PDF to Quiz</div>
        <div class="text-xs text-gray-500">Professional ‚Ä¢ Responsive ‚Ä¢ Smart</div>
      </div>
    </div>

    <div class="px-3 py-2 bg-white border rounded-full flex items-center gap-2">
      <i class="fa-solid fa-coins text-yellow-500"></i>
      <span id="coinsTop">100</span>
    </div>
  </div>
</header>

<!-- Slide-Out Sidebar Navigator -->
<aside id="sidebarNav" class="fixed top-0 left-0 bg-white shadow-lg w-64 h-full z-50 p-4 overflow-y-auto">
  <div class="flex justify-between items-center mb-3">
    <h3 class="font-semibold">Navigator</h3>
    <button id="closeNav" class="text-gray-500"><i class="fa-solid fa-xmark"></i></button>
  </div>

  <div id="questionGrid" class="grid grid-cols-5 gap-2 mb-4"></div>

  <button id="saveQuizBtn" class="w-full px-3 py-2 bg-blue-600 text-white rounded-lg mb-2">
    <i class="fa-solid fa-save"></i> Save Quiz
  </button>
  <button id="exportAllBtn" class="w-full px-3 py-2 bg-gray-100 rounded-lg mb-2">
    <i class="fa-solid fa-download"></i> Export Seeds
  </button>
  <button id="clearStorageBtn" class="w-full px-3 py-2 bg-red-100 rounded-lg">
    <i class="fa-solid fa-trash"></i> Clear Saved
  </button>

  <p class="text-xs text-gray-500 mt-4">Saved locally</p>
</aside>

<script>
document.getElementById("openNav").onclick = ()=> {
  document.getElementById("sidebarNav").classList.add("active");
};
document.getElementById("closeNav").onclick = ()=> {
  document.getElementById("sidebarNav").classList.remove("active");
};
</script>

<!-- MAIN WRAPPER -->
<main class="max-w-6xl mx-auto grid md:grid-cols-[1fr_320px] md:gap-6 p-4">

  <!-- LEFT COLUMN -->
  <section>

    <!-- STATS -->
    <div class="grid grid-cols-3 sm:grid-cols-6 gap-3 mb-4">
      <div class="bg-white p-3 text-center rounded shadow">
        <div class="font-bold" id="currentQ">‚Äì</div><div class="text-xs text-gray-500">Current</div>
      </div>
      <div class="bg-white p-3 text-center rounded shadow">
        <div class="font-bold" id="score">0</div><div class="text-xs text-gray-500">Score</div>
      </div>
      <div class="bg-white p-3 text-center rounded shadow">
        <div class="font-bold" id="correctCount">0</div><div class="text-xs text-gray-500">Correct</div>
      </div>
      <div class="bg-white p-3 text-center rounded shadow">
        <div class="font-bold" id="streak">0</div><div class="text-xs text-gray-500">Streak</div>
      </div>
      <div class="bg-white p-3 text-center rounded shadow">
        <div class="font-bold" id="coins">100</div><div class="text-xs text-gray-500">Coins</div>
      </div>
      <div class="bg-white p-3 text-center rounded shadow">
        <div class="font-bold" id="timerVal">‚Äì</div><div class="text-xs text-gray-500">Timer</div>
      </div>
    </div>

    <!-- UPLOAD CARD -->
    <div id="uploadCard" class="bg-white rounded-xl shadow p-4 mb-4">
      <h2 class="font-semibold">Upload PDF</h2>
      <p class="text-sm text-gray-500">Drop a PDF or click Browse.</p>

      <div id="dropArea" class="mt-3 border-2 border-dashed border-blue-300 rounded-xl p-6 text-center cursor-pointer">
        <div class="text-gray-600">Drop PDF here</div>
        <button id="browseBtn" class="mt-3 px-4 py-2 bg-blue-600 text-white rounded-md">Browse</button>
        <input id="pdfInput" type="file" accept=".pdf" class="hidden" />
      </div>

      <div id="fileInfo" class="hidden mt-3 p-3 rounded bg-blue-50 flex justify-between">
        <div id="fileName" class="font-medium"></div>
        <div id="fileSize" class="text-sm text-gray-500"></div>
      </div>

      <div id="progressWrapper" class="hidden mt-3">
        <div class="h-2 bg-gray-200 rounded">
          <div id="progressBar" class="h-full bg-blue-600 rounded" style="width:0%"></div>
        </div>
        <div id="progressText" class="text-xs text-gray-500 mt-1">Processing‚Ä¶</div>
      </div>
    </div>

    <!-- CONFIGURE CARD -->
    <div id="configureCard" class="bg-white rounded-xl shadow p-4 mb-4">
      <h3 class="font-semibold">Configure Quiz</h3>

      <div class="grid sm:grid-cols-3 gap-3 mt-3">
        <div>
          <label class="text-sm font-medium">Questions</label>
          <select id="numQuestions" class="mt-1 w-full border rounded p-2"></select>
        </div>
        <div class="grid grid-cols-2 gap-3 mt-3">
  <div>
    <label class="text-sm font-medium">Per Question Timer (seconds)</label>
    <input id="questionTimerInput" class="mt-1 w-full border p-2 rounded" value="30" />
  </div>
  <div>
    <label class="text-sm font-medium">Full Quiz Timer (seconds)</label>
    <input id="quizTimerInput" class="mt-1 w-full border p-2 rounded" value="300" />
  </div>
</div>

<button id="applyTimers" class="mt-3 px-3 py-2 bg-gray-100 rounded">
  Apply Timers
</button>
        <div>
          <label class="text-sm font-medium">Difficulty</label>
          <select id="difficulty" class="mt-1 w-full border rounded p-2">
            <option value="mixed">Mixed</option>
            <option value="basic">Basic</option>
            <option value="intermediate" selected>Intermediate</option>
            <option value="advanced">Advanced</option>
          </select>
        </div>

        <div>
          <label class="text-sm font-medium">Focus keywords (comma)</label>
          <input id="focusAreas" class="mt-1 w-full border rounded p-2" placeholder="biology, taxation" />
        </div>
      </div>

      <div class="flex gap-3 mt-4">
        <button id="genBtn" class="px-4 py-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-md">
          Generate
        </button>

        <button id="buildStudyBtn" class="px-4 py-2 bg-gray-100 rounded-md">Study Preview</button>

        <div class="ml-auto text-sm text-gray-600">
          Seeds: <span id="seedCount">0</span>
        </div>
      </div>
    </div>

    <!-- QUIZ CARD -->
    <div id="quizCard" class="bg-white rounded-xl shadow p-4 mb-4 hidden">
      <div class="flex justify-between">
        <div>
          <h3 class="text-lg font-bold" id="qTitle"></h3>
          <div class="text-xs text-gray-500" id="qIndex"></div>
        </div>

        <div class="text-right text-xs text-gray-500">
          <label>Timer: </label>
          <select id="timerMode" class="border rounded p-1 text-xs">
            <option value="none">None</option>
            <option value="question" selected>Per Q</option>
            <option value="quiz">Quiz</option>
          </select>
        </div>
      </div>

      <div class="flex gap-3 mt-3">
        <button id="pu5050" class="px-3 py-2 bg-gray-100 rounded-md">50:50 <span id="count5050">3</span></button>
        <button id="puHint" class="px-3 py-2 bg-gray-100 rounded-md"><i class="fa-solid fa-lightbulb"></i> <span id="countHint">3</span></button>
        <button id="puSkip" class="px-3 py-2 bg-gray-100 rounded-md">Skip <span id="countSkip">2</span></button>
      </div>

      <div id="qText" class="mt-4 text-lg font-semibold"></div>

      <div id="options" class="grid gap-3 mt-4"></div>

      <div id="hint" class="hidden mt-3 p-3 bg-yellow-50 border rounded"></div>

      <div class="flex gap-3 mt-4">
        <button id="prevBtn" class="px-3 py-2 bg-gray-100 rounded-md">Prev</button>
        <button id="nextBtn" class="px-3 py-2 bg-gray-100 rounded-md">Next</button>
        <button id="submitBtn" class="ml-auto px-4 py-2 bg-blue-600 text-white rounded-md">Submit</button>
      </div>
    </div>





<!-- RESULTS CARD -->
    <div id="resultsCard" class="bg-white rounded-xl shadow p-4 mb-4 hidden">
      <h3 class="text-lg font-bold">Results</h3>
      <div id="resultsSummary" class="mt-2"></div>
      <div id="resultsList" class="mt-3 space-y-2"></div>

      <div class="flex gap-3 mt-4">
        <button id="retryWrong" class="px-3 py-2 bg-red-100 rounded-md">Retry Wrong</button>
        <button id="retryAll" class="px-3 py-2 bg-blue-100 rounded-md">Retry All</button>
        <button id="exportResults" class="px-3 py-2 bg-gray-100 rounded-md">Export Results</button>
      </div>
    </div>

    <!-- SAVED CARD -->
    <div id="savedCard" class="bg-white rounded-xl shadow p-4 mb-4 hidden">
      <h3 class="text-lg font-bold">Saved Quizzes</h3>
      <div id="quizList" class="mt-3 space-y-3"></div>
    </div>

  </section>

  <!-- RIGHT COLUMN (small controls) -->
  <aside class="hidden md:block">
    <div class="bg-white rounded-xl shadow p-4 sticky top-24">
      <h4 class="font-semibold mb-2">Controls</h4>
      <button id="openFull" class="w-full mb-2 px-3 py-2 bg-gray-100 rounded">Open Fullscreen</button>
      <button id="viewSavedBtn" class="w-full mb-2 px-3 py-2 bg-blue-50 rounded">View Saved</button>
      <button id="viewResultsBtn" class="w-full px-3 py-2 bg-blue-50 rounded">View Results</button>
    </div>
  </aside>

</main>

<!-- Study modal (professional term + definition) -->
<div id="studyModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black bg-opacity-40">
  <div class="bg-white rounded-lg max-w-4xl w-full p-4 max-h-[80vh] overflow-auto">
    <div class="flex justify-between items-center">
      <h3 class="font-semibold">Study Preview ‚Äî Terms & Definitions</h3>
      <button id="closeStudyModal" class="text-gray-500">Close</button>
    </div>
    <div id="studyContent" class="mt-3 space-y-4"></div>
  </div>
</div>

<!-- Shop & Save Modals (kept minimal) -->
<div id="shopModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black bg-opacity-40">
  <div class="bg-white rounded-lg p-4 max-w-md w-full">
    <div class="flex justify-between items-center">
      <h4 class="font-semibold">Store</h4>
      <button id="closeShop" class="text-gray-500">Close</button>
    </div>
    <div class="mt-3 space-y-3">
      <div class="flex justify-between items-center p-3 border rounded">
        <div><b>50:50</b><div class="text-sm text-gray-500">Remove two wrong options</div></div>
        <button class="shopBuy px-3 py-1 bg-blue-600 text-white rounded" data-power="5050" data-price="80">Buy 80</button>
      </div>
      <div class="flex justify-between items-center p-3 border rounded">
        <div><b>Hint</b><div class="text-sm text-gray-500">Reveal a hint</div></div>
        <button class="shopBuy px-3 py-1 bg-blue-600 text-white rounded" data-power="hint" data-price="60">Buy 60</button>
      </div>
      <div class="flex justify-between items-center p-3 border rounded">
        <div><b>Skip</b><div class="text-sm text-gray-500">Skip a question</div></div>
        <button class="shopBuy px-3 py-1 bg-blue-600 text-white rounded" data-power="skip" data-price="50">Buy 50</button>
      </div>
    </div>
  </div>
</div>

<div id="saveModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black bg-opacity-40">
  <div class="bg-white rounded-lg p-4 max-w-md w-full">
    <div class="flex justify-between items-center">
      <h4 class="font-semibold">Save Quiz</h4>
      <button id="closeSave" class="text-gray-500">Close</button>
    </div>

    <div class="mt-3 space-y-2">
      <label class="text-sm font-medium">Title</label>
      <input id="quizTitle" class="w-full border rounded p-2" placeholder="Quiz Title" />
      <label class="text-sm font-medium">Category</label>
      <select id="quizCategory" class="w-full border rounded p-2">
        <option>General</option><option>Education</option><option>Science</option><option>Other</option>
      </select>

      <div class="flex gap-2 mt-3">
        <button id="saveToLocal" class="px-3 py-2 bg-blue-600 text-white rounded">Save</button>
        <button id="cancelSave" class="px-3 py-2 bg-gray-100 rounded">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="fixed top-6 right-6 hidden bg-white rounded shadow px-4 py-2 z-50"></div>

<!-- Audio -->
<audio id="correctSound" src="https://www.soundjay.com/buttons/sounds/button-1.mp3" preload="auto"></audio>
<audio id="incorrectSound" src="https://www.soundjay.com/buttons/sounds/button-10.mp3" preload="auto"></audio>
<audio id="coinSound" src="https://www.soundjay.com/buttons/sounds/button-7.mp3" preload="auto"></audio>
<audio id="powerSound" src="https://www.soundjay.com/buttons/sounds/button-4.mp3" preload="auto"></audio>

<script>
/* ---------------------------
   Helpers & State (completes Part 1)
--------------------------- */
const $ = s => document.querySelector(s);
const el = (t, c, txt) => { const e = document.createElement(t); if(c) e.className = c; if(txt!==undefined) e.textContent = txt; return e; };

function toast(msg, ms=1600){
  const t = $('#toast'); t.textContent = msg; t.classList.remove('hidden');
  setTimeout(()=> t.classList.add('hidden'), ms);
}
function playSound(sel){ try{ const a = document.querySelector(sel); if(a){ a.currentTime=0; a.play().catch(()=>{}); } }catch(e){} }

/* ---------------------------
   Dropdown bug fix: ensure proper default populated
   Called after seeds built.
--------------------------- */
function ensureNumDropdown(defaultCount=10){
  const sel = $('#numQuestions');
  sel.innerHTML = '';
  const max = Math.max(1, Math.min(50, defaultCount));
  for(let i = max; i>=1; i--){
    const o = document.createElement('option'); o.value = i; o.textContent = i;
    sel.appendChild(o);
  }
  sel.value = Math.min(10, max);
}

/* ---------------------------
   Seed/Question generation code (robust)
   Note: These functions mirror Part1 but finalize behavior here
--------------------------- */
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
function escapeReg(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }

function buildSeedsFromText(){
  const text = (window.App && App.pdfText) ? App.pdfText : '';
  if(!text || text.trim().length < 20){ toast('No text found in PDF'); return; }
  // improved splitting and scoring
  const raw = text.replace(/\s+/g,' ').split(/(?<=[.?!])\s+/).map(s=>s.trim()).filter(s=>s.length>30);
  const patterns = [/\b(is|are|refers to|defined as|consists of|composed of)\b/i, /:\s/, /\b(e\.g\.|for example|such as)\b/i];
  let seeds = raw.filter(s => patterns.some(p=>p.test(s)));
  if(seeds.length < 12) seeds = seeds.concat(raw.slice(0,200));
  // dedupe
  const seen = new Set(); const unique = [];
  for(const s of seeds){
    const k = s.toLowerCase().replace(/[^a-z0-9 ]+/g,'').slice(0,120);
    if(!seen.has(k)){ seen.add(k); unique.push(s); }
  }
  App.seeds = unique;
  $('#seedCount').textContent = App.seeds.length;
  rebuildNumDropdown(App.seeds.length);
}

/* rebuildNumDropdown (reliable) */
function rebuildNumDropdown(max){
  const sel = $('#numQuestions');
  sel.innerHTML = '';
  max = Math.max(1, Math.min(100, Math.floor(max)));
  const limit = Math.min(50, max);
  for(let i=limit; i>=1; i--){
    const o = document.createElement('option'); o.value = i; o.textContent = i;
    sel.appendChild(o);
  }
  // choose sensible default
  sel.value = Math.min(10, limit);
}

/* Generate questions */
function generateQuestionsFromSeeds(requested, focusArr, difficulty){
  requested = Math.max(1, parseInt(requested) || 10);
  focusArr = (focusArr || []).map(s=>s.trim()).filter(Boolean).map(s=>s.toLowerCase());
  const avail = App.seeds.slice();
  const out = [];
  const used = new Set();

  function pickKeyWord(sentence){
    const words = sentence.split(/\s+/).map(w=>w.replace(/[^a-zA-Z]+/g,'')).filter(Boolean);
    const candidates = words.filter(w=> w.length>4 && /^[A-Za-z]+$/.test(w) && !/^(the|this|that|there|which|where)$/i.test(w));
    if(candidates.length===0) return null;
    // prefer focus
    for(const fk of focusArr){
      const match = candidates.find(c => c.toLowerCase().includes(fk));
      if(match) return match;
    }
    // prefer capitalized
    const cap = candidates.find(c => /^[A-Z]/.test(c));
    if(cap) return cap;
    candidates.sort((a,b)=> b.length - a.length);
    return candidates[0];
  }

  function genDistractors(correct, sentence){
    const base = [];
    const words = sentence.split(/\s+/).map(w=>w.replace(/[^a-zA-Z]+/g,'')).filter(w=>w.length>3 && w.toLowerCase() !== correct.toLowerCase());
    for(const w of words){
      if(base.length>=3) break;
      if(!base.includes(w)) base.push(w);
    }
    if(base.length < 3){
      base.push(correct + ' (alt)');
      base.push('Another concept');
      base.push('A common alternative');
    }
    return [...new Set(base)].slice(0,3);
  }

  while(out.length < requested && avail.length > 0){
    const idx = Math.floor(Math.random()*Math.min(12, avail.length));
    const seed = avail.splice(idx,1)[0];
    const keyword = pickKeyWord(seed);
    if(!keyword) continue;
    const qtext = seed.replace(new RegExp(`\\b${escapeReg(keyword)}\\b`, 'i'), '_____');
    const distractors = genDistractors(keyword, seed);
    const options = shuffle([keyword, ...distractors]).slice(0,4);
    const ans = options.findIndex(o=> o === keyword);
    const norm = qtext.toLowerCase().replace(/[^a-z0-9 ]+/g,'').slice(0,120);
    if(used.has(norm)) continue;
    used.add(norm);
    out.push({question: qtext, options, ans, hint: `Key: ${keyword}`, context: seed});
  }
  return out;
}

/* ---------------------------
   Full JS: connect events (completes behavior)
--------------------------- */

/* Initialize App state */
window.App = {
  pdfText: '',
  seeds: [],
  questions: [],
  userAnswers: {},
  skipped: new Set(),
  currentIndex: 0,
  score: 0,
  correctCount: 0,
  streak: 0,
  coins: 100,
  powerups: { '5050': 3, hint: 3, skip: 2 },
  timers: { mode: 'question', quiz: 300, question: 30, interval: null, quizRemaining: null, questionRemaining: null }
};

/* Wire upload */
$('#browseBtn').addEventListener('click', ()=> $('#pdfInput').click());
$('#pdfInput').addEventListener('change', e => { if(e.target.files[0]) loadPDF(e.target.files[0]); });

['dragenter','dragover'].forEach(ev => $('#dropArea').addEventListener(ev, e=>{ e.preventDefault(); $('#dropArea').classList.add('bg-blue-100'); }));
['dragleave','drop'].forEach(ev => $('#dropArea').addEventListener(ev, e=>{ e.preventDefault(); $('#dropArea').classList.remove('bg-blue-100'); }));
$('#dropArea').addEventListener('drop', e => { e.preventDefault(); const f = e.dataTransfer.files && e.dataTransfer.files[0]; if(f && f.type==='application/pdf') loadPDF(f); else toast('Please drop a PDF'); });

async function loadPDF(file){
  $('#fileInfo').classList.remove('hidden');
  $('#fileName').textContent = file.name;
  $('#fileSize').textContent = Math.round(file.size/1024) + ' KB';
  $('#progressWrapper').classList.remove('hidden');
  $('#progressBar').style.width = '4%';
  $('#progressText').textContent = 'Reading...';

  try{
    const buffer = await file.arrayBuffer();
    const loadingTask = pdfjsLib.getDocument({data: buffer});
    const pdf = await loadingTask.promise;
    let allText = '';
    for(let i=1;i<=pdf.numPages;i++){
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      const pageText = content.items.map(it=>it.str).join(' ');
      allText += '\n\n' + pageText;
      $('#progressBar').style.width = Math.round((i/pdf.numPages)*100) + '%';
      $('#progressText').textContent = `Extracting page ${i} / ${pdf.numPages}`;
      await new Promise(r=>setTimeout(r,10));
    }
    App.pdfText = allText;
    $('#progressBar').style.width = '100%';
    $('#progressText').textContent = 'Extraction complete';
    toast('PDF extracted');
    buildSeedsFromText();
  } catch(err){
    console.error(err); toast('Failed to read PDF'); $('#progressWrapper').classList.add('hidden');
  }
}

/* Fix: ensure dropdown is initially populated even before PDF */
rebuildNumDropdown(10); // default

/* Generate button */
$('#genBtn').addEventListener('click', ()=>{
  if(!App.seeds || App.seeds.length === 0){ buildSeedsFromText(); if(!App.seeds.length) return toast('No content to generate from'); }
  const desired = parseInt($('#numQuestions').value) || 10;
  const focus = ($('#focusAreas').value || '').split(',').map(s=>s.trim()).filter(Boolean);
  const difficulty = $('#difficulty').value || 'mixed';
  if(App.seeds.length < desired){
    rebuildNumDropdown(App.seeds.length);
    return toast(`Only ${App.seeds.length} seeds available. Dropdown adjusted.`);
  }
  const qs = generateQuestionsFromSeeds(desired, focus, difficulty);
  if(!qs || qs.length===0) return toast('Could not generate questions');
  if(qs.length < desired){ rebuildNumDropdown(qs.length); toast(`Only ${qs.length} questions could be formed`); }
  startQuizWith(qs);
});

/* Start quiz helper */
function startQuizWith(questions){
  App.questions = questions.slice();
  App.userAnswers = {};
  App.skipped = new Set();
  App.currentIndex = 0;
  App.score = 0; App.correctCount = 0; App.streak = 0;
  $('#quizCard').classList.remove('hidden');
  $('#resultsCard').classList.add('hidden');
  $('#savedCard').classList.add('hidden');
  buildNavigatorUI();
  loadQuestion(0);
  startTimers();
  updatePowerupUI();
  toast(`Quiz started (${questions.length})`);
}

/* Navigator UI builder */
function buildNavigatorUI(){
  const grid = $('#questionGrid'); grid.innerHTML = '';
  App.questions.forEach((q,i)=>{
    const b = el('button','p-2 rounded bg-gray-100 text-sm', String(i+1));
    b.addEventListener('click', ()=> { loadQuestion(i); document.getElementById('sidebarNav').classList.remove('active'); });
    grid.appendChild(b);
  });
  refreshNavigator();
}
function refreshNavigator(){
  const nodes = $('#questionGrid').children;

  [...nodes].forEach((n,i)=>{
    n.className = "p-2 rounded text-sm"; // reset

    if(i === App.currentIndex){
      n.classList.add("ring-2", "ring-blue-500");
    }

    if(App.userAnswers[i] === undefined){
      // unanswered
      n.classList.add("bg-gray-100");
    } else {
      const q = App.questions[i];
      const chosen = App.userAnswers[i];
      if(chosen === q.ans){
        n.classList.add("bg-green-200"); // correct
      } else {
        n.classList.add("bg-red-200"); // wrong
      }
    }
  });
}

/* Load question */
function loadQuestion(i){
  if(i<0||i>=App.questions.length) return;
  App.currentIndex = i;
  const q = App.questions[i];
  $('#qTitle').textContent = `Question ${i+1}`;
  $('#qIndex').textContent = `${i+1} / ${App.questions.length}`;
  $('#qText').textContent = q.question;
  const optBox = $('#options'); optBox.innerHTML = '';
  q.options.forEach((opt, idx)=>{
    const d = el('div','p-3 border rounded cursor-pointer bg-white', '');
    d.innerHTML = `<strong class="mr-2">${String.fromCharCode(65+idx)}.</strong> ${opt}`;
    d.addEventListener('click', ()=> selectAnswer(idx));
    optBox.appendChild(d);
  });
  $('#hint').classList.add('hidden');
  if(App.userAnswers[i] !== undefined) showAnswerState(App.userAnswers[i]);
  refreshNavigator();
  updatePowerupUI();
  resetQuestionTimer();
}

/* Select answer */
function selectAnswer(choice){
  const i = App.currentIndex; if(App.userAnswers[i] !== undefined) return;
  App.userAnswers[i] = choice;
  const q = App.questions[i];
  const correct = (choice === q.ans);
  if(correct){
    App.correctCount++; App.streak++; App.score += 100 + Math.max(0, App.streak-1) * 10; App.coins += 10; playSound('#correctSound'); toast('Correct +10 coins');
  } else { App.streak = 0; playSound('#incorrectSound'); toast('Incorrect'); }
  showAnswerState(choice);
  refreshNavigator();
  updatePowerupUI();
}

/* show answer state */
function showAnswerState(chosen){
  const q = App.questions[App.currentIndex];
  const opts = Array.from($('#options').children);
  opts.forEach((o, idx)=>{
    o.classList.remove('option-correct','option-wrong','fade');
    if(idx === q.ans) o.classList.add('option-correct');
    if(idx === chosen && chosen !== q.ans) o.classList.add('option-wrong');
    if(idx !== q.ans && idx !== chosen) o.classList.add('fade');
  });
}

/* next/prev/submit */
$('#nextBtn').addEventListener('click', ()=> loadQuestion(Math.min(App.currentIndex+1, App.questions.length-1)));
$('#prevBtn').addEventListener('click', ()=> loadQuestion(Math.max(App.currentIndex-1, 0)));
$('#submitBtn').addEventListener('click', ()=> {
  if(Object.keys(App.userAnswers).length < App.questions.length && !confirm('Some unanswered. Submit anyway?')) return;
  submitQuiz();
});

/* submit quiz */
function submitQuiz(){
  stopAllTimers();
  const total = App.questions.length;
  const correct = App.correctCount;
  const percent = Math.round((correct/total)*100);
  $('#resultsSummary').innerHTML = `<div class="p-3 bg-blue-50 rounded"><strong>Score:</strong> ${App.score} ‚Ä¢ <strong>Correct:</strong> ${correct}/${total} ‚Ä¢ <strong>${percent}%</strong></div>`;
  const list = $('#resultsList'); list.innerHTML = '';
  App.questions.forEach((q,i)=>{
    const chosen = App.userAnswers[i];
    const isCorrect = chosen === q.ans;
    const item = el('div','p-3 rounded', '');
    item.classList.add(isCorrect ? 'bg-green-50' : 'bg-red-50');
    item.innerHTML = `<div class="font-semibold">${i+1}. ${q.question}</div>
      <div class="text-sm text-gray-700 mt-2">${q.options.map((op,idx)=>`<div>${String.fromCharCode(65+idx)}. ${op} ${idx===q.ans?'‚úÖ':''} ${idx===chosen && !isCorrect?'‚ùå':''}</div>`).join('')}</div>
      ${q.hint ? `<div class="mt-2 text-xs text-gray-600 p-2 bg-gray-100 rounded">${q.hint}</div>` : ''}`;
    list.appendChild(item);
  });
  $('#quizCard').classList.add('hidden');
  $('#resultsCard').classList.remove('hidden');
  if(percent >= 80){ playSound('#powerSound'); confettiBurst(); toast('Great job!'); }
}

/* powerups */
$('#pu5050').addEventListener('click', ()=>{
  if(App.powerups['5050'] <= 0){ toast('No 50:50 left'); return; }
  const q = App.questions[App.currentIndex];
  const opts = Array.from($('#options').children);
  const wrongs = opts.map((o,i)=>i).filter(i=> i !== q.ans);
  shuffle(wrongs).slice(0,2).forEach(i=>{ opts[i].classList.add('fade'); opts[i].onclick = null; });
  App.powerups['5050']--; updatePowerupUI(); playSound('#powerSound');
});
$('#puHint').addEventListener('click', ()=>{
  if(App.powerups.hint <= 0){ toast('No hints left'); return; }
  $('#hint').textContent = 'üí° ' + (App.questions[App.currentIndex].hint || 'Review the context');
  $('#hint').classList.remove('hidden'); App.powerups.hint--; updatePowerupUI(); playSound('#powerSound');
});
$('#puSkip').addEventListener('click', ()=>{
  if(App.powerups.skip <= 0){ toast('No skips left'); return; }
  App.skipped.add(App.currentIndex); App.powerups.skip--; updatePowerupUI(); loadQuestion(Math.min(App.currentIndex+1, App.questions.length-1));
});
function updatePowerupUI(){ $('#count5050').textContent = App.powerups['5050']; $('#countHint').textContent = App.powerups['hint']; $('#countSkip').textContent = App.powerups['skip']; $('#coins').textContent = App.coins; $('#coinsTop').textContent = App.coins; $('#score').textContent = App.score; $('#correctCount').textContent = App.correctCount; $('#streak').textContent = App.streak; $('#currentQ').textContent = App.currentIndex+1 || '‚Äî'; }

/* shop */
$('#coinsTop').addEventListener('click', ()=> $('#shopModal').classList.remove('hidden'));
$('#closeShop').addEventListener('click', ()=> $('#shopModal').classList.add('hidden'));
document.querySelectorAll('.shopBuy').forEach(b=>{
  b.addEventListener('click', ()=>{
    const price = parseInt(b.dataset.price); const power = b.dataset.power;
    if(App.coins < price){ toast('Not enough coins'); return; }
    App.coins -= price; App.powerups[power] = (App.powerups[power]||0) + 1; updatePowerupUI(); $('#shopModal').classList.add('hidden'); playSound('#coinSound'); toast('Bought');
  });
});

/* timers */
$('#applyTimers').addEventListener('click', ()=>{
  App.timers.mode = $('#timerMode').value;
  App.timers.question = Math.max(5, parseInt($('#questionTimerInput') ? $('#questionTimerInput').value : 30) || 30);
  App.timers.quiz = Math.max(10, parseInt($('#quizTimerInput') ? $('#quizTimerInput').value : 300) || 300);
  startTimers(); toast('Timers updated');
});
function startTimers(){
  stopAllTimers();
  if(App.timers.mode === 'none'){ $('#timerVal').textContent = '‚Äî'; return; }
  if(App.timers.mode === 'quiz'){
    App.timers.quizRemaining = App.timers.quiz;
    $('#timerVal').textContent = formatTime(App.timers.quizRemaining);
    App.timers.interval = setInterval(()=>{
      App.timers.quizRemaining--; $('#timerVal').textContent = formatTime(App.timers.quizRemaining);
      if(App.timers.quizRemaining <= 0){ clearInterval(App.timers.interval); submitQuiz(); }
    },1000);
  } else {
    resetQuestionTimer();
  }
}
function resetQuestionTimer(){
  if(App.timers.mode !== 'question') return;
  App.timers.questionRemaining = App.timers.question;
  $('#timerVal').textContent = formatTime(App.timers.questionRemaining);
  if(App.timers.interval) clearInterval(App.timers.interval);
  App.timers.interval = setInterval(()=>{
    App.timers.questionRemaining--; $('#timerVal').textContent = formatTime(App.timers.questionRemaining);
    if(App.timers.questionRemaining <= 0){ clearInterval(App.timers.interval); App.userAnswers[App.currentIndex] = null; loadQuestion(nextUnansweredOrNext()); }
  },1000);
}
function stopAllTimers(){ if(App.timers.interval) clearInterval(App.timers.interval); App.timers.interval = null; $('#timerVal').textContent = '‚Äî'; }
function formatTime(sec){ if(sec==null) return '‚Äî'; const m=Math.floor(sec/60); const s=sec%60; return `${m}:${s.toString().padStart(2,'0')}`; }
function nextUnansweredOrNext(){ for(let i=0;i<App.questions.length;i++) if(App.userAnswers[i]===undefined && !App.skipped.has(i)) return i; return Math.min(App.currentIndex+1, App.questions.length-1); }

/* confetti */
function confettiBurst(){
  const c = document.createElement('div'); c.style.position='fixed'; c.style.inset='0'; c.style.pointerEvents='none'; c.style.zIndex='9999'; document.body.appendChild(c);
  const colors = ['#4361ee','#3a0ca3','#4cc9f0','#f72585','#fca311'];
  for(let i=0;i<40;i++){
    const el = document.createElement('div'); el.style.position='absolute'; el.style.left=(Math.random()*100)+'%'; el.style.top='-10%'; el.style.width='8px'; el.style.height='12px'; el.style.background=colors[Math.floor(Math.random()*colors.length)]; el.style.opacity='0.95';
    el.style.transition='transform 2.6s linear, top 2.6s linear, opacity 2.6s linear'; c.appendChild(el);
    setTimeout(()=>{ el.style.top=(100+Math.random()*60)+'vh'; el.style.transform=`rotate(${Math.random()*1080}deg)`; el.style.opacity='0'; }, 30 + i*10);
    setTimeout(()=> el.remove(), 3300 + Math.random()*400);
  }
  setTimeout(()=> c.remove(), 3600);
}

/* Save/load/export */
$('#saveQuizBtn').addEventListener('click', ()=>{
  if(!App.questions || App.questions.length===0) return toast('No quiz to save');
  $('#quizTitle').value = App.pdfText ? 'Quiz from PDF' : 'My Quiz';
  $('#saveModal').classList.remove('hidden');
});
$('#closeSave').addEventListener('click', ()=> $('#saveModal').classList.add('hidden'));
$('#cancelSave').addEventListener('click', ()=> $('#saveModal').classList.add('hidden'));
$('#saveToLocal').addEventListener('click', ()=>{
  const title = $('#quizTitle').value.trim() || 'Untitled';
  const cat = $('#quizCategory').value || 'General';
  const data = { id: 'q_' + Date.now(), title, cat, questions: App.questions, created: new Date().toISOString() };
  const list = JSON.parse(localStorage.getItem('quizpro_saved') || '[]'); list.push(data); localStorage.setItem('quizpro_saved', JSON.stringify(list));
  $('#saveModal').classList.add('hidden'); toast('Saved'); loadSavedQuizzes();
});

function loadSavedQuizzes(){
  const list = JSON.parse(localStorage.getItem('quizpro_saved') || '[]');
  const box = $('#quizList');
  box.innerHTML = '';

  if(list.length === 0){
    box.innerHTML = '<div class="text-gray-500">No saved quizzes</div>';
    return;
  }

  list.forEach(item=>{
    const row = document.createElement('div');
    row.className = "p-3 border rounded bg-gray-50";

    row.innerHTML = `
      <div class="flex justify-between items-center">
        <div>
          <div class="font-semibold">${item.title}</div>
          <div class="text-xs text-gray-500">${new Date(item.created).toLocaleString()}</div>
        </div>
        <div class="flex gap-2">
          <button class="loadSaved px-3 py-1 bg-blue-100 rounded" data-id="${item.id}">Load</button>
          <button class="deleteSaved px-3 py-1 bg-red-100 rounded" data-id="${item.id}">Delete</button>
        </div>
      </div>
    `;

    box.appendChild(row);
  });

  // FIXED event binding
  box.querySelectorAll('.loadSaved').forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.dataset.id;
      const saved = JSON.parse(localStorage.getItem('quizpro_saved') || '[]');
      const quiz = saved.find(x=>x.id===id);
      if(!quiz){ toast('Quiz not found'); return; }

      startQuizWith(quiz.questions);
      $('#savedCard').classList.add('hidden');
    };
  });

  box.querySelectorAll('.deleteSaved').forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.dataset.id;
      let saved = JSON.parse(localStorage.getItem('quizpro_saved') || '[]');
      saved = saved.filter(x=>x.id!==id);
      localStorage.setItem('quizpro_saved', JSON.stringify(saved));
      toast('Deleted');
      loadSavedQuizzes();
    };
  });
}

/* export */
$('#exportAllBtn').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify({ seeds: App.seeds, exportedAt: new Date().toISOString() }, null, 2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'quiz-seeds.json'; a.click(); URL.revokeObjectURL(a.href); toast('Exported seeds');
});
$('#exportResults').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify({ score: App.score, correct: App.correctCount, answers: App.userAnswers, exportedAt: new Date().toISOString() }, null, 2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'quiz-results.json'; a.click(); URL.revokeObjectURL(a.href); toast('Exported results');
});

/* retry */
$('#retryAll').addEventListener('click', ()=> { if(!App.questions) return; startQuizWith(App.questions.map(q=>({...q}))); });
$('#retryWrong').addEventListener('click', ()=> {
  const wrongs = App.questions.filter((q,i)=> App.userAnswers[i] !== q.ans);
  if(!wrongs.length) return toast('No wrong items'); startQuizWith(wrongs);
});

/* Study preview: term -> description extraction */
$('#buildStudyBtn').addEventListener('click', ()=> {
  if(!App.pdfText){ toast('Upload a PDF first'); return; }

  const text = App.pdfText.replace(/\s+/g,' ');
  const sentences = text.split(/(?<=[.?!])\s+/);

  const terms = [];

  for(const s of sentences){
    // Pattern 1: ‚ÄúTerm is definition‚Äù
    let m = s.match(/^([A-Z][A-Za-z0-9 \-]{2,50})\s+(is|are|refers to|means|defined as|consists of)\s+(.*)/i);
    if(m) terms.push({term:m[1], def:m[3], context:s});
    // Pattern 2: ‚ÄúTerm: Definition‚Äù
    m = s.match(/^([A-Za-z0-9 \-]{2,80}):\s+(.*)/);
    if(m) terms.push({term:m[1], def:m[2], context:s});
    if(terms.length>=60) break;
  }

  // fallback
  if(terms.length===0){
    terms.push({term:"General Summary", def:text.slice(0,500)+"...", context:"Full PDF"});
  }

  const box = $('#studyContent');
  box.innerHTML = '';
  for(const t of terms){
    const row = document.createElement('div');
    row.className = "p-3 border rounded";
    row.innerHTML = `
      <div class="font-semibold">${t.term}</div>
      <div class="text-sm text-gray-700 mt-1">${t.def}</div>
    `;
    box.appendChild(row);
  }

  $('#studyModal').classList.remove('hidden');
});
$('#closeStudyModal').addEventListener('click', ()=> $('#studyModal').classList.add('hidden'));

/* Navigator menu on small screens: view saved/results buttons */
$('#viewSavedBtn').addEventListener('click', ()=> {
  $('#savedCard').classList.remove('hidden'); $('#quizCard').classList.add('hidden'); $('#resultsCard').classList.add('hidden');
  document.getElementById('sidebarNav').classList.remove('active');
  loadSavedQuizzes();
});
$('#viewResultsBtn').addEventListener('click', ()=> {
  $('#resultsCard').classList.remove('hidden'); $('#savedCard').classList.add('hidden'); $('#quizCard').classList.add('hidden');
  document.getElementById('sidebarNav').classList.remove('active');
});

/* Fullscreen */
$('#openFull').addEventListener('click', ()=> {
  try{
    if(document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
    else if(document.documentElement.webkitRequestFullscreen) document.documentElement.webkitRequestFullscreen();
    toast('Opened fullscreen');
  }catch(e){ toast('Fullscreen failed'); }
});

/* Initial load saved quizzes and defaults */
function initEverything(){
  loadSavedQuizzes();
  updatePowerupUI();
  rebuildNumDropdown(10);
  // Apply a small tick to ensure dropdown bug fixed after first PDF load too
  setTimeout(()=> { if($('#numQuestions').options.length === 0) rebuildNumDropdown(10); }, 200);
}
initEverything();

/* Fix: when user uploads PDF multiple times, dropdown updates correctly (handled by rebuildNumDropdown in buildSeedsFromText).
   Additionally ensure seeds are rebuilt whenever pdfText changes. */

</script>
</body>
</html>
