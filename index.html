<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>QuizPro ‚Äì PDF to Quiz Generator</title>

<!-- TailwindCSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Icons -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-thumb { background: #93c5fd; border-radius: 5px; }
.fade { opacity: .4; pointer-events: none; }
.option-correct { border-color: #22c55e !important; background: #dcfce7 !important; }
.option-wrong { border-color: #ef4444 !important; background: #fee2e2 !important; }
</style>
</head>

<body class="bg-gray-100 text-gray-800">

<!-- HEADER -->
<header class="w-full bg-white shadow sticky top-0 z-50">
  <div class="max-w-6xl mx-auto flex items-center justify-between p-4">
    <h1 class="text-2xl font-bold text-blue-600 flex items-center gap-2">
      <i class="fa-solid fa-bolt"></i> QuizPro
    </h1>

    <div class="flex items-center space-x-4">
      <div class="flex items-center gap-2 px-3 py-1 bg-blue-50 rounded-full border border-blue-200">
        <i class="fa-solid fa-coins text-yellow-500"></i>
        <span id="coinsTop" class="font-semibold">100</span>
      </div>
    </div>
  </div>
</header>

<!-- MAIN WRAPPER -->
<div class="max-w-6xl mx-auto p-4 flex flex-col md:flex-row gap-4">

  <!-- SIDEBAR -->
  <aside class="w-full md:w-64 bg-white rounded-xl shadow p-4 h-fit sticky top-20">
    <h2 class="font-bold text-lg mb-2">Navigation</h2>
    <div id="questionGrid" class="flex flex-wrap gap-2"></div>

    <div class="mt-4 space-y-2">
      <button id="saveQuizBtn" class="w-full py-2 bg-blue-100 hover:bg-blue-200 rounded-lg font-semibold">
        <i class="fa-solid fa-save"></i> Save Quiz
      </button>
      <button id="exportAllBtn" class="w-full py-2 bg-gray-100 hover:bg-gray-200 rounded-lg font-semibold">
        <i class="fa-solid fa-download"></i> Export Seeds
      </button>
      <button id="clearStorageBtn" class="w-full py-2 bg-red-100 hover:bg-red-200 rounded-lg font-semibold">
        <i class="fa-solid fa-trash"></i> Clear Saved
      </button>
    </div>
  </aside>

  <!-- MAIN -->
  <section class="flex-1 space-y-6">

    <!-- STATS -->
    <div class="grid grid-cols-2 md:grid-cols-6 gap-3">
      <div class="bg-white p-4 rounded-xl shadow text-center">
        <div class="text-xl font-bold" id="currentQ">‚Äì</div>
        <div class="text-gray-500 text-sm">Current</div>
      </div>

      <div class="bg-white p-4 rounded-xl shadow text-center">
        <div class="text-xl font-bold" id="score">0</div>
        <div class="text-gray-500 text-sm">Score</div>
      </div>

      <div class="bg-white p-4 rounded-xl shadow text-center">
        <div class="text-xl font-bold" id="correctCount">0</div>
        <div class="text-gray-500 text-sm">Correct</div>
      </div>

      <div class="bg-white p-4 rounded-xl shadow text-center">
        <div class="text-xl font-bold" id="streak">0</div>
        <div class="text-gray-500 text-sm">Streak</div>
      </div>

      <div class="bg-white p-4 rounded-xl shadow text-center">
        <div class="text-xl font-bold" id="coins">100</div>
        <div class="text-gray-500 text-sm">Coins</div>
      </div>

      <div class="bg-white p-4 rounded-xl shadow text-center">
        <div class="text-xl font-bold" id="timerVal">‚Äì</div>
        <div class="text-gray-500 text-sm">Timer</div>
      </div>
    </div>

    <!-- UPLOAD -->
    <div id="uploadCard" class="bg-white rounded-xl shadow p-5">
      <h2 class="text-xl font-bold mb-1">Upload PDF</h2>
      <p class="text-gray-500 mb-4">Extract text to generate optimized quiz questions.</p>

      <div id="dropArea" class="border-2 border-dashed border-blue-300 bg-blue-50 rounded-xl p-6 text-center cursor-pointer">
        <i class="fa-solid fa-file-pdf text-4xl text-blue-600"></i>
        <h3 class="font-semibold mt-2">Drop PDF here</h3>
        <button id="browseBtn" class="mt-3 px-4 py-2 bg-blue-600 text-white rounded-lg">Browse</button>
        <input type="file" id="pdfInput" accept=".pdf" class="hidden" />
      </div>

      <div id="fileInfo" class="hidden mt-3 p-3 bg-blue-100 rounded-lg flex justify-between">
        <span id="fileName" class="font-bold"></span>
        <span id="fileSize"></span>
      </div>

      <div id="progressWrapper" class="hidden mt-3">
        <div class="h-2 w-full bg-gray-200 rounded">
          <div id="progressBar" class="h-full bg-blue-500 rounded" style="width:0%"></div>
        </div>
        <div id="progressText" class="text-sm text-gray-500 mt-1">Processing‚Ä¶</div>
      </div>
    </div>

    <!-- CONFIG -->
    <div id="configureCard" class="bg-white rounded-xl shadow p-5">
      <h2 class="text-xl font-bold mb-3">Configure</h2>

      <div class="grid md:grid-cols-3 gap-4">

        <div>
          <label class="font-semibold">Questions</label>
          <select id="numQuestions" class="w-full mt-1 p-2 border rounded-lg">
            <option>5</option><option selected>10</option><option>20</option>
          </select>
        </div>

        <div>
          <label class="font-semibold">Difficulty</label>
          <select id="difficulty" class="w-full mt-1 p-2 border rounded-lg">
            <option>mixed</option><option>basic</option>
            <option selected>intermediate</option><option>advanced</option>
          </select>
        </div>

        <div>
          <label class="font-semibold">Focus Keywords</label>
          <input id="focusAreas" class="w-full mt-1 p-2 border rounded-lg" placeholder="comma separated" />
        </div>

      </div>

      <div class="flex items-center gap-4 mt-4">
        <button id="genBtn" class="px-5 py-2 bg-blue-600 text-white rounded-lg shadow">
          <i class="fa-solid fa-wand-magic-sparkles"></i> Generate
        </button>
        <div class="text-gray-500">Seeds: <b id="seedCount">0</b></div>
      </div>
    </div>

    <!-- QUIZ -->
    <div id="quizCard" class="hidden bg-white rounded-xl shadow p-5">

      <div class="flex items-center justify-between">
        <div>
          <h3 class="font-bold" id="qTitle">Question</h3>
          <p class="text-gray-500 text-sm" id="qIndex">0 / 0</p>
        </div>
      </div>

      <!-- Powerups -->
      <div class="flex gap-3 mt-4">
        <button id="pu5050" class="px-3 py-2 bg-gray-100 border rounded-xl">
          50:50 <span id="count5050" class="font-bold">3</span>
        </button>
        <button id="puHint" class="px-3 py-2 bg-gray-100 border rounded-xl">
          <i class="fa-solid fa-lightbulb"></i> <span id="countHint">3</span>
        </button>
        <button id="puSkip" class="px-3 py-2 bg-gray-100 border rounded-xl">
          Skip <span id="countSkip">2</span>
        </button>
      </div>

      <div id="qText" class="mt-5 text-lg font-semibold"></div>

      <div id="options" class="grid gap-3 mt-4"></div>
      <div id="hint" class="hidden mt-3 p-3 bg-yellow-50 border rounded-lg text-sm"></div>

      <div class="flex gap-3 mt-5">
        <button id="prevBtn" class="px-4 py-2 bg-gray-200 rounded-lg">Prev</button>
        <button id="nextBtn" class="px-4 py-2 bg-gray-200 rounded-lg">Next</button>
        <button id="submitBtn" class="ml-auto px-5 py-2 bg-blue-600 text-white rounded-lg">Submit</button>
      </div>

    </div>

    <!-- RESULTS -->
    <div id="resultsCard" class="hidden bg-white rounded-xl shadow p-5">
      <h2 class="text-xl font-bold mb-3">Results</h2>
      <div id="resultsSummary" class="mb-4"></div>
      <div id="resultsList" class="space-y-3"></div>

      <div class="flex gap-3 mt-4">
        <button id="retryWrong" class="px-4 py-2 bg-red-100 rounded-lg">Retry Wrong</button>
        <button id="retryAll" class="px-4 py-2 bg-blue-100 rounded-lg">Retry All</button>
        <button id="exportResults" class="px-4 py-2 bg-gray-200 rounded-lg">Export</button>
      </div>
    </div>

    <!-- SAVED -->
    <div id="savedCard" class="hidden bg-white rounded-xl shadow p-5">
      <h2 class="text-xl font-bold mb-3">Saved Quizzes</h2>
      <div id="quizList" class="space-y-3"></div>
    </div>

  </section>
</div>

<!-- TOAST -->
<div id="toast" class="fixed top-4 right-4 hidden bg-white shadow-lg rounded-lg px-4 py-2 border">
  <span id="toastText"></span>
</div>

<!-- AUDIO -->
<audio id="correctSound" src="https://www.soundjay.com/buttons/sounds/button-1.mp3"></audio>
<audio id="incorrectSound" src="https://www.soundjay.com/buttons/sounds/button-10.mp3"></audio>
<audio id="coinSound" src="https://www.soundjay.com/buttons/sounds/button-7.mp3"></audio>
<audio id="powerSound" src="https://www.soundjay.com/buttons/sounds/button-4.mp3"></audio>

<script>
/* ============================================================
   STATE
============================================================ */
const App = {
  pdfText: "",
  seeds: [],
  questions: [],
  userAnswers: {},
  skipped: new Set(),
  currentIndex: 0,
  score: 0,
  correctCount: 0,
  streak: 0,
  coins: 100,
  powerups: { "5050": 3, hint: 3, skip: 2 }
};

/* ============================================================
   UTILITIES
============================================================ */
const $ = (s) => document.querySelector(s);
function toast(msg) {
  $("#toastText").textContent = msg;
  $("#toast").classList.remove("hidden");
  setTimeout(() => $("#toast").classList.add("hidden"), 1800);
}
function play(id) {
  const el = $(id);
  if (el) { el.currentTime = 0; el.play().catch(()=>{}); }
}

/* ============================================================
   PDF UPLOAD
============================================================ */
$("#browseBtn").onclick = () => $("#pdfInput").click();
$("#pdfInput").onchange = (e) => loadPDF(e.target.files[0]);

["dragenter","dragover"].forEach(ev=>{
  $("#dropArea").addEventListener(ev, e=>{
    e.preventDefault(); e.stopPropagation();
    $("#dropArea").classList.add("bg-blue-100");
  });
});
["dragleave","drop"].forEach(ev=>{
  $("#dropArea").addEventListener(ev, e=>{
    e.preventDefault(); $("#dropArea").classList.remove("bg-blue-100");
  });
});
$("#dropArea").ondrop = (e)=>{
  const f = e.dataTransfer.files[0];
  if (f?.type === "application/pdf") loadPDF(f);
  else toast("Not a PDF");
};

async function loadPDF(file) {
  $("#fileInfo").classList.remove("hidden");
  $("#fileName").textContent = file.name;
  $("#fileSize").textContent = Math.round(file.size/1024)+" KB";

  $("#progressWrapper").classList.remove("hidden");
  $("#progressBar").style.width = "5%";

  const buffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data:buffer}).promise;

  let text = "";
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    text += content.items.map(it => it.str).join(" ") + "\n";
    $("#progressBar").style.width = Math.round((i/pdf.numPages)*100)+"%";
  }

  App.pdfText = text;
  toast("PDF Loaded");
  extractSeeds();
}

/* ============================================================
   SMART SEED EXTRACTION
============================================================ */
function extractSeeds() {
  const text = App.pdfText.replace(/\s+/g," ");
  const raw = text.split(/(?<=[.?!])\s+/).filter(s=>s.length>30);

  const keywords = ["is","are","refers to","defined as","consists of","because","therefore"];

  let seeds = raw.filter(s => keywords.some(k=>s.toLowerCase().includes(k)));

  if (seeds.length < 10)
    seeds = seeds.concat(raw.slice(0, 50));

  seeds = [...new Set(seeds)];

  App.seeds = seeds;
  $("#seedCount").textContent = seeds.length;

  updateDropdown(seeds.length);
}

/* ============================================================
   GENERATE QUESTIONS
============================================================ */
function generateQuestions(n, focus=[]) {

  const out = [];
  const used = new Set();

  function pickWord(s) {
    const words = s.split(" ").filter(w=>w.length>4);
    if (focus?.length) {
      for (const f of focus) {
        const hit = words.find(w=>w.toLowerCase().includes(f.toLowerCase()));
        if (hit) return hit;
      }
    }
    return words.sort((a,b)=>b.length-a.length)[0];
  }

  function distractors(word) {
    const base = [
      "Not related to "+word,
      word+" (incorrect form)",
      "Another concept"
    ];
    return base;
  }

  for (const s of App.seeds) {
    if (out.length >= n) break;
    const key = pickWord(s);
    if (!key) continue;

    const qtext = s.replace(new RegExp(key,"i"), "_____");
    const choices = [key, ...distractors(key)].slice(0,4);
    shuffle(choices);

    const id = qtext.toLowerCase().slice(0,50);
    if (used.has(id)) continue;

    used.add(id);
    out.push({
      question: qtext,
      options: choices,
      ans: choices.indexOf(key),
      context: s,
      hint: "Related to: "+key
    });
  }

  return out;
}
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } }

/* ============================================================
   START QUIZ
============================================================ */
$("#genBtn").onclick = () => {
  if (!App.seeds.length) return toast("Upload PDF first");

  const n = parseInt($("#numQuestions").value);
  const focus = $("#focusAreas").value.split(",").map(s=>s.trim()).filter(Boolean);

  if (App.seeds.length < n) {
    updateDropdown(App.seeds.length);
    return toast("Limited seeds. Dropdown adjusted.");
  }

  App.questions = generateQuestions(n, focus);
  App.userAnswers = {};
  App.skipped = new Set();
  App.currentIndex = 0;
  App.correctCount = 0;
  App.score = 0;
  App.streak = 0;

  $("#quizCard").classList.remove("hidden");
  $("#resultsCard").classList.add("hidden");

  renderNavigator();
  loadQuestion(0);
  updateStats();
};

/* ============================================================
   NAVIGATION + DISPLAY
============================================================ */
function renderNavigator() {
  const g = $("#questionGrid");
  g.innerHTML = "";
  App.questions.forEach((q, i) => {
    const b = document.createElement("button");
    b.className = "w-9 h-9 rounded-lg bg-gray-100";
    b.textContent = i+1;
    b.onclick = ()=> loadQuestion(i);
    g.appendChild(b);
  });
}
function updateNav() {
  const children = $("#questionGrid").children;
  [...children].forEach((c,i)=>{
    c.className = "w-9 h-9 rounded-lg border " + 
      (i === App.currentIndex ? "bg-blue-100 border-blue-500" :
      App.userAnswers[i] !== undefined ? "bg-green-100 border-green-500" :
      "bg-gray-100 border-gray-300");
  });
}

function loadQuestion(i) {
  App.currentIndex = i;
  const q = App.questions[i];

  $("#qTitle").textContent = "Question "+(i+1);
  $("#qIndex").textContent = `${i+1} / ${App.questions.length}`;
  $("#qText").textContent = q.question;

  const optBox = $("#options");
  optBox.innerHTML = "";

  q.options.forEach((o, idx)=>{
    const div = document.createElement("div");
    div.className = "p-3 border rounded-xl bg-white cursor-pointer hover:bg-blue-50";
    div.innerHTML = `<b>${String.fromCharCode(65+idx)}.</b> ${o}`;
    div.onclick = ()=> choose(idx);
    optBox.appendChild(div);
  });

  $("#hint").classList.add("hidden");
  updateNav();
  updateStats();
}

/* ============================================================
   ANSWERING
============================================================ */
function choose(idx) {
  const q = App.questions[App.currentIndex];
  if (App.userAnswers[App.currentIndex] !== undefined) return;

  App.userAnswers[App.currentIndex] = idx;

  const opts = [...$("#options").children];
  opts.forEach((o,i)=>{
    o.classList.remove("option-correct","option-wrong","fade");
    if (i === q.ans) o.classList.add("option-correct");
    if (i === idx && idx !== q.ans) o.classList.add("option-wrong");
    if (i !== q.ans && i !== idx) o.classList.add("fade");
  });

  if (idx === q.ans) {
    App.correctCount++;
    App.streak++;
    App.score += 100 + (App.streak*10);
    App.coins += 10;
    play("#correctSound");
  } else {
    App.streak = 0;
    play("#incorrectSound");
  }

  updateStats();
  updateNav();
}

$("#prevBtn").onclick = ()=> loadQuestion(Math.max(0, App.currentIndex-1));
$("#nextBtn").onclick = ()=> loadQuestion(Math.min(App.questions.length-1, App.currentIndex+1));

$("#submitBtn").onclick = submitQuiz;

/* ============================================================
   SUBMIT RESULTS
============================================================ */
function submitQuiz() {
  const total = App.questions.length;
  const correct = App.correctCount;
  const percent = Math.round((correct/total)*100);

  $("#resultsSummary").innerHTML =
    `<div class="p-3 bg-blue-50 rounded-lg">
      <b>${correct}/${total}</b> correct ‚Äî <b>${percent}%</b> ‚Äî Score: <b>${App.score}</b>
    </div>`;

  const list = $("#resultsList");
  list.innerHTML = "";

  App.questions.forEach((q, i)=>{
    const chosen = App.userAnswers[i];

    const div = document.createElement("div");
    div.className = "p-3 border rounded-xl " + 
      (chosen === q.ans ? "bg-green-50" : "bg-red-50");

    div.innerHTML =
      `<b>${i+1}. ${q.question}</b><br>
       ${q.options.map((op,idx)=>
         `<div>${String.fromCharCode(65+idx)}. ${op} 
           ${idx===q.ans?"‚úîÔ∏è":""} 
           ${idx===chosen && chosen!==q.ans?"‚ùå":""}
         </div>`
       ).join("")}`;

    list.appendChild(div);
  });

  $("#quizCard").classList.add("hidden");
  $("#resultsCard").classList.remove("hidden");
}

/* ============================================================
   STATS
============================================================ */
function updateStats() {
  $("#currentQ").textContent = App.currentIndex+1;
  $("#score").textContent = App.score;
  $("#correctCount").textContent = App.correctCount;
  $("#streak").textContent = App.streak;
  $("#coins").textContent = App.coins;
  $("#coinsTop").textContent = App.coins;
  $("#count5050").textContent = App.powerups["5050"];
  $("#countHint").textContent = App.powerups["hint"];
  $("#countSkip").textContent = App.powerups["skip"];
}

/* ============================================================
   DROPDOWN UPDATE
============================================================ */
function updateDropdown(max) {
  const dr = $("#numQuestions");
  dr.innerHTML = "";
  for (let i = max; i >= 1; i--) {
    const o = document.createElement("option");
    o.textContent = i;
    o.value = i;
    dr.appendChild(o);
  }
}

/* ============================================================
   POWERUPS
============================================================ */
$("#pu5050").onclick = () => {
  if (App.powerups["5050"] <= 0) return toast("No 50:50 left");

  const q = App.questions[App.currentIndex];
  const opts = [...$("#options").children];
  const wrongs = opts.map((o,i)=>i).filter(i=>i!==q.ans);

  shuffle(wrongs);
  wrongs.slice(0,2).forEach(i=>{
    opts[i].classList.add("fade");
    opts[i].onclick = null;
  });

  App.powerups["5050"]--;
  play("#powerSound");
  updateStats();
};

$("#puHint").onclick = () => {
  if (App.powerups.hint <= 0) return toast("No hints left");
  $("#hint").textContent = "üí° " + App.questions[App.currentIndex].hint;
  $("#hint").classList.remove("hidden");
  App.powerups.hint--;
  updateStats();
};

$("#puSkip").onclick = ()=> {
  if (App.powerups.skip <= 0) return toast("No skip left");
  App.skipped.add(App.currentIndex);
  App.powerups.skip--;
  updateStats();
  loadQuestion(Math.min(App.currentIndex+1, App.questions.length-1));
};

/* ============================================================
   SAVING QUIZZES
============================================================ */
$("#saveQuizBtn").onclick = ()=>{
  if (!App.questions.length) return toast("No quiz to save");
  saveQuiz();
};

function saveQuiz() {
  const data = {
    id: Date.now(),
    questions: App.questions,
    created: new Date().toISOString()
  };

  let list = JSON.parse(localStorage.getItem("quizpro_saved") || "[]");
  list.push(data);
  localStorage.setItem("quizpro_saved", JSON.stringify(list));

  toast("Quiz saved");
  loadSaved();
}

$("#clearStorageBtn").onclick = ()=> {
  localStorage.removeItem("quizpro_saved");
  toast("Storage cleared");
  loadSaved();
};

function loadSaved() {
  const list = JSON.parse(localStorage.getItem("quizpro_saved") || "[]");
  const box = $("#quizList");
  box.innerHTML = "";
  if (!list.length) return box.innerHTML = `<div class="text-gray-500">No saved quizzes</div>`;

  list.forEach(q=>{
    const div = document.createElement("div");
    div.className = "p-3 border rounded-lg bg-gray-50";

    div.innerHTML =
      `<div class="flex justify-between items-center">
        <div>
          <b>Saved Quiz</b>
          <div class="text-xs text-gray-500">${new Date(q.created).toLocaleString()}</div>
        </div>
        <div class="flex gap-2">
          <button class="px-3 py-1 bg-blue-100 rounded load" data-id="${q.id}">Load</button>
          <button class="px-3 py-1 bg-red-100 rounded del" data-id="${q.id}">Delete</button>
        </div>
      </div>`;

    box.appendChild(div);
  });

  document.querySelectorAll(".load").forEach(b=>{
    b.onclick = ()=>{
      const list = JSON.parse(localStorage.getItem("quizpro_saved")||"[]");
      const found = list.find(x=>x.id==b.dataset.id);
      if (!found) return;
      App.questions = found.questions;
      App.userAnswers = {};
      loadQuestion(0);
      $("#quizCard").classList.remove("hidden");
      toast("Loaded");
    };
  });

  document.querySelectorAll(".del").forEach(b=>{
    b.onclick = ()=>{
      let list = JSON.parse(localStorage.getItem("quizpro_saved")||"[]");
      list = list.filter(x=>x.id!=b.dataset.id);
      localStorage.setItem("quizpro_saved", JSON.stringify(list));
      toast("Deleted");
      loadSaved();
    };
  });
}

loadSaved();
</script>

</body>
</html>